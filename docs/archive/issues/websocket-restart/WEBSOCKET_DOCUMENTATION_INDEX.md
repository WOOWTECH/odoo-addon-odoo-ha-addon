# WebSocket æ–‡æª”ç´¢å¼•

æœ¬ç´¢å¼•å¹«æ‚¨å¿«é€Ÿæ‰¾åˆ°æ‰€éœ€çš„æ–‡æª”å’Œä¿¡æ¯ã€‚

## æŒ‰ä½¿ç”¨å ´æ™¯åˆ†é¡

### æˆ‘éœ€è¦å¿«é€Ÿè§£æ±ºå•é¡Œ

ğŸ‘‰ é–±è®€ï¼š**WEBSOCKET_RESTART_SUMMARY.md**
- 5 åˆ†é˜å¿«é€Ÿè¨ºæ–·
- 4 ç¨®å¿«é€Ÿä¿®å¾©æ–¹æ¡ˆ
- å¸¸è¦‹å•é¡Œè§£ç­”

### æˆ‘éœ€è¦ç†è§£æ ¹æœ¬åŸå› 

ğŸ‘‰ é–±è®€ï¼š**websocket-restart-analysis.md**
- 4 å€‹æ ¹æœ¬åŸå› çš„è©³ç´°åˆ†æ
- ä»£ç¢¼æµç¨‹åœ–
- è¨ºæ–·å»ºè­°

### æˆ‘éœ€è¦å¯¦æ–½ä¿®å¾©æ–¹æ¡ˆ

ğŸ‘‰ é–±è®€ï¼š**websocket-restart-detailed-guide.md**
- å®Œæ•´çš„æŠ€è¡“åˆ†æ
- 4 å€‹éé€²å¼ä¿®å¾©æ–¹æ¡ˆï¼ˆç°¡å–®åˆ°è¤‡é›œï¼‰
- ä»£ç¢¼å±¤ç´šçš„è¨ºæ–·æŒ‡å—
- é©—è­‰å’Œæ¸¬è©¦æ¸…å–®

---

## æŒ‰çŸ¥è­˜æ·±åº¦åˆ†é¡

### å¿«é€Ÿå…¥é–€ï¼ˆæ–°æ‰‹ï¼‰

**æ™‚é–“ï¼š** 10 åˆ†é˜  
**é›£åº¦ï¼š** â­

1. **WEBSOCKET_RESTART_SUMMARY.md**
   - å•é¡Œç—‡ç‹€
   - æ ¹æœ¬åŸå› æ¦‚è¿°
   - å¿«é€Ÿè¨ºæ–·æ­¥é©Ÿ
   - å¸¸è¦‹å•é¡Œ

### ä¸­ç­‰æ·±åº¦ï¼ˆé–‹ç™¼è€…ï¼‰

**æ™‚é–“ï¼š** 30 åˆ†é˜  
**é›£åº¦ï¼š** â­â­

1. **websocket-restart-analysis.md**
   - è©³ç´°æ ¹æœ¬åŸå› åˆ†æ
   - ä»£ç¢¼æª¢æŸ¥é»
   - å®Œæ•´æµç¨‹åœ–

2. **websocket-restart-detailed-guide.md**ï¼ˆéƒ¨åˆ†å…§å®¹ï¼‰
   - ä»£ç¢¼å±¤ç´šè¨ºæ–·
   - ä¿®å¾©æ–¹æ¡ˆ 1-2

### æ·±åº¦å°ˆå®¶ï¼ˆæ¶æ§‹å¸«ï¼‰

**æ™‚é–“ï¼š** 2-3 å°æ™‚  
**é›£åº¦ï¼š** â­â­â­

1. **websocket-restart-detailed-guide.md**
   - æ‰€æœ‰ 4 å€‹ä¿®å¾©æ–¹æ¡ˆ
   - å®Œæ•´ä»£ç¢¼ç¤ºä¾‹
   - æ¸¬è©¦å’Œé©—è­‰æ–¹æ³•

2. **websocket-restart-analysis.md**
   - æ¶æ§‹ç´šåˆ¥çš„åˆ†æ
   - é•·æœŸæ”¹é€²å»ºè­°

---

## æŒ‰æ–‡ä»¶å…§å®¹é€ŸæŸ¥

### websocket-restart-analysis.md (9.3K)

| ç« ç¯€ | å…§å®¹ | ç”¨é€” |
|------|------|------|
| æ ¸å¿ƒå•é¡Œ | ç—‡ç‹€å’Œå½±éŸ¿ | ç¢ºèªæ˜¯å¦é‡åˆ°æ­¤å•é¡Œ |
| æ ¹æœ¬åŸå›  1-4 | è©³ç´°åˆ†æ | ç†è§£å„å€‹åŸå›  |
| ç”¨æˆ·æƒ…æ³ | æœ€å¯èƒ½çš„åŸå›  | å¿«é€Ÿè¨ºæ–·æ–¹å‘ |
| è¨ºæ–·å»ºè­° | æª¢æŸ¥æ­¥é©Ÿ | é©—è­‰å•é¡ŒåŸå›  |
| ä¿®å¾©æ–¹æ¡ˆ | é«˜å±¤ç´šå»ºè­° | é¸æ“‡ä¿®å¾©æ–¹å‘ |

### websocket-restart-detailed-guide.md (21K)

| éƒ¨åˆ† | å…§å®¹ | ç”¨é€” |
|------|------|------|
| ç¬¬ä¸€éƒ¨åˆ† | 4 å€‹æ ¹æœ¬åŸå› è©³è§£ | æ·±å…¥ç†è§£ |
| ç¬¬äºŒéƒ¨åˆ† | ä»£ç¢¼è¨ºæ–·å·¥å…· | å¯¦æ–½è¨ºæ–· |
| ç¬¬ä¸‰éƒ¨åˆ† | 4 å€‹ä¿®å¾©æ–¹æ¡ˆ | é¸æ“‡å’Œå¯¦æ–½ä¿®å¾© |
| ç¬¬å››éƒ¨åˆ† | é©—è­‰æ¸…å–® | ç¢ºèªä¿®å¾©æˆåŠŸ |

### WEBSOCKET_RESTART_SUMMARY.md (4.2K)

| ç« ç¯€ | å…§å®¹ | ç”¨é€” |
|------|------|------|
| å•é¡Œç—‡ç‹€ | è­˜åˆ¥å•é¡Œ | ç¢ºèªé‡åˆ°åŒä¸€å•é¡Œ |
| æ ¹æœ¬åŸå›  | åŸå› åˆ—è¡¨ | å¿«é€ŸæŸ¥é–± |
| å¿«é€Ÿè¨ºæ–· | 3 å€‹æ­¥é©Ÿ | 5 åˆ†é˜è¨ºæ–· |
| å¿«é€Ÿä¿®å¾© | 4 å€‹æ–¹æ¡ˆ | å¿«é€Ÿè§£æ±º |
| å¸¸è¦‹å•é¡Œ | Q&A | å°‹æ‰¾ç­”æ¡ˆ |

---

## è¨ºæ–·æ±ºç­–æ¨¹

```
WebSocket ä¸å·¥ä½œï¼Ÿ
â”‚
â”œâ”€â†’ é‡å•Ÿå¾Œè‡ªå‹•é€£æ¥å¤±æ•—ï¼Ÿ
â”‚   â””â”€â†’ WEBSOCKET_RESTART_SUMMARY.mdï¼ˆå¿«é€Ÿåƒè€ƒï¼‰
â”‚
â”œâ”€â†’ æƒ³äº†è§£ç‚ºä»€éº¼ï¼Ÿ
â”‚   â””â”€â†’ websocket-restart-analysis.mdï¼ˆåŸå› åˆ†æï¼‰
â”‚
â”œâ”€â†’ æƒ³ä¿®å¾©å®ƒï¼Ÿ
â”‚   â””â”€â†’ websocket-restart-detailed-guide.mdï¼ˆä¿®å¾©æ–¹æ¡ˆï¼‰
â”‚
â””â”€â†’ æƒ³å®Œå…¨ç†è§£æ¶æ§‹ï¼Ÿ
    â””â”€â†’ å…¨éƒ¨ä¸‰ä»½æ–‡æª”ï¼ˆå®Œæ•´ç†è§£ï¼‰
```

---

## æŒ‰ä¿®å¾©é›£åº¦å’Œæ™‚é–“åˆ†é¡

### 5 åˆ†é˜ï¼ˆæª¢æŸ¥é…ç½®ï¼‰

**æ–‡ä»¶ï¼š** WEBSOCKET_RESTART_SUMMARY.md  
**æ­¥é©Ÿï¼š**
1. é€²å…¥ Home Assistant å¯¦ä¾‹è¨­ç½®
2. ç¢ºä¿ API URL å’Œ Token å·²å¡«å¯«
3. é‡å•Ÿ Odoo

### 15 åˆ†é˜ï¼ˆæ”¹é€²æ—¥èªŒè¨ºæ–·ï¼‰

**æ–‡ä»¶ï¼š** websocket-restart-detailed-guide.md > æ–¹æ¡ˆ 1  
**æ­¥é©Ÿï¼š**
1. ä¿®æ”¹ `websocket_thread_manager.py`
2. æ·»åŠ è©³ç´°æ—¥èªŒ
3. é‡å•Ÿä¸¦è§€å¯Ÿæ—¥èªŒ

### 30 åˆ†é˜ï¼ˆé…ç½®ç›£è¦–æ©Ÿåˆ¶ï¼‰

**æ–‡ä»¶ï¼š** websocket-restart-detailed-guide.md > æ–¹æ¡ˆ 2  
**æ­¥é©Ÿï¼š**
1. ä¿®æ”¹ `ha_instance.py` çš„ `write()` æ–¹æ³•
2. æ·»åŠ é…ç½®è®Šæ›´æª¢æ¸¬
3. è‡ªå‹•é‡å•Ÿ WebSocket

### 45 åˆ†é˜ï¼ˆGraceful Shutdownï¼‰

**æ–‡ä»¶ï¼š** websocket-restart-detailed-guide.md > æ–¹æ¡ˆ 3  
**æ­¥é©Ÿï¼š**
1. ä¿®æ”¹ `websocket_thread_manager.py`
2. æ·»åŠ  `atexit` å’Œ `signal` è™•ç†
3. æ”¹ç‚ºé daemon åŸ·è¡Œç·’

### 2-3 å°æ™‚ï¼ˆå®Œæ•´è‡ªå‹•ç›£è¦–ï¼‰

**æ–‡ä»¶ï¼š** websocket-restart-detailed-guide.md > æ–¹æ¡ˆ 4  
**æ­¥é©Ÿï¼š**
1. å‰µå»º `websocket_monitor_service.py`
2. å¯¦ç¾ç›£è¦–è¿´åœˆ
3. è‡ªå‹•æª¢æ¸¬å’Œæ¢å¾©

---

## å¿«é€Ÿå‘½ä»¤åƒè€ƒ

### æª¢æŸ¥é…ç½®

```bash
# æª¢æŸ¥æ˜¯å¦æœ‰é…ç½®ä¸å®Œæ•´çš„è­¦å‘Š
docker compose logs web | grep -i "configuration incomplete"

# æŸ¥çœ‹æ‰€æœ‰ WebSocket ç›¸é—œæ—¥èªŒ
docker compose logs web | grep -i websocket
```

### æª¢æŸ¥å¯¦ä¾‹ç‹€æ…‹

```bash
# é€²å…¥ Odoo shell
docker compose exec web odoo shell -d odoo

# æª¢æŸ¥å¯¦ä¾‹é…ç½®
from odoo import api, SUPERUSER_ID
env = api.Environment(cr, SUPERUSER_ID, {})
instances = env['ha.instance'].sudo().search([])
for inst in instances:
    print(f"{inst.name}: active={inst.active}, url={bool(inst.api_url)}, token={bool(inst.api_token)}")
```

### æ‰‹å‹•é‡å•Ÿ WebSocket

```bash
# æ–¹æ³• 1ï¼šé€šé UI
# é€²å…¥å¯¦ä¾‹ > é»æ“Šã€ŒRestart WebSocketã€

# æ–¹æ³• 2ï¼šé€šé Shell
docker compose exec web odoo shell -d odoo
from odoo.addons.odoo_ha_addon.models.common.websocket_thread_manager import restart_websocket_service
restart_websocket_service(env, instance_id=1, force=True)
```

---

## ç›¸é—œæ–‡ä»¶ä½ç½®

| æ–‡ä»¶ | ä½ç½® | èªªæ˜ |
|------|------|------|
| hooks.py | models/ | post_load_hook å®šç¾© |
| websocket_thread_manager.py | models/common/ | WebSocket åŸ·è¡Œç·’ç®¡ç† |
| hass_websocket_service.py | models/common/ | WebSocket æœå‹™å¯¦ç¾ |
| ha_instance.py | models/ | HA å¯¦ä¾‹æ¨¡å‹ |
| websocket_client.py | models/common/ | WebSocket å®¢æˆ¶ç«¯ |

---

## æ›´æ–°æ—¥èªŒ

| ç‰ˆæœ¬ | æ—¥æœŸ | è®Šæ›´ |
|------|------|------|
| 1.0 | 2024-11-08 | åˆå§‹ç‰ˆæœ¬ |

---

## éœ€è¦å¹«åŠ©ï¼Ÿ

1. **ç„¡æ³•è¨ºæ–·ï¼Ÿ** â†’ æŸ¥çœ‹ WEBSOCKET_RESTART_SUMMARY.md çš„ã€Œå¸¸è¦‹å•é¡Œã€
2. **è¨ºæ–·æ­¥é©Ÿæœ‰å•é¡Œï¼Ÿ** â†’ åƒè€ƒ websocket-restart-detailed-guide.md çš„ã€Œè¨ºæ–·å·¥å…·ã€
3. **å¯¦æ–½ä¿®å¾©æ™‚æœ‰å•é¡Œï¼Ÿ** â†’ æŸ¥çœ‹ç›¸æ‡‰ä¿®å¾©æ–¹æ¡ˆçš„ã€Œä»£ç¢¼ç¤ºä¾‹ã€

