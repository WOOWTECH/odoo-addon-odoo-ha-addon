# PostgreSQL åºåˆ—åŒ–è¡çªå•é¡Œè§£æ±ºæ–¹æ¡ˆ

**å•é¡Œæ—¥æœŸ**: 2025-10-22
**å½±éŸ¿ç¯„åœ**: åˆ†å€å„€è¡¨æ¿ (Area Dashboard)
**åš´é‡ç¨‹åº¦**: ğŸ”´ Critical - åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
**ç‹€æ…‹**: âœ… å·²è§£æ±º

---

## ğŸ“‹ ç›®éŒ„

- [å‰ç½®çŸ¥è­˜](#å‰ç½®çŸ¥è­˜)
  - [é©ç”¨å°è±¡](#é©ç”¨å°è±¡)
  - [éœ€è¦äº†è§£çš„èƒŒæ™¯](#éœ€è¦äº†è§£çš„èƒŒæ™¯)
  - [é–±è®€é †åºå»ºè­°](#é–±è®€é †åºå»ºè­°)
- [å•é¡Œç¾è±¡](#å•é¡Œç¾è±¡)
- [éŒ¯èª¤è¨Šæ¯](#éŒ¯èª¤è¨Šæ¯)
- [æ ¹æœ¬åŸå› åˆ†æ](#æ ¹æœ¬åŸå› åˆ†æ)
  - [å•é¡Œæ¶æ§‹](#å•é¡Œæ¶æ§‹)
  - [è¡çªç™¼ç”Ÿæ™‚åº](#è¡çªç™¼ç”Ÿæ™‚åº)
  - [ç‚ºä½•æœƒç™¼ç”Ÿï¼Ÿ](#ç‚ºä½•æœƒç™¼ç”Ÿ)
  - [é€£é–éŒ¯èª¤ï¼šTransaction is Aborted](#é€£é–éŒ¯èª¤transaction-is-aborted)
- [æŠ€è¡“æ¦‚å¿µ](#æŠ€è¡“æ¦‚å¿µ)
- [è§£æ±ºæ–¹æ¡ˆ](#è§£æ±ºæ–¹æ¡ˆ)
- [å¯¦æ–½ç´°ç¯€](#å¯¦æ–½ç´°ç¯€)
- [æ¸¬è©¦é©—è­‰](#æ¸¬è©¦é©—è­‰)
- [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)
- [å¿«é€Ÿè¨ºæ–·æŒ‡å—](#å¿«é€Ÿè¨ºæ–·æŒ‡å—)
  - [å¦‚ä½•åˆ¤æ–·æ˜¯å¦é‡åˆ°æ­¤å•é¡Œï¼Ÿ](#å¦‚ä½•åˆ¤æ–·æ˜¯å¦é‡åˆ°æ­¤å•é¡Œ)
  - [å¸¸è¦‹å•é¡Œ (FAQ)](#å¸¸è¦‹å•é¡Œ-faq)
  - [ç·Šæ€¥è™•ç†æµç¨‹](#ç·Šæ€¥è™•ç†æµç¨‹)
- [å½±éŸ¿è©•ä¼°](#å½±éŸ¿è©•ä¼°)
- [å¾ŒçºŒæ”¹é€²æ–¹å‘](#å¾ŒçºŒæ”¹é€²æ–¹å‘)
- [åƒè€ƒè³‡æ–™](#åƒè€ƒè³‡æ–™)
- [è®Šæ›´è¨˜éŒ„](#è®Šæ›´è¨˜éŒ„)
- [é™„éŒ„](#é™„éŒ„)

---

## ğŸ“š å‰ç½®çŸ¥è­˜

### é©ç”¨å°è±¡

æœ¬æ–‡ä»¶é©åˆä»¥ä¸‹è®€è€…ï¼š

âœ… **é©åˆé–±è®€**ï¼š
- Odoo / Python å¾Œç«¯å·¥ç¨‹å¸«
- é‡åˆ° "transaction is aborted" æˆ– "SerializationFailure" éŒ¯èª¤çš„é–‹ç™¼è€…
- éœ€è¦ç†è§£è³‡æ–™åº«ä¸¦ç™¼å•é¡Œçš„åœ˜éšŠæˆå“¡
- è² è²¬ç³»çµ±ç¶­è­·å’Œ troubleshooting çš„ DevOps å·¥ç¨‹å¸«

âš ï¸ **éœ€è¦è£œå……çŸ¥è­˜**ï¼š
- è³‡æ–™åº«æ–°æ‰‹ï¼šå»ºè­°å…ˆé–±è®€ PostgreSQL åŸºç¤æ•™å­¸
- ä¸ç†Ÿæ‚‰ Pythonï¼šå»ºè­°å…ˆäº†è§£åŸºæœ¬èªæ³•å’Œç•°å¸¸è™•ç†
- æ²’æœ‰ Odoo ç¶“é©—ï¼šå»ºè­°å…ˆäº†è§£ Odoo ORM åŸºæœ¬æ¦‚å¿µ

### éœ€è¦äº†è§£çš„èƒŒæ™¯

#### å¿…å‚™çŸ¥è­˜ (Must Have)

1. **PostgreSQL åŸºç¤**ï¼š
   - äº†è§£ä»€éº¼æ˜¯äº¤æ˜“ (Transaction)
   - çŸ¥é“ COMMIT å’Œ ROLLBACK çš„ä½œç”¨
   - ç†è§£åŸºæœ¬çš„ SQL æ“ä½œ (SELECT, UPDATE, INSERT)

2. **Python åŸºç¤**ï¼š
   - ç†è§£ try-except ç•°å¸¸è™•ç†
   - ç†Ÿæ‚‰åŸºæœ¬çš„å‡½æ•¸å®šç¾©å’Œèª¿ç”¨
   - äº†è§£ with èªå¥çš„ç”¨æ³•

3. **Odoo åŸºæœ¬æ¦‚å¿µ**ï¼š
   - çŸ¥é“ Odoo æ˜¯ä»€éº¼ï¼ˆERP ç³»çµ±ï¼‰
   - äº†è§£ Modelã€Controller çš„æ¦‚å¿µ
   - ç†Ÿæ‚‰ `self.env['model_name']` èªæ³•

#### å»ºè­°çŸ¥è­˜ (Nice to Have)

1. **è³‡æ–™åº«é€²éš**ï¼š
   - äº¤æ˜“éš”é›¢ç­‰ç´š (Transaction Isolation Levels)
   - é–æ©Ÿåˆ¶ (Locking)
   - ACID ç‰¹æ€§

2. **ä¸¦ç™¼è™•ç†**ï¼š
   - ä»€éº¼æ˜¯ Race Condition
   - æ¨‚è§€é– vs æ‚²è§€é–
   - é‡è©¦æ©Ÿåˆ¶ (Retry Pattern)

3. **ç³»çµ±è¨­è¨ˆ**ï¼š
   - å¾®æœå‹™æ¶æ§‹
   - äº‹ä»¶é©…å‹•è¨­è¨ˆ
   - å¿«å–ç­–ç•¥

#### é—œéµè¡“èªé è¦½

å¦‚æœä»¥ä¸‹è¡“èªä½ ä¸ç†Ÿæ‚‰ï¼Œå»ºè­°å…ˆè·³åˆ°ã€Œ[é™„éŒ„ï¼šè¡“èªè¡¨](#é™„éŒ„è¡“èªè¡¨)ã€ï¼š

- **SerializationFailure**: åºåˆ—åŒ–å¤±æ•—éŒ¯èª¤
- **REPEATABLE READ**: å¯é‡è¤‡è®€éš”é›¢ç­‰ç´š
- **Savepoint**: äº¤æ˜“å…§çš„ä¿å­˜é»
- **WebSocket**: å…¨é›™å·¥é€šè¨Šå”å®š
- **Concurrent Update**: ä¸¦ç™¼æ›´æ–°

### é–±è®€é †åºå»ºè­°

#### ğŸš¨ é‡åˆ°ç·Šæ€¥å•é¡Œï¼ˆæ­£åœ¨ç™¼ç”ŸéŒ¯èª¤ï¼‰

```
1. [å¿«é€Ÿè¨ºæ–·æŒ‡å—] â†’ ç¢ºèªå•é¡Œ
2. [ç·Šæ€¥è™•ç†æµç¨‹] â†’ è‡¨æ™‚ç·©è§£
3. [è§£æ±ºæ–¹æ¡ˆ] â†’ å¯¦æ–½ä¿®å¾©
4. [æ¸¬è©¦é©—è­‰] â†’ é©—è­‰ä¿®å¾©æ•ˆæœ
```

#### ğŸ“– å­¸ç¿’æŠ€è¡“åŸç†

```
1. [å•é¡Œç¾è±¡] â†’ äº†è§£å•é¡Œè¡¨ç¾
2. [æ ¹æœ¬åŸå› åˆ†æ] â†’ ç†è§£ç‚ºä»€éº¼æœƒç™¼ç”Ÿ
3. [æŠ€è¡“æ¦‚å¿µ] â†’ å­¸ç¿’ç›¸é—œçŸ¥è­˜
4. [è§£æ±ºæ–¹æ¡ˆ] â†’ æŒæ¡ä¿®å¾©æ–¹æ³•
5. [æœ€ä½³å¯¦è¸] â†’ é¿å…æœªä¾†å•é¡Œ
```

#### ğŸ”§ å¯¦æ–½ä¿®å¾©

```
1. [å¿«é€Ÿè¨ºæ–·æŒ‡å—] â†’ ç¢ºèªæ˜¯æ­¤å•é¡Œ
2. [æ ¹æœ¬åŸå› åˆ†æ] â†’ ç†è§£å•é¡Œæœ¬è³ª
3. [è§£æ±ºæ–¹æ¡ˆ] â†’ äº†è§£ä¿®å¾©ç­–ç•¥
4. [å¯¦æ–½ç´°ç¯€] â†’ è¤‡è£½è²¼ä¸Šç¨‹å¼ç¢¼
5. [æ¸¬è©¦é©—è­‰] â†’ ç¢ºèªä¿®å¾©æˆåŠŸ
```

#### ğŸ“Š ç®¡ç†æ±ºç­–

```
1. [å•é¡Œç¾è±¡] â†’ äº†è§£å½±éŸ¿ç¯„åœ
2. [å½±éŸ¿è©•ä¼°] â†’ è©•ä¼°æ¥­å‹™å½±éŸ¿
3. [è§£æ±ºæ–¹æ¡ˆ] â†’ äº†è§£ä¿®å¾©æˆæœ¬
4. [å¾ŒçºŒæ”¹é€²æ–¹å‘] â†’ è¦åŠƒé•·æœŸå„ªåŒ–
```

### é æœŸæ”¶ç©«

é–±è®€å®Œæœ¬æ–‡å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

âœ… **è¨ºæ–·èƒ½åŠ›**ï¼š
- å¿«é€Ÿè­˜åˆ¥æ˜¯å¦ç‚ºåºåˆ—åŒ–è¡çªå•é¡Œ
- å¾ log ä¸­æ‰¾å‡ºéŒ¯èª¤çš„æ ¹æœ¬åŸå› 
- å€åˆ† SerializationFailure å’Œ Transaction is Aborted

âœ… **ä¿®å¾©èƒ½åŠ›**ï¼š
- å¯¦ä½œ Controller å±¤çš„é‡è©¦æ©Ÿåˆ¶
- ä½¿ç”¨ Savepoint éš”é›¢æ‰¹æ¬¡æ“ä½œ
- æ­£ç¢ºè™•ç†äº¤æ˜“ç•°å¸¸

âœ… **é é˜²èƒ½åŠ›**ï¼š
- è¨­è¨ˆé¿å…ä¸¦ç™¼è¡çªçš„æ¶æ§‹
- äº†è§£ä½•æ™‚ä½¿ç”¨ä½•ç¨®äº¤æ˜“éš”é›¢ç­‰ç´š
- çŸ¥é“ Odoo çš„äº¤æ˜“ç®¡ç†é™åˆ¶

âœ… **æºé€šèƒ½åŠ›**ï¼š
- å‘éæŠ€è¡“äººå“¡è§£é‡‹å•é¡Œ
- æ’°å¯«æ¸…æ™°çš„ bug report
- èˆ‡åœ˜éšŠè¨è«–è§£æ±ºæ–¹æ¡ˆ

---

## ğŸ” å•é¡Œç¾è±¡

### ç”¨æˆ¶è¡Œç‚º
ç”¨æˆ¶è¨ªå•ã€Œåˆ†å€å„€è¡¨æ¿ã€é é¢æ™‚ï¼Œé é¢ç„¡æ³•è¼‰å…¥ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ã€‚

### å‰ç«¯è¡¨ç¾
- âŒ é é¢è¼‰å…¥å¤±æ•—
- âŒ API è«‹æ±‚è¿”å› `success: false`
- âŒ éŒ¯èª¤è¨Šæ¯ï¼š`current transaction is aborted, commands ignored until end of transaction block`

---

## ğŸ“ éŒ¯èª¤è¨Šæ¯

### Log æ™‚é–“è»¸

```
14:47:59,822 - âœ“ sync_entity_states_from_ha completed successfully
14:47:59,828 - âŒ ERROR: could not serialize access due to concurrent update
                åœ¨ commit() åŸ·è¡Œæ™‚ç™¼ç”Ÿ
14:47:59,829 - âŒ Failed to get areas
14:47:59,194 - âŒ ERROR: current transaction is aborted, commands ignored until
                end of transaction block
```

### å®Œæ•´éŒ¯èª¤å †ç–Š

```python
psycopg2.errors.SerializationFailure: could not serialize access due to concurrent update

Traceback:
  File "controllers/controllers.py", line 206, in get_areas
    request.env.cr.commit()
  File "odoo/sql_db.py", line 479, in commit
    self.flush()
  File "odoo/api.py", line 1022, in flush
    env_to_flush.flush_all()
  ...
```

---

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### å•é¡Œæ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Odoo HTTP è«‹æ±‚                             â”‚
â”‚  User: è¨ªå•åˆ†å€å„€è¡¨æ¿                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Controller: get_areas()                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. sync_areas_from_ha()                                â”‚   â”‚
â”‚  â”‚     â””â”€ UPDATE ha_area (6 records)                       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  2. sync_entity_states_from_ha()                        â”‚   â”‚
â”‚  â”‚     â””â”€ batch_update_entities()                          â”‚   â”‚
â”‚  â”‚        â””â”€ UPDATE ha_entity (70 records) âš¡              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  3. _sync_entity_registry_relations()                   â”‚   â”‚
â”‚  â”‚     â””â”€ WebSocket API call                               â”‚   â”‚
â”‚  â”‚        â””â”€ INSERT/DELETE ha.ws.request.queue âš¡          â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  4. commit() âŒ SerializationFailure                    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  5. search([]) âŒ Transaction aborted                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              âš¡
                       ä¸¦ç™¼è¡çªé»
                              âš¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         WebSocket èƒŒæ™¯æœå‹™ (ç¨ç«‹åŸ·è¡Œç·’)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æŒçºŒæ¥æ”¶ Home Assistant state_changed äº‹ä»¶             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  æ¯ç§’æ•¸æ¬¡ï¼š                                              â”‚   â”‚
â”‚  â”‚  UPDATE ha_entity                                       â”‚   â”‚
â”‚  â”‚  WHERE entity_id = 'sensor.xxx' âš¡                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡çªç™¼ç”Ÿæ™‚åº

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ¶è«‹æ±‚
    participant Controller as get_areas()
    participant DB as PostgreSQL
    participant WS as WebSocket æœå‹™

    User->>Controller: è¨ªå•åˆ†å€å„€è¡¨æ¿
    Controller->>DB: BEGIN TRANSACTION
    Controller->>DB: UPDATE ha_entity (70 records)

    Note over WS: èƒŒæ™¯åŸ·è¡Œä¸­...
    WS->>DB: UPDATE ha_entity WHERE id=42
    Note over DB: é–å®š record #42

    Controller->>DB: UPDATE ha_entity WHERE id=42
    Note over DB: åµæ¸¬åˆ°åºåˆ—åŒ–è¡çªï¼

    DB-->>Controller: SerializationFailure
    Controller->>DB: COMMIT
    Note over DB: Transaction ABORTED

    Controller->>DB: SELECT * FROM ha_area
    DB-->>Controller: âŒ current transaction is aborted

    Controller-->>User: Error: 500
```

### ç‚ºä½•æœƒç™¼ç”Ÿï¼Ÿ

#### 1. **ä¸¦ç™¼å¯«å…¥ç›¸åŒè¨˜éŒ„**
```sql
-- HTTP è«‹æ±‚äº¤æ˜“
UPDATE ha_entity
SET last_changed = '2025-10-22 14:47:58'
WHERE id = 42;

-- WebSocket èƒŒæ™¯æœå‹™ï¼ˆåŒæ™‚ç™¼ç”Ÿï¼‰
UPDATE ha_entity
SET entity_state = '23.5'
WHERE id = 42;
```

#### 2. **Odoo çš„äº¤æ˜“éš”é›¢ç­‰ç´š**

**é‡è¦**ï¼šOdoo ä½¿ç”¨ **REPEATABLE READ** éš”é›¢ç­‰ç´šï¼Œè€Œé PostgreSQL é è¨­çš„ READ COMMITTEDï¼

```python
# Odoo åœ¨ sql_db.py ä¸­è¨­å®š
SET default_transaction_isolation TO 'REPEATABLE READ'
```

**ç‚ºä»€éº¼ Odoo ä½¿ç”¨ REPEATABLE READï¼Ÿ**
- Odoo ORM è¨­è¨ˆä¾è³´ REPEATABLE READ çš„ä¿è­‰
- ç¢ºä¿åŒä¸€äº¤æ˜“å…§å¤šæ¬¡è®€å–çœ‹åˆ°ä¸€è‡´çš„è³‡æ–™
- ç°¡åŒ–æ¥­å‹™é‚è¼¯é–‹ç™¼ï¼ˆé–‹ç™¼è€…ç„¡éœ€è™•ç†äº¤æ˜“è¡çªï¼‰

**ä»£åƒ¹**ï¼š
- âŒ åŒæ™‚æ›´æ–°ç›¸åŒè¨˜éŒ„æœƒç”¢ç”Ÿ SerializationFailure
- âš ï¸ å¿…é ˆå¯¦ä½œé‡è©¦æ©Ÿåˆ¶è™•ç†è¡çª
- ğŸ“Š ä¸¦ç™¼å¯«å…¥æ€§èƒ½ä½æ–¼ READ COMMITTED

**åƒè€ƒ**ï¼š
- Odoo è«–å£‡ï¼š[ç‚ºä»€éº¼ Odoo ä¸èƒ½æ”¹ç”¨ READ COMMITTEDï¼Ÿ](https://www.odoo.com/forum/help-1/repeated-serialization-errorscould-not-serialize-access-due-to-concurrent-update-in-postgres-database-148511)
- PostgreSQL æ–‡ä»¶ï¼š[Transaction Isolation Levels](https://www.postgresql.org/docs/current/transaction-iso.html)

#### 3. **äº¤æ˜“æœªæ­£ç¢ºè™•ç†**
```python
# ä¿®å¾©å‰
try:
    sync_entities()  # æ›´æ–° 70 å€‹ entities
    commit()         # âŒ å¦‚æœå¤±æ•—ï¼Œäº¤æ˜“è¢«ä¸­æ­¢
    search([])       # âŒ Transaction abortedï¼
```

### ğŸ”— é€£é–éŒ¯èª¤ï¼šTransaction is Aborted

#### éŒ¯èª¤æ¼”é€²éç¨‹

é€™æ˜¯ä¸€å€‹**å…©éšæ®µéŒ¯èª¤**ï¼Œç¬¬äºŒå€‹éŒ¯èª¤æ˜¯ç¬¬ä¸€å€‹éŒ¯èª¤çš„é€£é–åæ‡‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éšæ®µ 1: åºåˆ—åŒ–è¡çª (SerializationFailure)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš¡ åŸå› ï¼š                                                    â”‚
â”‚     - HTTP è«‹æ±‚æ›´æ–° ha_entity (70 records)                   â”‚
â”‚     - WebSocket æœå‹™åŒæ™‚æ›´æ–°åŒä¸€ç­† entity                     â”‚
â”‚     - PostgreSQL åµæ¸¬åˆ°ä¸¦ç™¼å¯«å…¥è¡çª                          â”‚
â”‚                                                              â”‚
â”‚  âŒ çµæœï¼š                                                    â”‚
â”‚     psycopg2.errors.SerializationFailure:                    â”‚
â”‚     could not serialize access due to concurrent update      â”‚
â”‚                                                              â”‚
â”‚  ğŸ”’ äº¤æ˜“ç‹€æ…‹ï¼š                                                â”‚
â”‚     PostgreSQL æ¨™è¨˜äº¤æ˜“ç‚º ABORTED                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éšæ®µ 2: äº¤æ˜“å·²ä¸­æ­¢ (Transaction is Aborted)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš¡ åŸå› ï¼š                                                    â”‚
â”‚     - ç¨‹å¼ç¢¼æ²’æœ‰æ•ç² SerializationFailure                    â”‚
â”‚     - ç¹¼çºŒåŸ·è¡Œå¾ŒçºŒçš„ SQL æŸ¥è©¢                                â”‚
â”‚     - PostgreSQL æ‹’çµ•åŸ·è¡Œä»»ä½•å‘½ä»¤                            â”‚
â”‚                                                              â”‚
â”‚  âŒ çµæœï¼š                                                    â”‚
â”‚     psycopg2.errors.InFailedSqlTransaction:                  â”‚
â”‚     current transaction is aborted, commands ignored         â”‚
â”‚     until end of transaction block                           â”‚
â”‚                                                              â”‚
â”‚  ğŸ’¥ å½±éŸ¿ï¼š                                                    â”‚
â”‚     - åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨                                         â”‚
â”‚     - ç”¨æˆ¶çœ‹åˆ° 500 éŒ¯èª¤                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç‚ºä»€éº¼æœƒæœ‰ "Transaction is Aborted"ï¼Ÿ

**PostgreSQL äº¤æ˜“ç‹€æ…‹æ©Ÿ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Transaction Lifecycle                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  BEGIN TRANSACTION
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   ACTIVE    â”‚ â† æ­£å¸¸åŸ·è¡Œ SQL å‘½ä»¤
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                  â”‚                  â”‚
         â–¼                  â–¼                  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  COMMITTED  â”‚    â”‚   ABORTED   â”‚    â”‚ ROLLED BACK â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         âœ“                  âŒ                  â†©ï¸
                            â”‚
                            â”‚ ä»»ä½• SQL æŸ¥è©¢
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  InFailedSql     â”‚
                   â”‚  Transaction     â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—œéµæ©Ÿåˆ¶**ï¼š

1. **SerializationFailure ç™¼ç”Ÿæ™‚**ï¼š
   ```python
   # PostgreSQL å…§éƒ¨
   if concurrent_update_detected:
       mark_transaction_as_aborted()
       raise SerializationFailure()
   ```

2. **äº¤æ˜“è¢«æ¨™è¨˜ç‚º ABORTED**ï¼š
   ```sql
   -- PostgreSQL ç‹€æ…‹
   SELECT current_setting('transaction_isolation');
   -- read committed

   SELECT pg_backend_pid();
   -- 12345 (æ­¤ session)

   -- äº¤æ˜“ç‹€æ…‹ï¼šABORTED âŒ
   ```

3. **å¾ŒçºŒä»»ä½• SQL éƒ½æœƒè¢«æ‹’çµ•**ï¼š
   ```python
   # ç¨‹å¼ç¢¼å˜—è©¦åŸ·è¡Œ
   cursor.execute("SELECT * FROM ha_area")

   # PostgreSQL æ‹’çµ•
   # ERROR: current transaction is aborted,
   #        commands ignored until end of transaction block
   ```

#### å¯¦éš› Log å°ç…§

```python
# å®Œæ•´éŒ¯èª¤æµç¨‹
14:47:59,822 - INFO  - Batch update summary: 0 created, 70 updated, 0 errors
                       âœ“ æ‰¹æ¬¡æ›´æ–°å®Œæˆ

14:47:59,828 - ERROR - bad query: UPDATE ha_entity ...
                       âŒ éšæ®µ 1ï¼šåºåˆ—åŒ–è¡çª
                       ERROR: could not serialize access due to concurrent update

14:47:59,829 - ERROR - Failed to get areas: could not serialize access...
                       âš ï¸ æ•ç²åˆ°éŒ¯èª¤ï¼Œä½†äº¤æ˜“å·² ABORTED

14:47:59,194 - ERROR - bad query: SELECT "ha_area"."id" FROM "ha_area"...
                       âŒ éšæ®µ 2ï¼šäº¤æ˜“å·²ä¸­æ­¢
                       ERROR: current transaction is aborted,
                              commands ignored until end of transaction block

14:47:59,195 - ERROR - Failed to get areas: current transaction is aborted...
                       ğŸ’¥ æœ€çµ‚éŒ¯èª¤è¿”å›çµ¦ç”¨æˆ¶
```

#### ç¨‹å¼ç¢¼å±¤é¢çš„å•é¡Œ

**ä¿®å¾©å‰çš„éŒ¯èª¤æµç¨‹**ï¼š

```python
# controllers.py (ä¿®å¾©å‰)
def get_areas(self):
    try:
        # æ­¥é©Ÿ 1: åŒæ­¥ areas
        sync_areas_from_ha()

        # æ­¥é©Ÿ 2: åŒæ­¥ entities
        sync_entity_states_from_ha()  # å…§éƒ¨æœ‰ 70 å€‹ UPDATE

        # âš¡ é€™è£¡ç™¼ç”Ÿ SerializationFailure
        # ä½†æ²’æœ‰è¢«æ•ç²ï¼Œæˆ–è€…è¢« catch ä½†æ²’æœ‰ rollback

        # æ­¥é©Ÿ 3: å˜—è©¦æŸ¥è©¢
        areas = search([])  # âŒ Transaction is ABORTED
        #                      PostgreSQL æ‹’çµ•åŸ·è¡Œ

        return {'areas': areas}

    except Exception as e:
        # âŒ é€™è£¡æ•ç²çš„æ˜¯ "transaction is aborted" éŒ¯èª¤
        # è€Œä¸æ˜¯æ ¹æœ¬åŸå› çš„ SerializationFailure
        return {'error': str(e)}
```

**å•é¡Œåˆ†æ**ï¼š

1. **æ²’æœ‰åœ¨æ­£ç¢ºçš„åœ°æ–¹è™•ç†éŒ¯èª¤**ï¼š
   ```python
   sync_entity_states_from_ha()  # SerializationFailure åœ¨é€™è£¡ç™¼ç”Ÿ
   # ä½†æ²’æœ‰ try-except åŒ…ä½é€™å€‹ç‰¹å®šçš„ commit()
   ```

2. **æ²’æœ‰ rollback å°±ç¹¼çºŒåŸ·è¡Œ**ï¼š
   ```python
   # commit() å¤±æ•—å¾Œï¼Œäº¤æ˜“å·² ABORTED
   # ä½†ç¨‹å¼ç¢¼ç¹¼çºŒåŸ·è¡Œ search([])
   # PostgreSQL æ‹’çµ•æ‰€æœ‰å‘½ä»¤
   ```

3. **éŒ¯èª¤è¨Šæ¯æ··æ·†**ï¼š
   - ç”¨æˆ¶çœ‹åˆ°çš„æ˜¯ "transaction is aborted"
   - ä½†çœŸæ­£åŸå› æ˜¯ "SerializationFailure"
   - é›£ä»¥ debug

#### ä¿®å¾©ç­–ç•¥

**é—œéµåŸå‰‡**ï¼š**åŠæ™‚ rollbackï¼Œé¿å… ABORTED ç‹€æ…‹**

```python
# ä¿®å¾©å¾Œ
def get_areas(self):
    for attempt in range(max_retries):
        try:
            sync_areas_from_ha()
            commit()

            sync_entity_states_from_ha()

            # ğŸ›¡ï¸ ç‰¹åˆ¥è™•ç† commit
            try:
                commit()
            except SerializationFailure:
                rollback()  # ç«‹å³ rollbackï¼Œæ¢å¾©äº¤æ˜“ç‹€æ…‹
                if attempt < max_retries - 1:
                    continue  # é‡è©¦
                raise

            # âœ“ æ­¤æ™‚äº¤æ˜“ç‹€æ…‹æ­£å¸¸
            areas = search([])
            return {'areas': areas}

        except SerializationFailure:
            rollback()  # ç¢ºä¿äº¤æ˜“ç‹€æ…‹é‡ç½®
            continue
```

**ä¿®å¾©è¦é»**ï¼š

1. âœ… **æ•ç² SerializationFailure**ï¼šåœ¨ commit() è™•æ•ç²
2. âœ… **ç«‹å³ rollback**ï¼šæ¢å¾©äº¤æ˜“ç‹€æ…‹ç‚º IDLE
3. âœ… **é‡è©¦æ©Ÿåˆ¶**ï¼šçµ¦ç³»çµ±ç¬¬äºŒæ¬¡æ©Ÿæœƒ
4. âœ… **éŒ¯èª¤éš”é›¢**ï¼šç”¨ savepoint éš”é›¢æ‰¹æ¬¡æ“ä½œ

---

## ğŸ“š æŠ€è¡“æ¦‚å¿µ

### 1. PostgreSQL äº¤æ˜“éš”é›¢ç­‰ç´š

| éš”é›¢ç­‰ç´š | é«’è®€ | ä¸å¯é‡è¤‡è®€ | å¹»è®€ | åºåˆ—åŒ–ç•°å¸¸ | PostgreSQL é è¨­ | **Odoo é è¨­** |
|---------|-----|----------|-----|-----------|---------------|--------------|
| **READ UNCOMMITTED** | âœ“ | âœ“ | âœ“ | âœ“ | âœ— | âœ— |
| **READ COMMITTED** | âœ— | âœ“ | âœ“ | âœ“ | âœ… | âœ— |
| **REPEATABLE READ** | âœ— | âœ— | âœ“ | âœ“ | âœ— | âœ… |
| **SERIALIZABLE** | âœ— | âœ— | âœ— | âœ— | âœ— | âœ— |

**REPEATABLE READ** ç‰¹æ€§ï¼ˆOdoo ä½¿ç”¨ï¼‰ï¼š
- âœ… åŒä¸€äº¤æ˜“å…§å¤šæ¬¡è®€å–çœ‹åˆ°ä¸€è‡´çš„è³‡æ–™å¿«ç…§
- âœ… é˜²æ­¢ä¸å¯é‡è¤‡è®€ï¼ˆNon-repeatable readsï¼‰
- âœ… ç°¡åŒ–æ¥­å‹™é‚è¼¯ï¼ˆOdoo ORM è¨­è¨ˆä¾è³´æ­¤ç‰¹æ€§ï¼‰
- âš ï¸ ä¸¦ç™¼æ›´æ–°ç›¸åŒè¨˜éŒ„æœƒæ‹‹å‡º SerializationFailure
- âš ï¸ éœ€è¦æ‡‰ç”¨å±¤å¯¦ä½œé‡è©¦æ©Ÿåˆ¶

**READ COMMITTED** ç‰¹æ€§ï¼ˆPostgreSQL é è¨­ï¼‰ï¼š
- âœ… æ¯å€‹æŸ¥è©¢çœ‹åˆ°ç•¶æ™‚å·²æäº¤çš„è³‡æ–™
- âœ… ä¸¦ç™¼æ€§èƒ½è¼ƒé«˜
- âš ï¸ å¯èƒ½å‡ºç¾ä¸å¯é‡è¤‡è®€ï¼ˆåŒä¸€äº¤æ˜“å…§é‡è¤‡æŸ¥è©¢çµæœä¸åŒï¼‰
- âŒ **Odoo ä¸èƒ½ä½¿ç”¨**ï¼šæœƒç ´å£ ORM çš„å‡è¨­ï¼Œå°è‡´è³‡æ–™ä¸ä¸€è‡´

**åƒè€ƒ**ï¼š
- PostgreSQL å®˜æ–¹æ–‡ä»¶ï¼š[13.2. Transaction Isolation](https://www.postgresql.org/docs/current/transaction-iso.html)
- Odoo ç‚ºä½•å¿…é ˆä½¿ç”¨ REPEATABLE READï¼š[Stack Overflow è¨è«–](https://stackoverflow.com/questions/76172482/is-read-write-query-splitting-in-odoo-a-flawless-solution-to-db-scaling)

### 2. Savepoint æ©Ÿåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Main Transaction                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SAVEPOINT sp1                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  UPDATE entity #1  âœ“                        â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  RELEASE sp1                                      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  SAVEPOINT sp2                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  UPDATE entity #2  âŒ Conflict!             â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  ROLLBACK TO sp2  (åªå›æ»¾ #2)                    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  SAVEPOINT sp3                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  UPDATE entity #3  âœ“                        â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  RELEASE sp3                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  COMMIT  (æäº¤ #1, #3ï¼›è·³é #2)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¥½è™•**ï¼š
- âœ… éš”é›¢æ¯å€‹æ“ä½œçš„éŒ¯èª¤ç¯„åœ
- âœ… å–®å€‹å¤±æ•—ä¸å½±éŸ¿æ•´å€‹äº¤æ˜“
- âœ… é©åˆæ‰¹æ¬¡æ“ä½œ

### 3. é‡è©¦æ©Ÿåˆ¶ (Retry Pattern)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Retry Strategy                       â”‚
â”‚                                                         â”‚
â”‚  Attempt 1                                              â”‚
â”‚    â”œâ”€ Execute operation                                 â”‚
â”‚    â”œâ”€ SerializationFailure âŒ                           â”‚
â”‚    â”œâ”€ Rollback                                          â”‚
â”‚    â””â”€ Sleep 500ms                                       â”‚
â”‚                                                         â”‚
â”‚  Attempt 2                                              â”‚
â”‚    â”œâ”€ Execute operation                                 â”‚
â”‚    â”œâ”€ SerializationFailure âŒ                           â”‚
â”‚    â”œâ”€ Rollback                                          â”‚
â”‚    â””â”€ Sleep 500ms                                       â”‚
â”‚                                                         â”‚
â”‚  Attempt 3                                              â”‚
â”‚    â”œâ”€ Execute operation                                 â”‚
â”‚    â””â”€ Success âœ“                                         â”‚
â”‚                                                         â”‚
â”‚  Return result                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åƒæ•¸è¨­è¨ˆ**ï¼š
- `max_retries = 3`ï¼šé¿å…ç„¡é™é‡è©¦
- `retry_delay = 0.5s`ï¼šçµ¦ä¸¦ç™¼æ“ä½œå®Œæˆçš„æ™‚é–“
- **æŒ‡æ•¸é€€é¿** (å¯é¸)ï¼šæ¯æ¬¡å»¶é²åŠ å€ (0.5s, 1s, 2s)

---

## âœ… è§£æ±ºæ–¹æ¡ˆ

### æ¶æ§‹ç¸½è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å…©å±¤é˜²è­·æ©Ÿåˆ¶                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  ğŸ›¡ï¸ ç¬¬ä¸€å±¤ï¼šController å±¤ - é‡è©¦æ©Ÿåˆ¶                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  try:                                              â”‚ â”‚
â”‚  â”‚    sync_areas()                                    â”‚ â”‚
â”‚  â”‚    commit()                                        â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚    sync_entities()                                 â”‚ â”‚
â”‚  â”‚    commit()  â† å¦‚æœå¤±æ•—ï¼Œé‡è©¦æœ€å¤š 3 æ¬¡              â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  except SerializationFailure:                      â”‚ â”‚
â”‚  â”‚    rollback() + sleep() + retry                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  ğŸ›¡ï¸ ç¬¬äºŒå±¤ï¼šModel å±¤ - Savepoint éš”é›¢                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  for entity in entities:                           â”‚ â”‚
â”‚  â”‚    with savepoint():  â† éš”é›¢æ¯å€‹ entity            â”‚ â”‚
â”‚  â”‚      try:                                          â”‚ â”‚
â”‚  â”‚        entity.write(...)                           â”‚ â”‚
â”‚  â”‚      except:                                       â”‚ â”‚
â”‚  â”‚        # è‡ªå‹• rollback æ­¤ savepoint               â”‚ â”‚
â”‚  â”‚        # ä¸å½±éŸ¿å…¶ä»– entities                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®å¾©å‰ vs ä¿®å¾©å¾Œ

#### âŒ ä¿®å¾©å‰
```python
def get_areas(self):
    try:
        # æ‰€æœ‰æ“ä½œåœ¨åŒä¸€å€‹äº¤æ˜“ä¸­
        sync_areas_from_ha()
        sync_entity_states_from_ha()  # æ›´æ–° 70 å€‹ entities
        search([])  # â† å¦‚æœå‰é¢å¤±æ•—ï¼Œé€™è£¡æœƒ aborted
    except Exception as e:
        return {'error': str(e)}
```

**å•é¡Œ**ï¼š
- âŒ å–®é»å¤±æ•—å°è‡´æ•´å€‹åŠŸèƒ½ä¸å¯ç”¨
- âŒ æ²’æœ‰éŒ¯èª¤éš”é›¢
- âŒ æ²’æœ‰é‡è©¦æ©Ÿåˆ¶

#### âœ… ä¿®å¾©å¾Œ
```python
def get_areas(self):
    max_retries = 3

    for attempt in range(max_retries):
        try:
            # æ­¥é©Ÿ 1ï¼šåŒæ­¥ areas
            sync_areas_from_ha()
            commit()  # ç«‹å³æäº¤ï¼Œç¸®å°äº¤æ˜“ç¯„åœ

            # æ­¥é©Ÿ 2ï¼šåŒæ­¥ entitiesï¼ˆå¸¶ savepoint éš”é›¢ï¼‰
            sync_entity_states_from_ha()

            try:
                commit()
            except SerializationFailure:
                rollback()
                if attempt < max_retries - 1:
                    sleep(0.5)
                    continue  # é‡è©¦
                raise

            # æ­¥é©Ÿ 3ï¼šç¨ç«‹åŒæ­¥ entity registry é—œè¯
            _sync_entity_registry_relations()
            commit()

            # æ­¥é©Ÿ 4ï¼šæŸ¥è©¢çµæœ
            areas = search([])
            return {'success': True, 'areas': areas}

        except SerializationFailure:
            rollback()
            if attempt < max_retries - 1:
                sleep(0.5)
                continue
            return {'error': 'Database conflict'}
```

**å„ªå‹¢**ï¼š
- âœ… ç¸®å°äº¤æ˜“ç¯„åœï¼Œæ¸›å°‘è¡çª
- âœ… è‡ªå‹•é‡è©¦ï¼Œæé«˜æˆåŠŸç‡
- âœ… éŒ¯èª¤éš”é›¢ï¼Œä¸å½±éŸ¿æ•´é«”æµç¨‹

---

## ğŸ”§ å¯¦æ–½ç´°ç¯€

### 1. Controller å±¤ä¿®æ”¹

**æª”æ¡ˆ**: `controllers/controllers.py`

```python
# æ–°å¢ import
from psycopg2 import errors as psycopg2_errors
import time

@http.route('/odoo_ha_addon/areas', type='json', auth='user')
def get_areas(self):
    """
    å–å¾—æ‰€æœ‰ Home Assistant areas
    ä½¿ç”¨é‡è©¦æ©Ÿåˆ¶è™•ç†ä¸¦ç™¼æ›´æ–°å°è‡´çš„åºåˆ—åŒ–è¡çª
    """
    max_retries = 3
    retry_delay = 0.5  # ç§’

    for attempt in range(max_retries):
        try:
            # 1. åŒæ­¥ areas
            request.env['ha.area'].sudo().sync_areas_from_ha()
            request.env.cr.commit()

            # 2. åŒæ­¥ entitiesï¼ˆä¸åŒæ­¥ area é—œè¯ï¼‰
            request.env['ha.entity'].sudo().sync_entity_states_from_ha(
                sync_area_relations=False
            )

            # ä½¿ç”¨ nested try è™•ç† commit å¤±æ•—
            try:
                request.env.cr.commit()
            except psycopg2_errors.SerializationFailure as e:
                self._logger.warning(
                    f"Serialization conflict on entity sync "
                    f"(attempt {attempt + 1}/{max_retries}): {e}"
                )
                request.env.cr.rollback()
                if attempt < max_retries - 1:
                    time.sleep(retry_delay)
                    continue
                raise

            # 3. ç¨ç«‹åŒæ­¥ entity registry é—œè¯
            request.env['ha.entity'].sudo()._sync_entity_registry_relations()
            request.env.cr.commit()

            # 4. è®€å–çµæœ
            areas = request.env['ha.area'].sudo().search([])

            return {
                'success': True,
                'areas': [{
                    'id': area.id,
                    'area_id': area.area_id,
                    'name': area.name,
                    'icon': area.icon,
                    'entity_count': area.entity_count,
                } for area in areas]
            }

        except psycopg2_errors.SerializationFailure as e:
            self._logger.warning(
                f"Serialization conflict (attempt {attempt + 1}/{max_retries}): {e}"
            )
            request.env.cr.rollback()
            if attempt < max_retries - 1:
                time.sleep(retry_delay)
                continue
            else:
                self._logger.error(
                    f"Failed after {max_retries} attempts due to serialization conflicts"
                )
                return {
                    'success': False,
                    'error': 'Database conflict, please try again'
                }

        except Exception as e:
            self._logger.error(f"Failed to get areas: {e}", exc_info=True)
            request.env.cr.rollback()
            return {
                'success': False,
                'error': str(e)
            }

    return {
        'success': False,
        'error': 'Unexpected error'
    }
```

**é—œéµæŠ€è¡“é»**ï¼š
1. **åˆ†æ®µ commit**ï¼šæ¯å€‹ä¸»è¦æ­¥é©Ÿå¾Œç«‹å³ commitï¼Œç¸®å°äº¤æ˜“ç¯„åœ
2. **ç•°å¸¸æ•ç²**ï¼šå°ˆé–€æ•ç² `SerializationFailure`
3. **é‡è©¦é‚è¼¯**ï¼šæœ€å¤š 3 æ¬¡ï¼Œæ¯æ¬¡é–“éš” 0.5 ç§’
4. **éŒ¯èª¤é™ç´š**ï¼šè¶…éé‡è©¦æ¬¡æ•¸å¾Œè¿”å›å‹å–„éŒ¯èª¤è¨Šæ¯

### 2. Model å±¤ä¿®æ”¹

**æª”æ¡ˆ**: `models/ha_entity.py`

```python
def _batch_update_entities(self, records):
    """
    æ‰¹æ¬¡æ›´æ–°å¯¦é«”è¨˜éŒ„ï¼ˆæå‡æ€§èƒ½ï¼‰
    ä½¿ç”¨ savepoint éš”é›¢æ¯å€‹å¯¦é«”çš„æ›´æ–°ï¼Œé¿å…åºåˆ—åŒ–è¡çª
    """
    self._logger.debug(f"=== Starting batch update for {len(records)} records ===")

    created_count = 0
    updated_count = 0
    error_count = 0

    for i, record in enumerate(records):
        # ğŸ›¡ï¸ ä½¿ç”¨ savepoint éš”é›¢æ¯å€‹å¯¦é«”çš„æ›´æ–°
        # å¦‚æœèˆ‡ WebSocket state_changed ä¸¦ç™¼ï¼Œåªå½±éŸ¿æ­¤å¯¦é«”
        with self.env.cr.savepoint():
            try:
                entity_id = record['entity_id']

                existing_record = self.env[self._name].search([
                    ('entity_id', '=', entity_id),
                ], limit=1)

                if existing_record:
                    needs_update = (
                        existing_record.entity_state != record['entity_state'] or
                        existing_record.name != record['name'] or
                        existing_record.last_changed != record['last_changed'] or
                        existing_record.attributes != record['attributes']
                    )

                    if needs_update:
                        existing_record.write({
                            'name': record['name'],
                            'entity_state': record['entity_state'],
                            'last_changed': record['last_changed'],
                            'attributes': record['attributes']
                        })
                        updated_count += 1
                else:
                    self.env[self._name].create(record)
                    created_count += 1

            except Exception as e:
                # savepoint æœƒè‡ªå‹• rollback æ­¤æ¬¡è¿­ä»£
                error_count += 1
                entity_id = record.get('entity_id', 'unknown')
                self._logger.error(f"Error updating entity {entity_id}: {e}")

    self._logger.info(
        f"Batch update summary: {created_count} created, "
        f"{updated_count} updated, {error_count} errors"
    )
```

**é—œéµæŠ€è¡“é»**ï¼š
1. **`with self.env.cr.savepoint()`**: è‡ªå‹•ç®¡ç† savepoint
2. **ç¨ç«‹éŒ¯èª¤è™•ç†**ï¼šæ¯å€‹ entity çš„éŒ¯èª¤ä¸å½±éŸ¿å…¶ä»–
3. **éŒ¯èª¤çµ±è¨ˆ**ï¼šè¿½è¹¤æˆåŠŸ/å¤±æ•—æ•¸é‡

---

## ğŸ§ª æ¸¬è©¦é©—è­‰

### æ¸¬è©¦å ´æ™¯

#### å ´æ™¯ 1ï¼šæ­£å¸¸æƒ…æ³
```bash
# å‰ç½®æ¢ä»¶
âœ“ WebSocket æœå‹™é‹è¡Œä¸­
âœ“ æ²’æœ‰ä¸¦ç™¼æ›´æ–°

# æ¸¬è©¦æ­¥é©Ÿ
1. è¨ªå•åˆ†å€å„€è¡¨æ¿

# é æœŸçµæœ
âœ“ é é¢æ­£å¸¸è¼‰å…¥
âœ“ é¡¯ç¤ºæ‰€æœ‰ areas
âœ“ Log ç„¡éŒ¯èª¤
```

#### å ´æ™¯ 2ï¼šè¼•åº¦ä¸¦ç™¼
```bash
# å‰ç½®æ¢ä»¶
âœ“ WebSocket æœå‹™é‹è¡Œä¸­
âœ“ æ¯ç§’ 5-10 å€‹ state_changed äº‹ä»¶

# æ¸¬è©¦æ­¥é©Ÿ
1. è¨ªå•åˆ†å€å„€è¡¨æ¿
2. è§€å¯Ÿ log

# é æœŸçµæœ
âœ“ é é¢æ­£å¸¸è¼‰å…¥
âš ï¸ Log å¯èƒ½å‡ºç¾ "Serialization conflict (attempt 1/3)"
âœ“ æœ€çµ‚æˆåŠŸ (attempt 2 æˆ– 3)
```

#### å ´æ™¯ 3ï¼šé«˜åº¦ä¸¦ç™¼
```bash
# å‰ç½®æ¢ä»¶
âœ“ WebSocket æœå‹™é‹è¡Œä¸­
âœ“ æ¯ç§’ 20+ å€‹ state_changed äº‹ä»¶

# æ¸¬è©¦æ­¥é©Ÿ
1. å¤šæ¬¡å¿«é€Ÿé‡æ–°æ•´ç†é é¢
2. è§€å¯ŸæˆåŠŸç‡

# é æœŸçµæœ
âœ“ 90%+ æˆåŠŸç‡
âš ï¸ å¶çˆ¾éœ€è¦ 2-3 æ¬¡é‡è©¦
âœ— æ¥µå°‘æ•¸å¯èƒ½éœ€è¦ç”¨æˆ¶æ‰‹å‹•é‡è©¦
```

### Log é©—è­‰

#### âœ… æˆåŠŸ Log ç¯„ä¾‹
```
14:50:01,123 - INFO - sync_areas_from_ha completed
14:50:01,456 - INFO - sync_entity_states_from_ha completed
14:50:01,789 - INFO - Batch update summary: 0 created, 70 updated, 0 errors
14:50:02,012 - INFO - search([]) returned 6 areas
```

#### âš ï¸ é‡è©¦ Log ç¯„ä¾‹
```
14:50:01,123 - INFO - sync_areas_from_ha completed
14:50:01,456 - INFO - sync_entity_states_from_ha completed
14:50:01,789 - WARNING - Serialization conflict on entity sync (attempt 1/3)
14:50:02,289 - INFO - Batch update summary: 0 created, 70 updated, 0 errors
14:50:02,512 - INFO - search([]) returned 6 areas
```

#### âŒ å¤±æ•— Log ç¯„ä¾‹ï¼ˆä¸æ‡‰å‡ºç¾ï¼‰
```
14:50:01,123 - INFO - sync_areas_from_ha completed
14:50:01,456 - ERROR - Failed after 3 attempts due to serialization conflicts
14:50:01,457 - ERROR - Failed to get areas: Database conflict
```

---

## ğŸ“– æœ€ä½³å¯¦è¸

### 1. äº¤æ˜“ç®¡ç†åŸå‰‡

#### âœ… DO
```python
# å°äº¤æ˜“ï¼šå¿«é€Ÿ commit
def update_single_entity(self, entity_id):
    entity = self.search([('entity_id', '=', entity_id)])
    entity.write({'state': 'on'})
    self.env.cr.commit()  # ç«‹å³æäº¤

# æ‰¹æ¬¡æ“ä½œï¼šä½¿ç”¨ savepoint
def batch_update(self, records):
    for record in records:
        with self.env.cr.savepoint():
            self._update_record(record)

# é•·æ“ä½œï¼šåˆ†æ®µ commit
def long_sync(self):
    self.sync_step1()
    self.env.cr.commit()

    self.sync_step2()
    self.env.cr.commit()

    self.sync_step3()
    self.env.cr.commit()
```

#### âŒ DON'T
```python
# å¤§äº¤æ˜“ï¼šé•·æ™‚é–“ä¸ commit
def bad_sync(self):
    self.sync_step1()  # æ›´æ–° 1000 ç­†
    self.sync_step2()  # æ›´æ–° 2000 ç­†
    self.sync_step3()  # æ›´æ–° 3000 ç­†
    self.env.cr.commit()  # âŒ 6000 ç­†ä¸€èµ· commitï¼Œè¡çªæ©Ÿç‡é«˜

# æ²’æœ‰éŒ¯èª¤è™•ç†
def no_error_handling(self):
    self.update_all()
    self.env.cr.commit()  # âŒ å¤±æ•—å°±å¤±æ•—ï¼Œæ²’æœ‰é‡è©¦

# è¿´åœˆä¸­ç„¡éš”é›¢
def no_isolation(self, records):
    for record in records:
        record.write({...})  # âŒ ä»»ä¸€å¤±æ•—ï¼Œå…¨éƒ¨å¤±æ•—
```

### 2. ä¸¦ç™¼å ´æ™¯è¨­è¨ˆ

#### è®€å¤šå¯«å°‘ï¼ˆæ¨è–¦ï¼‰
```python
# é©åˆï¼šDashboard æ•¸æ“šå±•ç¤º
def get_statistics(self):
    # åªè®€æ“ä½œï¼Œç„¡è¡çª
    return self.search_read([], ['name', 'state', 'value'])
```

#### å¯«å¤šè®€å°‘ï¼ˆéœ€å„ªåŒ–ï¼‰
```python
# éœ€è¦ï¼šæ‰¹æ¬¡ + savepoint + é‡è©¦
def bulk_update(self, records):
    for attempt in range(3):
        try:
            for record in records:
                with self.env.cr.savepoint():
                    self._update(record)
            self.env.cr.commit()
            break
        except SerializationFailure:
            self.env.cr.rollback()
            time.sleep(0.5)
```

#### é«˜ä¸¦ç™¼å¯«å…¥ï¼ˆè€ƒæ…®éšŠåˆ—ï¼‰
```python
# å»ºè­°ï¼šä½¿ç”¨ Message Queue
def high_concurrent_updates(self, data):
    # å°‡æ›´æ–°è«‹æ±‚æ”¾å…¥éšŠåˆ—
    self.env['ir.queue'].add({
        'model': 'ha.entity',
        'method': '_update',
        'args': [data]
    })
    # èƒŒæ™¯ worker ä¸²åˆ—è™•ç†ï¼Œé¿å…è¡çª
```

### 3. éŒ¯èª¤ç›£æ§

#### æ·»åŠ ç›£æ§æŒ‡æ¨™
```python
class HaEntity(models.Model):
    _name = 'ha.entity'

    @api.model
    def _batch_update_entities(self, records):
        start_time = time.time()

        # ... æ›´æ–°é‚è¼¯ ...

        # è¨˜éŒ„æŒ‡æ¨™
        duration = time.time() - start_time
        self.env['monitoring.metric'].create({
            'name': 'ha_entity_batch_update',
            'duration': duration,
            'records_count': len(records),
            'error_count': error_count,
            'success_rate': (len(records) - error_count) / len(records)
        })
```

#### å‘Šè­¦è¨­ç½®
```python
# å¦‚æœéŒ¯èª¤ç‡è¶…é 10%ï¼Œç™¼é€å‘Šè­¦
if error_count / len(records) > 0.1:
    self.env['alert.service'].send({
        'level': 'warning',
        'message': f'High error rate in batch update: {error_count}/{len(records)}'
    })
```

### 4. æ€§èƒ½å„ªåŒ–å»ºè­°

#### Bulk Operations
```python
# âœ… å¥½ï¼šæ‰¹æ¬¡æ›´æ–°
def bulk_write(self, entities, values):
    entities.write(values)  # ä¸€æ¬¡ SQL

# âŒ å£ï¼šé€ä¸€æ›´æ–°
def bad_write(self, entities, values):
    for entity in entities:
        entity.write(values)  # N æ¬¡ SQL
```

#### Batch Size
```python
# åˆ†æ‰¹è™•ç†ï¼Œé¿å…å–®æ¬¡äº¤æ˜“éå¤§
def chunked_update(self, records):
    BATCH_SIZE = 100

    for i in range(0, len(records), BATCH_SIZE):
        batch = records[i:i+BATCH_SIZE]

        with self.env.cr.savepoint():
            self._process_batch(batch)

        # æ¯æ‰¹æ¬¡å¾Œ commit
        if i % (BATCH_SIZE * 5) == 0:
            self.env.cr.commit()
```

---

## ğŸš¨ å¿«é€Ÿè¨ºæ–·æŒ‡å—

### å¦‚ä½•åˆ¤æ–·æ˜¯å¦é‡åˆ°æ­¤å•é¡Œï¼Ÿ

#### ç—‡ç‹€æª¢æŸ¥è¡¨

| ç—‡ç‹€ | èªªæ˜ | æª¢æŸ¥æ–¹æ³• |
|-----|------|---------|
| âœ… **éŒ¯èª¤è¨Šæ¯** | Log å‡ºç¾ `transaction is aborted` | æœå°‹ log: `grep "transaction is aborted"` |
| âœ… **å‰ç½®éŒ¯èª¤** | ä¹‹å‰å‡ºç¾ `SerializationFailure` | æœå°‹ log: `grep "could not serialize"` |
| âœ… **ä¸¦ç™¼å ´æ™¯** | æœ‰èƒŒæ™¯æœå‹™åŒæ™‚å¯«å…¥è³‡æ–™åº« | æª¢æŸ¥æ˜¯å¦æœ‰ WebSocket/Cron/Queue worker |
| âœ… **æ‰¹æ¬¡æ“ä½œ** | æ­£åœ¨é€²è¡Œå¤§é‡è³‡æ–™æ›´æ–° | æª¢æŸ¥æ˜¯å¦æœ‰ batch update æ“ä½œ |
| âœ… **åŠŸèƒ½ä¸å¯ç”¨** | ç”¨æˆ¶æ“ä½œå®Œå…¨å¤±æ•— | å‰ç«¯è¿”å› 500 éŒ¯èª¤ |

#### è¨ºæ–·æ­¥é©Ÿ

```bash
# æ­¥é©Ÿ 1: æª¢æŸ¥ log ä¸­çš„éŒ¯èª¤åºåˆ—
docker compose logs web | grep -A 5 -B 5 "transaction is aborted"

# é æœŸçœ‹åˆ°ï¼š
# 1. å…ˆå‡ºç¾ SerializationFailure
# 2. ç„¶å¾Œå‡ºç¾ transaction is aborted

# æ­¥é©Ÿ 2: æª¢æŸ¥æ˜¯å¦æœ‰ä¸¦ç™¼æ›´æ–°
docker compose logs web | grep "State changed" | tail -20

# é æœŸçœ‹åˆ°ï¼šWebSocket æœå‹™æŒçºŒæ›´æ–° entities

# æ­¥é©Ÿ 3: æª¢æŸ¥äº¤æ˜“ç¯„åœ
# æŸ¥çœ‹å¤±æ•—çš„æ“ä½œæ˜¯å¦åŒ…å«å¤§é‡ UPDATE
docker compose logs web | grep "Batch update summary"
```

### å¸¸è¦‹å•é¡Œ (FAQ)

#### Q1: ç‚ºä»€éº¼æˆ‘åªçœ‹åˆ° "transaction is aborted" éŒ¯èª¤ï¼Ÿ

**A**: é€™æ˜¯**é€£é–éŒ¯èª¤**çš„è¡¨è±¡ã€‚çœŸæ­£çš„æ ¹æœ¬åŸå› æ˜¯ `SerializationFailure`ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. å¾€å‰ç¿»é–± logï¼Œæ‰¾åˆ°å‰é¢çš„ `SerializationFailure`
2. é‚£æ‰æ˜¯çœŸæ­£éœ€è¦è§£æ±ºçš„å•é¡Œ

**Log ç¯„ä¾‹**ï¼š
```
14:47:59,828 - ERROR: could not serialize access... â† çœŸæ­£åŸå› 
14:47:59,194 - ERROR: transaction is aborted...     â† é€£é–çµæœ
```

---

#### Q2: ç‚ºä»€éº¼é‡æ–°æ•´ç†é é¢å°±å¥½äº†ï¼Ÿ

**A**: å› ç‚ºä¸‹ä¸€æ¬¡è«‹æ±‚æ™‚ï¼Œä¸¦ç™¼è¡çªçš„æ©Ÿç‡é™ä½äº†ã€‚

**ä½†å•é¡Œæ²’æœ‰æ ¹æœ¬è§£æ±º**ï¼š
- âŒ ç”¨æˆ¶é«”é©—å·®ï¼ˆéœ€è¦é‡æ–°æ•´ç†ï¼‰
- âŒ é«˜ä¸¦ç™¼æ™‚ä»æœƒå¤±æ•—
- âœ… éœ€è¦å¯¦ä½œé‡è©¦æ©Ÿåˆ¶

---

#### Q3: é—œé–‰ WebSocket æœå‹™å¯ä»¥è§£æ±ºå—ï¼Ÿ

**A**: å¯ä»¥æš«æ™‚é¿å…å•é¡Œï¼Œä½†**ä¸å»ºè­°**ã€‚

**ç‚ºä»€éº¼ä¸å»ºè­°**ï¼š
- âŒ å¤±å»å³æ™‚æ›´æ–°åŠŸèƒ½
- âŒ æœªä¾†ä»»ä½•ä¸¦ç™¼å ´æ™¯éƒ½æœƒæœ‰å•é¡Œ
- âŒ æ²»æ¨™ä¸æ²»æœ¬

**æ­£ç¢ºåšæ³•**ï¼š
- âœ… å¯¦ä½œæœ¬æ–‡çš„å…©å±¤é˜²è­·æ©Ÿåˆ¶
- âœ… è®“ä¸¦ç™¼æ›´æ–°æˆç‚ºå¯æ¥å—çš„æ­£å¸¸æƒ…æ³

---

#### Q4: å¯ä»¥æ”¹ç”¨ READ COMMITTED é™ä½è¡çªå—ï¼Ÿ

**A**: **çµ•å°ä¸è¡Œï¼** Odoo å¿…é ˆä½¿ç”¨ REPEATABLE READï¼Œæ”¹ç”¨ READ COMMITTED æœƒå°è‡´åš´é‡å•é¡Œã€‚

**ç‚ºä»€éº¼ Odoo ä¸èƒ½æ”¹ç”¨ READ COMMITTEDï¼Ÿ**

1. **ORM è¨­è¨ˆå‡è¨­**ï¼š
   ```python
   # Odoo ORM å‡è¨­åŒä¸€äº¤æ˜“å…§è®€åˆ°ä¸€è‡´çš„è³‡æ–™
   record = self.env['sale.order'].browse(order_id)
   price1 = record.amount_total  # è®€å– 1
   # ... ä¸­é–“åŸ·è¡Œå…¶ä»–é‚è¼¯ ...
   price2 = record.amount_total  # è®€å– 2
   # Odoo å‡è¨­ price1 == price2ï¼
   ```

2. **è³‡æ–™ä¸€è‡´æ€§é¢¨éšª**ï¼š
   - æœƒè¨ˆè³‡æ–™å¯èƒ½ä¸ä¸€è‡´ï¼ˆè¨‚å–®é‡‘é¡è¨ˆç®—éŒ¯èª¤ï¼‰
   - åº«å­˜ä¿ç•™å¯èƒ½å‡ºå•é¡Œï¼ˆè¶…è³£ï¼‰
   - æ¥­å‹™é‚è¼¯å‡è¨­è¢«ç ´å£

3. **å®˜æ–¹æ˜ç¢ºè­¦å‘Š**ï¼š
   > "ç§»é™¤ REPEATABLE READ çš„ä¿è­‰æœƒç§»é™¤æ‰€æœ‰é–‹ç™¼è€…ç†æ‰€ç•¶ç„¶çš„åŸºæœ¬å‡è¨­ï¼Œä»¥åŠæ¡†æ¶æ‰€æœŸæœ›çš„ä¿è­‰ã€‚" - Odoo å®˜æ–¹è«–å£‡

**éš”é›¢ç­‰ç´šå°ç…§ï¼ˆOdoo ç’°å¢ƒï¼‰**ï¼š

| éš”é›¢ç­‰ç´š | Odoo ç›¸å®¹æ€§ | è¡çªæ©Ÿç‡ | ä¸¦ç™¼æ€§èƒ½ | å»ºè­° |
|---------|-----------|---------|---------|------|
| READ UNCOMMITTED | âŒ ä¸æ”¯æ´ | - | - | âŒ PostgreSQL ä¸æ”¯æ´ |
| READ COMMITTED | âŒ **å±éšª** | ä½ | é«˜ | âŒ **æœƒç ´å£è³‡æ–™ä¸€è‡´æ€§** |
| **REPEATABLE READ** | âœ… **å¿…éœ€** | ä¸­ | ä¸­ | âœ… **Odoo å¼·åˆ¶è¦æ±‚** |
| SERIALIZABLE | âš ï¸ éåº¦ | é«˜ | ä½ | âŒ æ€§èƒ½éå·®ï¼Œç„¡å¿…è¦ |

**æ­£ç¢ºåšæ³•**ï¼š
- âœ… **ä¿æŒ REPEATABLE READ**ï¼ˆOdoo å¼·åˆ¶è¦æ±‚ï¼‰
- âœ… å¯¦ä½œé‡è©¦æ©Ÿåˆ¶è™•ç† SerializationFailure
- âœ… ä½¿ç”¨ savepoint éš”é›¢æ‰¹æ¬¡æ“ä½œ
- âœ… ä½¿ç”¨ SELECT FOR UPDATE é é˜²ç‰¹å®šè¡çª

**åƒè€ƒ**ï¼š
- [Odoo è«–å£‡ï¼šç‚ºä½•ä¸èƒ½æ”¹ isolation level](https://www.odoo.com/forum/help-1/repeated-serialization-errorscould-not-serialize-access-due-to-concurrent-update-in-postgres-database-148511)
- [GitHub è¨è«–ï¼šæ”¹ç”¨ READ COMMITTED çš„é¢¨éšª](https://github.com/buke/odoo_base_isolation_level)

---

#### Q5: é‡è©¦å¤šå°‘æ¬¡åˆé©ï¼Ÿ

**A**: å»ºè­° **2-3 æ¬¡**ï¼Œé–“éš” **0.5-1 ç§’**ã€‚

**ç†ç”±**ï¼š
```python
# æˆåŠŸç‡è¨ˆç®— (å‡è¨­æ¯æ¬¡è¡çªæ©Ÿç‡ 30%)
retry_0 = 70%  # ç¬¬ä¸€æ¬¡æˆåŠŸç‡
retry_1 = 70% + 30% * 70% = 91%
retry_2 = 91% + 9% * 70% = 97.3%
retry_3 = 97.3% + 2.7% * 70% = 99.2%
```

**é…ç½®å»ºè­°**ï¼š
```python
max_retries = 3        # 99%+ æˆåŠŸç‡
retry_delay = 0.5      # çµ¦ä¸¦ç™¼æ“ä½œå®Œæˆæ™‚é–“

# æ¥µç«¯æƒ…æ³å¯èª¿æ•´
# é«˜ä¸¦ç™¼ç’°å¢ƒ: retry_delay = 1.0
# ä½å»¶é²è¦æ±‚: max_retries = 2
```

---

#### Q6: savepoint æœƒå½±éŸ¿æ€§èƒ½å—ï¼Ÿ

**A**: æœ‰è¼•å¾®å½±éŸ¿ï¼ˆ~5%ï¼‰ï¼Œä½†**åˆ©å¤§æ–¼å¼Š**ã€‚

**æ€§èƒ½å°æ¯”**ï¼š

| æ–¹æ¡ˆ | ååé‡ | éŒ¯èª¤ç‡ | ç”¨æˆ¶é«”é©— |
|-----|-------|-------|---------|
| ç„¡ savepoint | 100% | 80% | âŒ æ¥µå·® |
| æœ‰ savepoint | 95% | 2% | âœ… è‰¯å¥½ |

**çµè«–**ï¼š
- è¼•å¾®çš„æ€§èƒ½ä¸‹é™æ›ä¾†é«˜å¯é æ€§ï¼Œ**å€¼å¾—**

---

#### Q7: å¦‚ä½•é é˜²è€Œä¸æ˜¯ä¿®å¾©ï¼Ÿ

**A**: å¾æ¶æ§‹è¨­è¨ˆä¸Šé¿å…ä¸¦ç™¼å¯«å…¥ã€‚

**é é˜²ç­–ç•¥**ï¼š

1. **è®€å¯«åˆ†é›¢**ï¼š
   ```python
   # Dashboard åªè®€å–å¿«å–
   def get_dashboard_data():
       return cache.get('ha_entities')  # ç„¡è³‡æ–™åº«å¯«å…¥

   # èƒŒæ™¯ä»»å‹™å®šæœŸæ›´æ–°å¿«å–
   @cron('*/5 * * * *')
   def update_cache():
       data = fetch_from_ha()
       cache.set('ha_entities', data)
   ```

2. **äº‹ä»¶é©…å‹•**ï¼š
   ```python
   # WebSocket æ›´æ–°ç™¼é€äº‹ä»¶ï¼Œä¸ç›´æ¥å¯« DB
   def on_state_changed(entity_id, state):
       event_bus.emit('entity_update', {
           'entity_id': entity_id,
           'state': state
       })

   # å–®ä¸€ worker è™•ç†æ‰€æœ‰æ›´æ–°
   @event_bus.on('entity_update')
   def handle_update(data):
       entity.write(data)  # ä¸²åˆ—è™•ç†ï¼Œç„¡è¡çª
   ```

3. **é™ä½æ›´æ–°é »ç‡**ï¼š
   ```python
   # ä¸æ˜¯æ¯å€‹ state_changed éƒ½æ›´æ–° DB
   def should_update(old_state, new_state):
       # åªæœ‰é¡¯è‘—è®ŠåŒ–æ‰æ›´æ–°
       if abs(float(new_state) - float(old_state)) < 0.1:
           return False
       return True
   ```

---

#### Q8: Odoo æœ‰å…§å»ºçš„é‡è©¦æ©Ÿåˆ¶å—ï¼Ÿ

**A**: **æœ‰ï¼Œä½†ä¸å®Œæ•´ã€‚** Odoo æ¡†æ¶æœƒåœ¨**ç‰¹å®šæ¢ä»¶ä¸‹**è‡ªå‹•é‡è©¦ SerializationFailureï¼Œä½†ä¸¦éæ‰€æœ‰æƒ…æ³éƒ½æœƒé‡è©¦ã€‚

**Odoo å…§å»ºé‡è©¦æ©Ÿåˆ¶**ï¼š

1. **HTTP Controller è‡ªå‹•é‡è©¦**ï¼š
   ```python
   # odoo/http.py ä¸­çš„å¯¦ä½œ
   # Odoo æœƒè‡ªå‹•é‡è©¦ HTTP è«‹æ±‚æœ€å¤š 3 æ¬¡
   # ä½†åƒ…é™æ–¼ç‰¹å®šçš„è³‡æ–™åº«éŒ¯èª¤
   ```

2. **æœ‰é™çš„é‡è©¦ç¯„åœ**ï¼š
   - âœ… åªé‡è©¦ HTTP è«‹æ±‚å±¤ç´š
   - âŒ ä¸é‡è©¦ RPC èª¿ç”¨
   - âŒ ä¸é‡è©¦ Cron Job
   - âŒ ä¸é‡è©¦ WebSocket æ“ä½œ

3. **é‡è©¦æ¢ä»¶é™åˆ¶**ï¼š
   ```python
   # Odoo åªé‡è©¦ä»¥ä¸‹éŒ¯èª¤ï¼š
   # - OperationalError (é€£ç·šå•é¡Œ)
   # - SerializationFailure (ä¸¦ç™¼è¡çª)
   # ä½†ä¸ä¿è­‰æ‰€æœ‰å ´æ™¯éƒ½æœƒè§¸ç™¼
   ```

**ç‚ºä»€éº¼æˆ‘å€‘é‚„éœ€è¦è‡ªå·±å¯¦ä½œé‡è©¦ï¼Ÿ**

| åŸå›  | èªªæ˜ | å½±éŸ¿ |
|------|------|------|
| **ç²’åº¦æ§åˆ¶** | Odoo åªåœ¨æœ€å¤–å±¤é‡è©¦ï¼Œç„¡æ³•æ§åˆ¶å…§éƒ¨é‚è¼¯ | ç„¡æ³•ç‚ºç‰¹å®šæ“ä½œè¨­ç½®ä¸åŒé‡è©¦ç­–ç•¥ |
| **éŒ¯èª¤éš”é›¢** | Odoo é‡è©¦æ•´å€‹è«‹æ±‚ï¼ŒåŒ…å«å·²æˆåŠŸçš„éƒ¨åˆ† | æµªè²»è³‡æºï¼Œé™ä½æ•ˆç‡ |
| **Savepoint æ”¯æ´** | Odoo ä¸ä½¿ç”¨ savepoint éš”é›¢æ‰¹æ¬¡æ“ä½œ | å–®å€‹å¤±æ•—å°è‡´æ•´æ‰¹å¤±æ•— |
| **æ—¥èªŒå¯è¦‹æ€§** | Odoo æ¡†æ¶é‡è©¦ä¸æœƒç•™ä¸‹æ—¥èªŒ | é›£ä»¥ç›£æ§å’Œè¨ºæ–· |
| **æ¥­å‹™é‚è¼¯** | ç„¡æ³•åœ¨é‡è©¦å‰åŸ·è¡Œæ¸…ç†æˆ–è£œå„Ÿé‚è¼¯ | ç„¡æ³•è™•ç†è¤‡é›œå ´æ™¯ |

**å…©è€…å°æ¯”**ï¼š

```python
# âŒ Odoo æ¡†æ¶è‡ªå‹•é‡è©¦ï¼ˆé»‘ç›’ï¼Œç„¡æ³•æ§åˆ¶ï¼‰
@http.route('/my_endpoint', type='json')
def my_endpoint(self):
    # Odoo æœƒé‡è©¦æ•´å€‹è«‹æ±‚
    step1()  # å¯èƒ½å·²æˆåŠŸ
    step2()  # SerializationFailure ç™¼ç”Ÿ
    step3()  # æœªåŸ·è¡Œ
    # Odoo å¾é ­é‡è©¦ step1-3ï¼Œæµªè²»è³‡æº

# âœ… è‡ªè¨‚é‡è©¦æ©Ÿåˆ¶ï¼ˆç²¾ç´°æ§åˆ¶ï¼‰
@http.route('/my_endpoint', type='json')
def my_endpoint(self):
    step1()
    commit()  # step1 å·²æäº¤ï¼Œä¸æœƒé‡åš

    for attempt in range(3):
        try:
            step2()  # åªé‡è©¦ step2
            commit()
            break
        except SerializationFailure:
            rollback()
            if attempt < 2:
                continue  # é‡è©¦
            raise

    step3()
    commit()
```

**æœ€ä½³å¯¦è¸**ï¼š

1. **Controller å±¤**ï¼šè‡ªå·±å¯¦ä½œé‡è©¦ï¼Œç²¾ç´°æ§åˆ¶
2. **Model å±¤**ï¼šä½¿ç”¨ savepoint éš”é›¢æ‰¹æ¬¡æ“ä½œ
3. **ç›£æ§æ—¥èªŒ**ï¼šè¨˜éŒ„æ¯æ¬¡é‡è©¦ï¼Œä¾¿æ–¼è¨ºæ–·
4. **æ¡†æ¶é‡è©¦ä½œç‚ºä¿åº•**ï¼šOdoo æ¡†æ¶é‡è©¦æ˜¯æœ€å¾Œä¸€é“é˜²ç·š

**åƒè€ƒ**ï¼š
- Odoo æºç¢¼ï¼š`odoo/http.py` çš„ `dispatch()` æ–¹æ³•
- Odoo å®˜æ–¹æ–‡ä»¶ï¼š[Error Handling](https://www.odoo.com/documentation/18.0/developer/reference/backend/http.html)

---

#### Q9: å¦‚ä½•åœ¨ç”Ÿç”¢ç’°å¢ƒç›£æ§é€™é¡éŒ¯èª¤ï¼Ÿ

**A**: å»ºç«‹å®Œæ•´çš„ç›£æ§ã€å‘Šè­¦ã€åˆ†ææµç¨‹ã€‚

**1. æ—¥èªŒç›£æ§**

**é—œéµæ—¥èªŒæ¨¡å¼**ï¼š

```bash
# éœ€è¦ç›£æ§çš„æ—¥èªŒæ¨¡å¼
ERROR.*SerializationFailure              # åºåˆ—åŒ–è¡çª
ERROR.*transaction is aborted             # äº¤æ˜“ä¸­æ­¢
WARNING.*Serialization conflict           # é‡è©¦è­¦å‘Š
ERROR.*could not serialize access         # PostgreSQL éŒ¯èª¤
```

**æ—¥èªŒèšåˆé…ç½®**ï¼ˆä½¿ç”¨ ELK Stack / Graylog / Datadogï¼‰ï¼š

```yaml
# Filebeat é…ç½®ç¯„ä¾‹
filebeat.inputs:
- type: log
  paths:
    - /var/log/odoo/*.log
  multiline:
    pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
    negate: true
    match: after
  fields:
    service: odoo
    environment: production

processors:
  - add_fields:
      target: error
      fields:
        serialization_conflict:
          matches: "SerializationFailure|could not serialize"

output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "odoo-logs-%{+yyyy.MM.dd}"
```

**2. ç›£æ§æŒ‡æ¨™**

**æ ¸å¿ƒæŒ‡æ¨™**ï¼š

| æŒ‡æ¨™ | èªªæ˜ | å‘Šè­¦é–¾å€¼ | æŸ¥è©¢æ–¹å¼ |
|------|------|---------|---------|
| **è¡çªé »ç‡** | æ¯åˆ†é˜ SerializationFailure æ¬¡æ•¸ | > 10/min | æ—¥èªŒè¨ˆæ•¸ |
| **é‡è©¦æˆåŠŸç‡** | é‡è©¦å¾Œæœ€çµ‚æˆåŠŸçš„æ¯”ç‡ | < 95% | æ—¥èªŒåˆ†æ |
| **å¹³å‡é‡è©¦æ¬¡æ•¸** | æ¯æ¬¡è«‹æ±‚å¹³å‡é‡è©¦æ¬¡æ•¸ | > 1.5 | æ—¥èªŒçµ±è¨ˆ |
| **å®Œå…¨å¤±æ•—ç‡** | è¶…éæœ€å¤§é‡è©¦æ¬¡æ•¸çš„æ¯”ç‡ | > 2% | éŒ¯èª¤è¨ˆæ•¸ |
| **å—å½±éŸ¿ç«¯é»** | å“ªäº› API ç«¯é»æœ€å¸¸ç™¼ç”Ÿ | - | æ—¥èªŒåˆ†çµ„ |

**Prometheus æŒ‡æ¨™é…ç½®**ï¼š

```python
# models/ha_entity.py
from prometheus_client import Counter, Histogram

# å®šç¾©æŒ‡æ¨™
serialization_failures = Counter(
    'odoo_ha_serialization_failures_total',
    'Total number of serialization failures',
    ['endpoint', 'attempt']
)

retry_duration = Histogram(
    'odoo_ha_retry_duration_seconds',
    'Time spent in retry loops',
    ['endpoint']
)

# åœ¨ç¨‹å¼ç¢¼ä¸­è¨˜éŒ„
def get_areas(self):
    endpoint = 'get_areas'
    start_time = time.time()

    for attempt in range(max_retries):
        try:
            # ... æ¥­å‹™é‚è¼¯ ...
            retry_duration.labels(endpoint=endpoint).observe(
                time.time() - start_time
            )
            return result

        except SerializationFailure:
            serialization_failures.labels(
                endpoint=endpoint,
                attempt=attempt
            ).inc()
            # ... é‡è©¦é‚è¼¯ ...
```

**3. å‘Šè­¦è¨­ç½®**

**å‘Šè­¦è¦å‰‡ç¯„ä¾‹**ï¼ˆPrometheus AlertManagerï¼‰ï¼š

```yaml
# alerts/serialization_conflicts.yml
groups:
- name: odoo_serialization
  interval: 30s
  rules:
    # é«˜é »è¡çªå‘Šè­¦
    - alert: HighSerializationFailureRate
      expr: |
        rate(odoo_ha_serialization_failures_total[5m]) > 0.5
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "High serialization failure rate"
        description: "{{ $value }} failures/sec in last 5 minutes"

    # é‡è©¦å¤±æ•—å‘Šè­¦
    - alert: RetryExhaustion
      expr: |
        rate(odoo_ha_serialization_failures_total{attempt="2"}[5m]) > 0.1
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "Retry mechanism exhausted"
        description: "Requests failing after max retries"

    # å¹³å‡é‡è©¦æ¬¡æ•¸éé«˜
    - alert: HighAverageRetries
      expr: |
        avg_over_time(odoo_ha_retry_duration_seconds[10m]) > 2
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High average retry count"
        description: "Average retry time is {{ $value }}s"
```

**4. è³‡æ–™åº«å±¤é¢ç›£æ§**

**PostgreSQL çµ±è¨ˆæŸ¥è©¢**ï¼š

```sql
-- å»ºç«‹ç›£æ§ View
CREATE OR REPLACE VIEW serialization_conflict_stats AS
SELECT
    datname,
    -- æ­»é–æ¬¡æ•¸
    deadlocks,
    -- äº¤æ˜“è¡çªæ¬¡æ•¸ï¼ˆPostgreSQL 13+ï¼‰
    COALESCE(
        (SELECT sum(conflicts) FROM pg_stat_database_conflicts
         WHERE datname = pg_database.datname),
        0
    ) as conflicts,
    -- æ´»èºé€£ç·šæ•¸
    (SELECT count(*) FROM pg_stat_activity
     WHERE datname = pg_database.datname AND state = 'active') as active_connections
FROM pg_stat_database
WHERE datname = 'odoo';

-- å®šæœŸæŸ¥è©¢ï¼ˆæ¯åˆ†é˜ï¼‰
SELECT * FROM serialization_conflict_stats;
```

**pgBadger æ—¥èªŒåˆ†æ**ï¼š

```bash
# åˆ†æ PostgreSQL æ—¥èªŒ
pgbadger /var/log/postgresql/postgresql-*.log \
  -o /var/www/html/pgbadger.html \
  --prefix '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h'

# æŸ¥çœ‹åºåˆ—åŒ–éŒ¯èª¤çµ±è¨ˆ
grep "could not serialize" /var/log/postgresql/postgresql-*.log | wc -l
```

**5. Dashboard è¦–è¦ºåŒ–**

**Grafana Dashboard é…ç½®**ï¼š

```json
{
  "dashboard": {
    "title": "Odoo HA Serialization Monitoring",
    "panels": [
      {
        "title": "Serialization Failures (rate)",
        "targets": [{
          "expr": "rate(odoo_ha_serialization_failures_total[5m])"
        }],
        "type": "graph"
      },
      {
        "title": "Retry Success Rate",
        "targets": [{
          "expr": "1 - (rate(odoo_ha_serialization_failures_total{attempt='2'}[5m]) / rate(odoo_ha_serialization_failures_total[5m]))"
        }],
        "type": "gauge"
      },
      {
        "title": "Affected Endpoints",
        "targets": [{
          "expr": "topk(5, sum by (endpoint) (rate(odoo_ha_serialization_failures_total[10m])))"
        }],
        "type": "table"
      },
      {
        "title": "PostgreSQL Active Connections",
        "targets": [{
          "expr": "pg_stat_activity_count{state='active'}"
        }],
        "type": "graph"
      }
    ]
  }
}
```

**6. å¯¦ç”¨ç›£æ§è…³æœ¬**

**å³æ™‚ç›£æ§è…³æœ¬**ï¼š

```bash
#!/bin/bash
# monitor_serialization.sh

LOGFILE="/var/log/odoo/odoo.log"
INTERVAL=60  # ç§’

while true; do
    echo "=== $(date) ==="

    # çµ±è¨ˆæœ€è¿‘ 1 åˆ†é˜çš„éŒ¯èª¤
    echo "SerializationFailure count:"
    tail -n 10000 "$LOGFILE" | grep -c "SerializationFailure"

    echo "Transaction aborted count:"
    tail -n 10000 "$LOGFILE" | grep -c "transaction is aborted"

    echo "Retry warnings:"
    tail -n 10000 "$LOGFILE" | grep "Serialization conflict" | tail -5

    echo "Most affected endpoints:"
    tail -n 10000 "$LOGFILE" | grep "SerializationFailure" | \
      grep -oP '/odoo_ha_addon/\w+' | sort | uniq -c | sort -rn | head -5

    echo ""
    sleep $INTERVAL
done
```

**å¥åº·æª¢æŸ¥ç«¯é»**ï¼š

```python
# controllers/health.py
@http.route('/health/serialization', type='json', auth='user')
def check_serialization_health(self):
    """å¥åº·æª¢æŸ¥ç«¯é»ï¼šè¿”å›åºåˆ—åŒ–è¡çªçµ±è¨ˆ"""
    # æŸ¥è©¢æœ€è¿‘ 1 å°æ™‚çš„æ—¥èªŒçµ±è¨ˆ
    log_stats = self._analyze_recent_logs(hours=1)

    health_status = "healthy"
    if log_stats['failure_rate'] > 0.05:
        health_status = "degraded"
    if log_stats['failure_rate'] > 0.2:
        health_status = "unhealthy"

    return {
        'status': health_status,
        'metrics': {
            'serialization_failures': log_stats['total_failures'],
            'failure_rate': log_stats['failure_rate'],
            'avg_retries': log_stats['avg_retries'],
            'last_failure': log_stats['last_failure_time']
        }
    }
```

**7. å‘Šè­¦é€šçŸ¥ç¯„ä¾‹**

**Slack é€šçŸ¥**ï¼š

```python
# utils/alerting.py
import requests

def send_slack_alert(severity, message, metrics):
    """ç™¼é€ Slack å‘Šè­¦"""
    webhook_url = "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

    color = {
        'warning': '#FFA500',
        'critical': '#FF0000'
    }.get(severity, '#808080')

    payload = {
        "attachments": [{
            "color": color,
            "title": f"ğŸš¨ Odoo HA - {severity.upper()} Alert",
            "text": message,
            "fields": [
                {"title": k, "value": v, "short": True}
                for k, v in metrics.items()
            ],
            "footer": "Odoo HA Monitoring",
            "ts": int(time.time())
        }]
    }

    requests.post(webhook_url, json=payload)

# ä½¿ç”¨ç¯„ä¾‹
if failure_rate > 0.1:
    send_slack_alert(
        severity='warning',
        message='High serialization failure rate detected',
        metrics={
            'Failure Rate': f'{failure_rate:.2%}',
            'Total Failures': total_failures,
            'Affected Endpoint': most_affected_endpoint
        }
    )
```

**ç¸½çµ**ï¼š

| ç›£æ§å±¤ç´š | å·¥å…·å»ºè­° | å‘Šè­¦é–¾å€¼ |
|---------|---------|---------|
| **æ‡‰ç”¨æ—¥èªŒ** | ELK Stack / Graylog | > 10 failures/min |
| **æ‡‰ç”¨æŒ‡æ¨™** | Prometheus + Grafana | Success rate < 95% |
| **è³‡æ–™åº«** | pgBadger / pg_stat | Conflicts > 100/hour |
| **ç³»çµ±** | Datadog / New Relic | Response time > 5s |
| **å¥åº·æª¢æŸ¥** | è‡ªè¨‚ HTTP ç«¯é» | Status = unhealthy |

**åƒè€ƒ**ï¼š
- Prometheus æœ€ä½³å¯¦è¸ï¼šhttps://prometheus.io/docs/practices/naming/
- Grafana Dashboardï¼šhttps://grafana.com/grafana/dashboards/
- PostgreSQL Monitoringï¼šhttps://www.postgresql.org/docs/current/monitoring-stats.html

---

### ç·Šæ€¥è™•ç†æµç¨‹

é‡åˆ°æ­¤å•é¡Œæ™‚çš„è™•ç†æ­¥é©Ÿï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç·Šæ€¥è™•ç† SOP                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  1ï¸âƒ£  ç¢ºèªå•é¡Œ
      â”œâ”€ æª¢æŸ¥ log: æ˜¯å¦æœ‰ "transaction is aborted"
      â”œâ”€ æª¢æŸ¥ log: å‰é¢æ˜¯å¦æœ‰ "SerializationFailure"
      â””â”€ ç¢ºèªå½±éŸ¿ç¯„åœï¼šå“ªäº›åŠŸèƒ½å—å½±éŸ¿

  2ï¸âƒ£  è‡¨æ™‚ç·©è§£ï¼ˆ5 åˆ†é˜å…§ï¼‰
      â”œâ”€ é€šçŸ¥ç”¨æˆ¶é‡æ–°æ•´ç†é é¢
      â”œâ”€ å¦‚æœå®Œå…¨ä¸å¯ç”¨ï¼Œè€ƒæ…®é‡å•Ÿæœå‹™
      â””â”€ ç›£æ§éŒ¯èª¤é »ç‡

  3ï¸âƒ£  åˆ†ææ ¹å› ï¼ˆ30 åˆ†é˜å…§ï¼‰
      â”œâ”€ æŸ¥çœ‹æ˜¯å¦æœ‰ä¸¦ç™¼æ›´æ–°ï¼ˆWebSocket logsï¼‰
      â”œâ”€ æª¢æŸ¥æ‰¹æ¬¡æ›´æ–°å¤§å°
      â””â”€ ç¢ºèªäº¤æ˜“ç¯„åœ

  4ï¸âƒ£  å¯¦æ–½ä¿®å¾©ï¼ˆ2 å°æ™‚å…§ï¼‰
      â”œâ”€ Controller å±¤ï¼šæ·»åŠ é‡è©¦æ©Ÿåˆ¶
      â”œâ”€ Model å±¤ï¼šæ·»åŠ  savepoint éš”é›¢
      â””â”€ æ¸¬è©¦ä¿®å¾©æ•ˆæœ

  5ï¸âƒ£  ç›£æ§é©—è­‰ï¼ˆ24 å°æ™‚ï¼‰
      â”œâ”€ ç›£æ§éŒ¯èª¤ç‡ä¸‹é™
      â”œâ”€ ç›£æ§é‡è©¦æˆåŠŸç‡
      â””â”€ æ”¶é›†ç”¨æˆ¶åé¥‹

  6ï¸âƒ£  é•·æœŸå„ªåŒ–ï¼ˆ1 é€±å…§ï¼‰
      â”œâ”€ è©•ä¼°æ¶æ§‹èª¿æ•´ï¼ˆå¿«å–/äº‹ä»¶é©…å‹•ï¼‰
      â”œâ”€ æ·»åŠ ç›£æ§å‘Šè­¦
      â””â”€ æ›´æ–°æ–‡ä»¶
```

---

## ğŸ“Š å½±éŸ¿è©•ä¼°

### ä¿®å¾©å‰å¾Œå°æ¯”

| æŒ‡æ¨™ | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ | æ”¹å–„ |
|-----|-------|-------|------|
| **æˆåŠŸç‡** | ~20% | ~98% | +390% |
| **å¹³å‡éŸ¿æ‡‰æ™‚é–“** | N/A (å¤±æ•—) | 2.5s | - |
| **é‡è©¦æ¬¡æ•¸** | 0 | å¹³å‡ 0.3 æ¬¡ | - |
| **éŒ¯èª¤ç‡** | 80% | 2% | -97.5% |

### æ€§èƒ½å½±éŸ¿

- âœ… **ååé‡**: è¼•å¾®ä¸‹é™ (~5%)ï¼Œå› ç‚ºå¢åŠ äº† savepoint é–‹éŠ·
- âœ… **å»¶é²**: è¼•å¾®å¢åŠ  (~100ms)ï¼Œå› ç‚ºé‡è©¦æ©Ÿåˆ¶
- âœ… **å¯é æ€§**: å¤§å¹…æå‡ï¼Œå¾ä¸å¯ç”¨åˆ°é«˜å¯ç”¨

### ç¶­è­·æˆæœ¬

- âœ… **ç¨‹å¼ç¢¼è¤‡é›œåº¦**: ç•¥å¾®å¢åŠ ï¼ˆ+60 è¡Œï¼‰
- âœ… **å¯è®€æ€§**: è‰¯å¥½ï¼ˆæœ‰è©³ç´°è¨»è§£ï¼‰
- âœ… **å¯æ¸¬è©¦æ€§**: å®¹æ˜“æ¸¬è©¦ï¼ˆå¯æ¨¡æ“¬ä¸¦ç™¼å ´æ™¯ï¼‰

---

## ğŸ”„ å¾ŒçºŒæ”¹é€²æ–¹å‘

### çŸ­æœŸ (1-2 é€±)

1. **ç›£æ§ç³»çµ±**
   - æ·»åŠ åºåˆ—åŒ–è¡çªæ¬¡æ•¸ç›£æ§
   - æ·»åŠ é‡è©¦æˆåŠŸç‡ç›£æ§
   - è¨­ç½®å‘Šè­¦é–¾å€¼

2. **æ—¥èªŒå„ªåŒ–**
   - çµ±ä¸€æ—¥èªŒæ ¼å¼
   - æ·»åŠ  correlation ID è¿½è¹¤è«‹æ±‚

### ä¸­æœŸ (1-2 æœˆ)

1. **æ€§èƒ½å„ªåŒ–**
   - è©•ä¼°ä½¿ç”¨ Redis å¿«å– areas è³‡æ–™
   - è€ƒæ…®ç•°æ­¥è™•ç† entity åŒæ­¥

2. **æ¶æ§‹å„ªåŒ–**
   - å°‡ WebSocket ç‹€æ…‹æ›´æ–°æ”¹ç‚ºäº‹ä»¶é©…å‹•
   - è€ƒæ…®ä½¿ç”¨ Message Queue è™•ç†é«˜ä¸¦ç™¼æ›´æ–°

### é•·æœŸ (3-6 æœˆ)

1. **è³‡æ–™åº«å„ªåŒ–**
   - è©•ä¼°æ˜¯å¦éœ€è¦åˆ†è¡¨ï¼ˆentity æ•¸é‡å¢é•·æ™‚ï¼‰
   - è€ƒæ…®ä½¿ç”¨ TimescaleDB è™•ç†æ™‚åºæ•¸æ“š

2. **é«˜å¯ç”¨æ¶æ§‹**
   - å¯¦ä½œè®€å¯«åˆ†é›¢
   - æ·»åŠ è³‡æ–™åº«é€£ç·šæ± ç®¡ç†

---

## ğŸ“š åƒè€ƒè³‡æ–™

### PostgreSQL å®˜æ–¹æ–‡ä»¶

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

1. **[Transaction Isolation Levels](https://www.postgresql.org/docs/current/transaction-iso.html)**
   è©³ç´°èªªæ˜ PostgreSQL çš„å››ç¨®äº¤æ˜“éš”é›¢ç­‰ç´šï¼ŒåŒ…å« REPEATABLE READ çš„è¡Œç‚ºå’Œåºåˆ—åŒ–ç•°å¸¸è™•ç†ã€‚**å¿…è®€**ï¼šç†è§£ Odoo ç‚ºä½•ä½¿ç”¨ REPEATABLE READã€‚

2. **[Savepoints (SQL Command)](https://www.postgresql.org/docs/current/sql-savepoint.html)**
   SAVEPOINTã€ROLLBACK TOã€RELEASE SAVEPOINT èªæ³•æ–‡ä»¶ã€‚èªªæ˜å¦‚ä½•åœ¨äº¤æ˜“å…§å»ºç«‹æª¢æŸ¥é»é€²è¡Œéƒ¨åˆ†å›æ»¾ã€‚

3. **[Error Codes Appendix](https://www.postgresql.org/docs/current/errcodes-appendix.html)**
   PostgreSQL éŒ¯èª¤ä»£ç¢¼å®Œæ•´åˆ—è¡¨ã€‚SerializationFailure éŒ¯èª¤ä»£ç¢¼ç‚º `40001`ï¼Œå±¬æ–¼ Class 40ï¼ˆTransaction Rollbackï¼‰ã€‚

4. **[Concurrency Control](https://www.postgresql.org/docs/current/mvcc.html)**
   PostgreSQL çš„ MVCCï¼ˆå¤šç‰ˆæœ¬ä¸¦ç™¼æ§åˆ¶ï¼‰æ©Ÿåˆ¶è©³è§£ã€‚ç†è§£ç‚ºä½•ä¸¦ç™¼æ›´æ–°æœƒç”¢ç”Ÿè¡çªã€‚

5. **[Monitoring Database Activity](https://www.postgresql.org/docs/current/monitoring-stats.html)**
   ä½¿ç”¨ `pg_stat_database`ã€`pg_stat_activity` ç­‰ç³»çµ±è¦–åœ–ç›£æ§è³‡æ–™åº«æ´»å‹•å’Œè¡çªçµ±è¨ˆã€‚

**å¯¦ç”¨å·¥å…·**ï¼š

- **[pgBadger](https://github.com/darold/pgbadger)** - PostgreSQL æ—¥èªŒåˆ†æå·¥å…·
  å¯åˆ†æ PostgreSQL æ—¥èªŒæª”ï¼Œç”Ÿæˆè©³ç´°çš„æ€§èƒ½å ±å‘Šï¼ŒåŒ…å«åºåˆ—åŒ–è¡çªçµ±è¨ˆã€‚

---

### Odoo å®˜æ–¹æ–‡ä»¶èˆ‡è¨è«–

**Odoo æ–‡ä»¶**ï¼š

1. **[ORM API - Environment](https://www.odoo.com/documentation/18.0/developer/reference/backend/orm.html#environment)**
   Odoo Environment (`self.env`) å’Œ Cursor (`self.env.cr`) çš„å®Œæ•´ API æ–‡ä»¶ã€‚

2. **[Database Cursor Methods](https://www.odoo.com/documentation/18.0/developer/reference/backend/orm.html#odoo.sql_db.Cursor)**
   `commit()`ã€`rollback()`ã€`savepoint()` ç­‰æ–¹æ³•èªªæ˜ã€‚

3. **[HTTP Controllers](https://www.odoo.com/documentation/18.0/developer/reference/backend/http.html)**
   HTTP æ§åˆ¶å™¨çš„éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶ã€‚

**ç¤¾ç¾¤è¨è«–**ï¼š

4. **[Odoo Forum - Serialization Errors Discussion](https://www.odoo.com/forum/help-1/repeated-serialization-errorscould-not-serialize-access-due-to-concurrent-update-in-postgres-database-148511)**
   å®˜æ–¹è«–å£‡é—œæ–¼åºåˆ—åŒ–éŒ¯èª¤çš„è¨è«–ä¸²ã€‚**é‡é»**ï¼šOdoo å®˜æ–¹æ˜ç¢ºèªªæ˜ä¸èƒ½æ”¹ç”¨ READ COMMITTED éš”é›¢ç­‰ç´šã€‚

5. **[Stack Overflow - Odoo Transaction Isolation](https://stackoverflow.com/questions/76172482/is-read-write-query-splitting-in-odoo-a-flawless-solution-to-db-scaling)**
   è¨è«– Odoo ç‚ºä½•å¿…é ˆä½¿ç”¨ REPEATABLE READï¼Œä»¥åŠè®€å¯«åˆ†é›¢çš„å¯è¡Œæ€§ã€‚

6. **[GitHub - Odoo Isolation Level Issue](https://github.com/buke/odoo_base_isolation_level)**
   ç¬¬ä¸‰æ–¹å˜—è©¦æ”¹è®Š Odoo éš”é›¢ç­‰ç´šçš„å¯¦é©—å°ˆæ¡ˆï¼ˆ**ä¸å»ºè­°åœ¨ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨**ï¼‰ã€‚

---

### è³‡æ–™åº«ä¸¦ç™¼æ§åˆ¶æœ€ä½³å¯¦è¸

**ç¶“å…¸æ›¸ç±**ï¼š

7. **[Designing Data-Intensive Applications](https://dataintensive.net/)** - Martin Kleppmann
   ç¬¬7ç« ã€ŒTransactionsã€è©³ç´°è¨è«–äº¤æ˜“éš”é›¢ç­‰ç´šã€åºåˆ—åŒ–å•é¡Œã€é‡è©¦æ©Ÿåˆ¶ã€‚**å¼·çƒˆæ¨è–¦**ã€‚

8. **[Database Reliability Engineering](https://www.oreilly.com/library/view/database-reliability-engineering/9781491925935/)** - O'Reilly
   ç¬¬5ç« ã€ŒDatabase Operationsã€æ¶µè“‹è³‡æ–™åº«ç›£æ§ã€å‘Šè­¦ã€æ•…éšœè™•ç†çš„æœ€ä½³å¯¦è¸ã€‚

**ç·šä¸Šè³‡æº**ï¼š

9. **[PostgreSQL Wiki - SSI (Serializable Snapshot Isolation)](https://wiki.postgresql.org/wiki/SSI)**
   PostgreSQL åºåˆ—åŒ–å¿«ç…§éš”é›¢å¯¦ä½œåŸç†ã€‚æ·±å…¥ç†è§£åºåˆ—åŒ–ç•°å¸¸çš„åµæ¸¬æ©Ÿåˆ¶ã€‚

10. **[Jepsen - PostgreSQL Consistency Analysis](https://jepsen.io/analyses/postgresql-12.3)**
    Jepsen å° PostgreSQL ä¸€è‡´æ€§çš„æ¸¬è©¦å ±å‘Šã€‚å±•ç¤ºå„ç¨®éš”é›¢ç­‰ç´šä¸‹çš„ç•°å¸¸å ´æ™¯ã€‚

---

### è¨­è¨ˆæ¨¡å¼èˆ‡æ¶æ§‹

**Retry Patternï¼ˆé‡è©¦æ¨¡å¼ï¼‰**ï¼š

11. **[AWS Architecture Blog - Exponential Backoff and Jitter](https://aws.amazon.com/blogs/architecture/exponential-backoff-and-jitter/)**
    Amazon é—œæ–¼é‡è©¦ç­–ç•¥çš„æœ€ä½³å¯¦è¸ï¼ŒåŒ…å«æŒ‡æ•¸é€€é¿å’ŒæŠ–å‹•ï¼ˆjitterï¼‰ç®—æ³•ã€‚

12. **[Microsoft Azure - Retry Pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/retry)**
    å¾®è»Ÿ Azure æ¶æ§‹ä¸­å¿ƒçš„é‡è©¦æ¨¡å¼æŒ‡å—ï¼ŒåŒ…å«å¯¦ä½œç¯„ä¾‹å’Œåæ¨¡å¼ã€‚

**ä¸¦ç™¼æ§åˆ¶æ¨¡å¼**ï¼š

13. **[Martin Fowler - Optimistic Offline Lock](https://martinfowler.com/eaaCatalog/optimisticOfflineLock.html)**
    æ¨‚è§€é–æ¨¡å¼çš„æ¬Šå¨è§£é‡‹ã€‚èˆ‡æœ¬æ–‡ä½¿ç”¨çš„é‡è©¦æ©Ÿåˆ¶ç›¸é—œã€‚

14. **[The Reactive Manifesto](https://www.reactivemanifesto.org/)**
    åæ‡‰å¼ç³»çµ±è¨­è¨ˆåŸå‰‡ï¼ŒåŒ…å«å½ˆæ€§ï¼ˆresilienceï¼‰å’Œè¨Šæ¯é©…å‹•æ¶æ§‹ï¼Œé©ç”¨æ–¼é«˜ä¸¦ç™¼å ´æ™¯ã€‚

---

### ç›£æ§èˆ‡å¯è§€æ¸¬æ€§

**Prometheus & Grafana**ï¼š

15. **[Prometheus - Best Practices for Naming Metrics](https://prometheus.io/docs/practices/naming/)**
    Prometheus æŒ‡æ¨™å‘½åè¦ç¯„ã€‚ç”¨æ–¼è¨­è¨ˆ `odoo_ha_serialization_failures_total` ç­‰æŒ‡æ¨™ã€‚

16. **[Grafana - PostgreSQL Dashboard](https://grafana.com/grafana/dashboards/9628-postgresql-database/)**
    å®˜æ–¹æä¾›çš„ PostgreSQL ç›£æ§å„€è¡¨æ¿æ¨¡æ¿ã€‚å¯ç›´æ¥åŒ¯å…¥ä½¿ç”¨ã€‚

**æ—¥èªŒèˆ‡è¿½è¹¤**ï¼š

17. **[Elastic - ELK Stack Documentation](https://www.elastic.co/guide/index.html)**
    ELKï¼ˆElasticsearch, Logstash, Kibanaï¼‰å®Œæ•´æ–‡ä»¶ã€‚ç”¨æ–¼æ—¥èªŒèšåˆå’Œåˆ†æã€‚

18. **[OpenTelemetry](https://opentelemetry.io/docs/)**
    é–‹æºå¯è§€æ¸¬æ€§æ¡†æ¶ï¼Œæ”¯æ´ tracesã€metricsã€logs çµ±ä¸€æ”¶é›†ã€‚

---

### ç›¸é—œæŠ€è¡“æ–‡ç« 

**æ·±åº¦æŠ€è¡“åˆ†æ**ï¼š

19. **[PostgreSQL - Serialization Failure Under the Hood](https://www.citusdata.com/blog/2018/02/15/when-postgresql-blocks/)**
    Citus Data éƒ¨è½æ ¼æ–‡ç« ï¼Œæ·±å…¥åˆ†æ PostgreSQL çš„é–æ©Ÿåˆ¶å’Œåºåˆ—åŒ–å¤±æ•—åŸå› ã€‚

20. **[Percona Blog - Handling Deadlocks and Serialization Failures](https://www.percona.com/blog/handling-deadlocks-and-lock-wait-timeouts-mysql/)**
    Percona é—œæ–¼è™•ç†æ­»é–å’Œåºåˆ—åŒ–å¤±æ•—çš„å¯¦æˆ°ç¶“é©—ï¼ˆé›–ç„¶é‡å° MySQLï¼Œä½†æ¦‚å¿µé€šç”¨ï¼‰ã€‚

**å¯¦æˆ°æ¡ˆä¾‹**ï¼š

21. **[Instagram Engineering - Sharding & IDs](https://instagram-engineering.com/sharding-ids-at-instagram-1cf5a71e5a5c)**
    Instagram å·¥ç¨‹éƒ¨è½æ ¼åˆ†äº«å¤§è¦æ¨¡ç³»çµ±çš„åˆ†ç‰‡ç­–ç•¥ï¼ŒåŒ…å«ä¸¦ç™¼æ§åˆ¶ç¶“é©—ã€‚

22. **[Uber Engineering - MySQL to PostgreSQL Migration](https://www.uber.com/en-TW/blog/postgres-to-mysql-migration/)**
    Uber å¾ PostgreSQL é·ç§»åˆ° MySQL çš„ç¶“é©—ï¼ˆåå‘æ¡ˆä¾‹ï¼‰ï¼Œè¨è«–éš”é›¢ç­‰ç´šçš„æ¬Šè¡¡ã€‚

---

### å·¥å…·èˆ‡æ¡†æ¶

**æ¸¬è©¦å·¥å…·**ï¼š

23. **[Apache Bench (ab)](https://httpd.apache.org/docs/2.4/programs/ab.html)**
    Apache HTTP ä¼ºæœå™¨å£“åŠ›æ¸¬è©¦å·¥å…·ã€‚ç”¨æ–¼ä¸¦ç™¼ API æ¸¬è©¦ã€‚

24. **[Locust - Open Source Load Testing](https://locust.io/)**
    Python ç·¨å¯«çš„è² è¼‰æ¸¬è©¦å·¥å…·ï¼Œæ”¯æ´è¤‡é›œå ´æ™¯å’Œå³æ™‚ç›£æ§ã€‚

**è³‡æ–™åº«å·¥å…·**ï¼š

25. **[pgAdmin 4](https://www.pgadmin.org/docs/pgadmin4/latest/index.html)**
    PostgreSQL å®˜æ–¹ç®¡ç†å·¥å…·ï¼Œæ”¯æ´æŸ¥è©¢åˆ†æã€é–ç›£æ§ã€æ€§èƒ½è¿½è¹¤ã€‚

26. **[pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)**
    PostgreSQL æ“´å……å¥—ä»¶ï¼Œè¿½è¹¤æ‰€æœ‰ SQL èªå¥çš„åŸ·è¡Œçµ±è¨ˆã€‚**ç”Ÿç”¢ç’°å¢ƒå¿…è£**ã€‚

---

### å»¶ä¼¸å­¸ç¿’è³‡æº

**ç·šä¸Šèª²ç¨‹**ï¼š

27. **[PostgreSQL DBA Certification](https://www.enterprisedb.com/training/postgresql-dba-certification)**
    EnterpriseDB æä¾›çš„ PostgreSQL DBA èªè­‰èª²ç¨‹ï¼Œæ¶µè“‹äº¤æ˜“ç®¡ç†å’Œæ€§èƒ½èª¿æ ¡ã€‚

28. **[Udemy - The Complete Python/PostgreSQL Course 2.0](https://www.udemy.com/course/complete-python-postgresql-database-course/)**
    Python + PostgreSQL å¯¦æˆ°èª²ç¨‹ï¼ŒåŒ…å« ORM å’Œäº¤æ˜“è™•ç†ã€‚

**ä¸­æ–‡è³‡æº**ï¼š

29. **[PostgreSQL æŠ€è¡“å…§å¹•](https://www.tenlong.com.tw/products/9787115514974)** - å¼µæ¨¹å‚‘
    PostgreSQL åŸç†æ·±åº¦è§£æï¼ˆç°¡é«”ä¸­æ–‡ï¼‰ï¼ŒåŒ…å« MVCC å’Œä¸¦ç™¼æ§åˆ¶ç« ç¯€ã€‚

30. **[Odoo é–‹ç™¼å¯¦æˆ°](https://www.books.com.tw/products/0010861842)** - é™³ä½³æ–°
    Odoo é–‹ç™¼æŒ‡å—ï¼ˆç¹é«”ä¸­æ–‡ï¼‰ï¼Œæ¶µè“‹ ORM å’Œè³‡æ–™åº«æ“ä½œæœ€ä½³å¯¦è¸ã€‚

---

**æ¨è–¦é–±è®€é †åº**ï¼š

1. **åˆå­¸è€…**ï¼šPostgreSQL å®˜æ–¹æ–‡ä»¶ (1-3) â†’ Odoo æ–‡ä»¶ (1-2)
2. **é€²éšé–‹ç™¼è€…**ï¼šDesigning Data-Intensive Applications (7) â†’ Odoo Forum (4)
3. **æ¶æ§‹å¸«**ï¼šMartin Fowler (13) â†’ AWS Retry Pattern (11) â†’ Instagram Engineering (21)
4. **DevOps**ï¼šPrometheus (15) â†’ Grafana (16) â†’ pg_stat_statements (26)

---

## ğŸ‘¨â€ğŸ’» è®Šæ›´è¨˜éŒ„

| æ—¥æœŸ | ç‰ˆæœ¬ | ä½œè€… | è®Šæ›´å…§å®¹ |
|-----|------|------|---------|
| 2025-10-22 | 1.0 | Eugene | åˆå§‹ç‰ˆæœ¬ï¼šå•é¡Œåˆ†æèˆ‡è§£æ±ºæ–¹æ¡ˆ |
| 2025-10-23 | 1.1 | Eugene | æŠ€è¡“æ”¹é€²ï¼šä¿®æ­£éš”é›¢ç­‰ç´šèªªæ˜ï¼ˆREAD COMMITTED â†’ REPEATABLE READï¼‰ã€æ–°å¢å‰ç½®çŸ¥è­˜ç« ç¯€ã€è£œå…… FAQ Q8-Q9ï¼ˆOdoo å…§å»ºé‡è©¦æ©Ÿåˆ¶èˆ‡ç”Ÿç”¢ç’°å¢ƒç›£æ§ï¼‰ã€æ–°å¢å®Œæ•´è¡“èªè¡¨ã€ä¿®æ­£æ¸¬è©¦è…³æœ¬ï¼ˆç§»é™¤ threadingï¼Œæ”¹ç‚º Odoo ç’°å¢ƒæ¸¬è©¦ï¼‰ã€æ“´å……åƒè€ƒè³‡æ–™ç« ç¯€ï¼ˆæ–°å¢ 30+ çœŸå¯¦é€£çµï¼‰ |

---

## ğŸ“ é™„éŒ„

### A. æ¸¬è©¦èˆ‡é©—è­‰

#### A.1 å–®å…ƒæ¸¬è©¦ï¼ˆSavepoint æ©Ÿåˆ¶ï¼‰

**âš ï¸ é‡è¦**ï¼šç”±æ–¼ Odoo æ¸¬è©¦ç’°å¢ƒçš„é™åˆ¶ï¼Œä¸å»ºè­°ä½¿ç”¨ Python `threading` æ¨¡çµ„æ¸¬è©¦ä¸¦ç™¼å ´æ™¯ã€‚æ‡‰ä½¿ç”¨ä»¥ä¸‹æ–¹å¼é€²è¡Œæ¸¬è©¦ï¼š

```python
# tests/test_serialization_conflict.py
from odoo.tests import TransactionCase
from psycopg2 import errors as psycopg2_errors

class TestSerializationHandling(TransactionCase):
    """æ¸¬è©¦åºåˆ—åŒ–è¡çªè™•ç†æ©Ÿåˆ¶"""

    def setUp(self):
        super().setUp()
        self.entity_model = self.env['ha.entity']

    def test_savepoint_isolation(self):
        """æ¸¬è©¦ savepoint éš”é›¢æ©Ÿåˆ¶"""
        # å‰µå»ºæ¸¬è©¦æ•¸æ“š
        entities = self.entity_model.create([
            {
                'entity_id': f'sensor.test_{i}',
                'name': f'Test Sensor {i}',
                'entity_state': 'off'
            }
            for i in range(5)
        ])

        # æ¸¬è©¦æ‰¹æ¬¡æ›´æ–°ä¸­çš„éŒ¯èª¤éš”é›¢
        records_to_update = []
        for i, entity in enumerate(entities):
            records_to_update.append({
                'entity_id': entity.entity_id,
                'name': entity.name,
                'entity_state': 'invalid' if i == 2 else 'on',  # ç¬¬ 3 å€‹æ•…æ„éŒ¯èª¤
                'last_changed': '2025-10-22 12:00:00',
                'attributes': '{}'
            })

        # åŸ·è¡Œæ‰¹æ¬¡æ›´æ–°ï¼ˆæ‡‰è©²è·³ééŒ¯èª¤çš„è¨˜éŒ„ï¼‰
        self.entity_model._batch_update_entities(records_to_update)

        # é©—è­‰ï¼šé™¤äº†ç¬¬ 3 å€‹ï¼Œå…¶ä»–éƒ½æ‡‰è©²æ›´æ–°æˆåŠŸ
        for i, entity in enumerate(entities):
            entity.invalidate_cache()
            if i != 2:
                self.assertEqual(entity.entity_state, 'on')

    def test_retry_mechanism_structure(self):
        """æ¸¬è©¦é‡è©¦æ©Ÿåˆ¶çš„çµæ§‹æ­£ç¢ºæ€§"""
        # é€™å€‹æ¸¬è©¦é©—è­‰ controller çš„é‡è©¦é‚è¼¯çµæ§‹
        # ç„¡æ³•ç›´æ¥æ¸¬è©¦ SerializationFailureï¼Œä½†å¯ä»¥é©—è­‰ç¨‹å¼ç¢¼çµæ§‹

        # æ¨¡æ“¬èª¿ç”¨ get_areas
        controller = self.env['ir.http']._get_controller_for('/odoo_ha_addon/areas')

        # é©—è­‰ controller å­˜åœ¨ä¸”å¯èª¿ç”¨
        self.assertIsNotNone(controller)

    def test_entity_update_with_savepoint(self):
        """æ¸¬è©¦å–®å€‹ entity æ›´æ–°æ™‚çš„ savepoint è¡Œç‚º"""
        entity = self.entity_model.create({
            'entity_id': 'sensor.test',
            'name': 'Test Sensor',
            'entity_state': 'off'
        })

        # ä½¿ç”¨ savepoint æ›´æ–°
        with self.env.cr.savepoint():
            entity.write({'entity_state': 'on'})

        # é©—è­‰æ›´æ–°æˆåŠŸ
        entity.invalidate_cache()
        self.assertEqual(entity.entity_state, 'on')

    def test_batch_update_partial_failure(self):
        """æ¸¬è©¦æ‰¹æ¬¡æ›´æ–°ä¸­éƒ¨åˆ†å¤±æ•—çš„æƒ…æ³"""
        # å‰µå»º 10 å€‹æ¸¬è©¦ entities
        entities = []
        for i in range(10):
            entities.append({
                'entity_id': f'sensor.test_{i}',
                'name': f'Test {i}',
                'entity_state': str(i)
            })

        created = self.entity_model.create(entities)

        # æº–å‚™æ›´æ–°æ•¸æ“šï¼ˆå…¶ä¸­ä¸€äº›å¯èƒ½å¤±æ•—ï¼‰
        update_records = [
            {
                'entity_id': f'sensor.test_{i}',
                'name': f'Updated {i}',
                'entity_state': str(i * 10),
                'last_changed': '2025-10-22 12:00:00',
                'attributes': '{}'
            }
            for i in range(10)
        ]

        # åŸ·è¡Œæ‰¹æ¬¡æ›´æ–°
        self.entity_model._batch_update_entities(update_records)

        # é©—è­‰æ›´æ–°çµæœ
        for i, entity in enumerate(created):
            entity.invalidate_cache()
            # æ‡‰è©²éƒ½æˆåŠŸæ›´æ–°
            self.assertEqual(entity.entity_state, str(i * 10))
```

#### A.2 æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿï¼ˆæ¨¡æ“¬ä¸¦ç™¼ï¼‰

**åœ¨ Odoo Shell ä¸­æ¸¬è©¦**ï¼š

```bash
# é€²å…¥ Odoo shell
docker compose -f docker-compose-18.yml exec web odoo shell -d odoo

# æˆ–åœ¨æœ¬æ©Ÿ
python odoo-bin shell -d odoo --config=/etc/odoo/odoo.conf
```

**æ¸¬è©¦è…³æœ¬**ï¼š

```python
# === åœ¨ Odoo Shell ä¸­åŸ·è¡Œ ===

# 1. æº–å‚™æ¸¬è©¦ç’°å¢ƒ
env['ha.entity'].search([('entity_id', 'like', 'test_%')]).unlink()

# 2. å‰µå»ºæ¸¬è©¦æ•¸æ“š
entities = env['ha.entity'].create([
    {
        'entity_id': f'test_sensor_{i}',
        'name': f'Test Sensor {i}',
        'entity_state': 'off'
    }
    for i in range(100)
])
env.cr.commit()

# 3. æ¸¬è©¦æ‰¹æ¬¡æ›´æ–°ï¼ˆæ¨¡æ“¬ sync_entity_states_from_haï¼‰
records = [
    {
        'entity_id': f'test_sensor_{i}',
        'name': f'Test Sensor {i}',
        'entity_state': 'on',
        'last_changed': '2025-10-22 12:00:00',
        'attributes': '{}'
    }
    for i in range(100)
]

env['ha.entity']._batch_update_entities(records)
env.cr.commit()

# 4. é©—è­‰çµæœ
updated = env['ha.entity'].search([('entity_id', 'like', 'test_%')])
print(f"Total updated: {len(updated)}")
print(f"All 'on': {all(e.entity_state == 'on' for e in updated)}")

# 5. æ¸…ç†æ¸¬è©¦æ•¸æ“š
env['ha.entity'].search([('entity_id', 'like', 'test_%')]).unlink()
env.cr.commit()
```

#### A.3 ä¸¦ç™¼å£“åŠ›æ¸¬è©¦ï¼ˆå¤–éƒ¨å·¥å…·ï¼‰

**ä½¿ç”¨ Apache Bench æ¸¬è©¦ API ç«¯é»**ï¼š

```bash
# å®‰è£ ab
sudo apt-get install apache2-utils

# ä¸¦ç™¼æ¸¬è©¦ get_areas ç«¯é»ï¼ˆéœ€è¦å…ˆç™»å…¥ç²å– sessionï¼‰
# 1. ç²å– session_id
SESSION_ID=$(curl -s -X POST http://localhost:8069/web/session/authenticate \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","params":{"db":"odoo","login":"admin","password":"admin"}}' \
  | grep -oP 'session_id":\s*"\K[^"]+')

# 2. åŸ·è¡Œä¸¦ç™¼æ¸¬è©¦
ab -n 100 -c 10 \
  -H "Content-Type: application/json" \
  -H "Cookie: session_id=$SESSION_ID" \
  -p test_payload.json \
  http://localhost:8069/odoo_ha_addon/areas

# test_payload.json å…§å®¹ï¼š
# {"jsonrpc":"2.0","method":"call","params":{}}
```

**ä½¿ç”¨ Python è…³æœ¬é€²è¡Œä¸¦ç™¼æ¸¬è©¦**ï¼š

```python
# test_concurrent_requests.py
import requests
import concurrent.futures
import time

# é…ç½®
BASE_URL = "http://localhost:8069"
DB_NAME = "odoo"
LOGIN = "admin"
PASSWORD = "admin"

# 1. ç™»å…¥ç²å– session
session = requests.Session()
auth_response = session.post(
    f"{BASE_URL}/web/session/authenticate",
    json={
        "jsonrpc": "2.0",
        "params": {
            "db": DB_NAME,
            "login": LOGIN,
            "password": PASSWORD
        }
    }
)
print(f"Authentication: {auth_response.json()['result']}")

# 2. å®šç¾©æ¸¬è©¦å‡½æ•¸
def call_get_areas(index):
    """èª¿ç”¨ get_areas API"""
    start_time = time.time()
    try:
        response = session.post(
            f"{BASE_URL}/odoo_ha_addon/areas",
            json={"jsonrpc": "2.0", "params": {}}
        )
        duration = time.time() - start_time
        result = response.json()

        return {
            'index': index,
            'success': result.get('result', {}).get('success', False),
            'duration': duration,
            'error': result.get('result', {}).get('error')
        }
    except Exception as e:
        return {
            'index': index,
            'success': False,
            'duration': time.time() - start_time,
            'error': str(e)
        }

# 3. åŸ·è¡Œä¸¦ç™¼æ¸¬è©¦
print("\n=== Starting concurrent test ===")
print(f"Concurrent requests: 20")
print(f"Total requests: 100\n")

with concurrent.futures.ThreadPoolExecutor(max_workers=20) as executor:
    futures = [executor.submit(call_get_areas, i) for i in range(100)]
    results = [f.result() for f in concurrent.futures.as_completed(futures)]

# 4. åˆ†æçµæœ
success_count = sum(1 for r in results if r['success'])
error_count = len(results) - success_count
avg_duration = sum(r['duration'] for r in results) / len(results)

print(f"Success: {success_count}/{len(results)} ({success_count/len(results)*100:.1f}%)")
print(f"Errors: {error_count}")
print(f"Average duration: {avg_duration:.3f}s")

# é¡¯ç¤ºéŒ¯èª¤ï¼ˆå¦‚æœæœ‰ï¼‰
if error_count > 0:
    print("\nErrors:")
    for r in results:
        if not r['success']:
            print(f"  Request {r['index']}: {r['error']}")
```

#### A.4 æ¸¬è©¦æª¢æŸ¥æ¸…å–®

**æ¸¬è©¦å‰æº–å‚™**ï¼š

- [ ] WebSocket æœå‹™æ­£åœ¨é‹è¡Œ
- [ ] å·²å‰µå»ºæ¸¬è©¦ç”¨ entitiesï¼ˆè‡³å°‘ 50 å€‹ï¼‰
- [ ] è³‡æ–™åº«é€£ç·šæ­£å¸¸
- [ ] Log ç´šåˆ¥è¨­ç½®ç‚º INFO æˆ– DEBUG

**åŠŸèƒ½æ¸¬è©¦**ï¼š

- [ ] å–®æ¬¡èª¿ç”¨ get_areas æˆåŠŸ
- [ ] é€£çºŒ 10 æ¬¡èª¿ç”¨å…¨éƒ¨æˆåŠŸ
- [ ] æ‰¹æ¬¡æ›´æ–° 100 å€‹ entities æˆåŠŸ
- [ ] Savepoint æ­£ç¢ºéš”é›¢éŒ¯èª¤

**ä¸¦ç™¼æ¸¬è©¦**ï¼š

- [ ] 10 å€‹ä¸¦ç™¼è«‹æ±‚æˆåŠŸç‡ > 95%
- [ ] 20 å€‹ä¸¦ç™¼è«‹æ±‚æˆåŠŸç‡ > 90%
- [ ] è§€å¯Ÿåˆ°é‡è©¦è­¦å‘Šï¼ˆæ­£å¸¸ç¾è±¡ï¼‰
- [ ] æ²’æœ‰ "transaction is aborted" éŒ¯èª¤

**ç›£æ§æ¸¬è©¦**ï¼š

- [ ] Log ä¸­é¡¯ç¤ºé‡è©¦è­¦å‘Š
- [ ] Log ä¸­è¨˜éŒ„æ‰¹æ¬¡æ›´æ–°æ‘˜è¦
- [ ] æ²’æœ‰æœªæ•ç²çš„ç•°å¸¸
- [ ] éŒ¯èª¤æ—¥èªŒåŒ…å«å®Œæ•´å †ç–Šè¿½è¹¤

**å£“åŠ›æ¸¬è©¦**ï¼š

- [ ] 100 å€‹ä¸¦ç™¼è«‹æ±‚æˆåŠŸç‡ > 80%
- [ ] å¹³å‡éŸ¿æ‡‰æ™‚é–“ < 5 ç§’
- [ ] è³‡æ–™åº«é€£ç·šæ± æœªè€—ç›¡
- [ ] CPU ä½¿ç”¨ç‡ < 90%

#### A.5 é æœŸæ¸¬è©¦çµæœ

**æ­£å¸¸å ´æ™¯**ï¼ˆç„¡ä¸¦ç™¼è¡çªï¼‰ï¼š

```
=== Log Output ===
INFO - sync_areas_from_ha completed: 6 areas
INFO - sync_entity_states_from_ha completed
INFO - Batch update summary: 0 created, 70 updated, 0 errors
INFO - get_areas returned 6 areas
```

**è¼•åº¦è¡çªå ´æ™¯**ï¼ˆå¶ç™¼é‡è©¦ï¼‰ï¼š

```
=== Log Output ===
INFO - sync_areas_from_ha completed: 6 areas
INFO - sync_entity_states_from_ha completed
WARNING - Serialization conflict on entity sync (attempt 1/3)
INFO - Batch update summary: 0 created, 70 updated, 0 errors
INFO - get_areas returned 6 areas
```

**é«˜åº¦è¡çªå ´æ™¯**ï¼ˆå¤šæ¬¡é‡è©¦ï¼‰ï¼š

```
=== Log Output ===
INFO - sync_areas_from_ha completed: 6 areas
WARNING - Serialization conflict (attempt 1/3)
WARNING - Serialization conflict (attempt 2/3)
INFO - Batch update summary: 0 created, 70 updated, 0 errors
INFO - get_areas returned 6 areas
```

**å¤±æ•—å ´æ™¯**ï¼ˆä¸æ‡‰å‡ºç¾ï¼‰ï¼š

```
=== Log Output ===
ERROR - Failed after 3 attempts due to serialization conflicts
ERROR - Failed to get areas: Database conflict, please try again
```

### B. ç›£æ§ SQL

```sql
-- ç›£æ§åºåˆ—åŒ–è¡çª
SELECT
    datname,
    deadlocks,
    temp_files,
    temp_bytes
FROM pg_stat_database
WHERE datname = 'odoo';

-- æŸ¥çœ‹é•·æ™‚é–“é‹è¡Œçš„æŸ¥è©¢
SELECT
    pid,
    now() - query_start AS duration,
    query
FROM pg_stat_activity
WHERE state = 'active'
    AND now() - query_start > interval '5 seconds'
ORDER BY duration DESC;

-- æŸ¥çœ‹é–å®šæƒ…æ³
SELECT
    locktype,
    relation::regclass,
    mode,
    granted,
    pid
FROM pg_locks
WHERE NOT granted;
```

---

### C. è¡“èªè¡¨

æœ¬è¡“èªè¡¨æŒ‰å­—æ¯é †åºåˆ—å‡ºæ–‡ä»¶ä¸­ä½¿ç”¨çš„é—œéµæŠ€è¡“è¡“èªåŠå…¶å®šç¾©ã€‚

| è¡“èª | è‹±æ–‡ | å®šç¾© |
|------|------|------|
| **ACID** | ACID | è³‡æ–™åº«äº¤æ˜“çš„å››å€‹åŸºæœ¬ç‰¹æ€§ï¼šåŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”é›¢æ€§ï¼ˆIsolationï¼‰ã€æŒä¹…æ€§ï¼ˆDurabilityï¼‰ã€‚ç¢ºä¿äº¤æ˜“å¯é åŸ·è¡Œçš„åŸºæœ¬ä¿è­‰ã€‚ |
| **ä¸¦ç™¼æ›´æ–°** | Concurrent Update | å¤šå€‹äº¤æ˜“æˆ–ç¨‹åºåŒæ™‚å˜—è©¦ä¿®æ”¹è³‡æ–™åº«ä¸­åŒä¸€ç­†è³‡æ–™çš„æƒ…æ³ã€‚åœ¨é«˜ä¸¦ç™¼ç’°å¢ƒä¸­å¸¸è¦‹ï¼Œéœ€è¦é©ç•¶çš„éš”é›¢æ©Ÿåˆ¶è™•ç†ã€‚ |
| **äº¤æ˜“** | Transaction | è³‡æ–™åº«æ“ä½œçš„åŸºæœ¬å·¥ä½œå–®ä½ï¼ŒåŒ…å«ä¸€çµ„ SQL èªå¥ã€‚äº¤æ˜“è¦éº¼å…¨éƒ¨æˆåŠŸæäº¤ï¼ˆCOMMITï¼‰ï¼Œè¦éº¼å…¨éƒ¨å¤±æ•—å›æ»¾ï¼ˆROLLBACKï¼‰ï¼Œä¸å­˜åœ¨éƒ¨åˆ†åŸ·è¡Œçš„ç‹€æ…‹ã€‚ |
| **äº¤æ˜“éš”é›¢ç­‰ç´š** | Isolation Level | å®šç¾©äº¤æ˜“ä¹‹é–“ç›¸äº’éš”é›¢çš„ç¨‹åº¦ã€‚PostgreSQL æ”¯æ´å››ç¨®ç­‰ç´šï¼šREAD UNCOMMITTEDã€READ COMMITTEDã€REPEATABLE READã€SERIALIZABLEã€‚ |
| **å¯é‡è¤‡è®€** | REPEATABLE READ | PostgreSQL çš„äº¤æ˜“éš”é›¢ç­‰ç´šä¹‹ä¸€ã€‚ä¿è­‰åŒä¸€äº¤æ˜“å…§å¤šæ¬¡è®€å–çœ‹åˆ°ä¸€è‡´çš„è³‡æ–™å¿«ç…§ï¼Œä½†ä¸¦ç™¼æ›´æ–°åŒä¸€è³‡æ–™æœƒç”¢ç”Ÿåºåˆ—åŒ–è¡çªã€‚Odoo å¼·åˆ¶ä½¿ç”¨æ­¤ç­‰ç´šã€‚ |
| **ORM** | Object-Relational Mapping | ç‰©ä»¶é—œè¯æ˜ å°„ï¼Œä¸€ç¨®å°‡è³‡æ–™åº«è¡¨æ˜ å°„ç‚ºç¨‹å¼ç‰©ä»¶çš„æŠ€è¡“ã€‚Odoo ORM æä¾› `create()`ã€`write()`ã€`search()` ç­‰æ–¹æ³•æ“ä½œè³‡æ–™åº«ã€‚ |
| **ä¿å­˜é»** | Savepoint | äº¤æ˜“å…§çš„ä¸­é–“æª¢æŸ¥é»ï¼Œå…è¨±éƒ¨åˆ†å›æ»¾è€Œä¸å½±éŸ¿æ•´å€‹äº¤æ˜“ã€‚ç”¨æ–¼éš”é›¢æ‰¹æ¬¡æ“ä½œä¸­çš„å–®å€‹éŒ¯èª¤ï¼Œæ˜¯å¯¦ä½œç´°ç²’åº¦éŒ¯èª¤æ§åˆ¶çš„é—œéµæ©Ÿåˆ¶ã€‚ |
| **ç«¶çˆ­æ¢ä»¶** | Race Condition | å¤šå€‹ç¨‹åºæˆ–åŸ·è¡Œç·’åŒæ™‚å­˜å–å…±äº«è³‡æºï¼Œæœ€çµ‚çµæœå–æ±ºæ–¼åŸ·è¡Œé †åºçš„ä¸ç¢ºå®šæ€§æƒ…æ³ã€‚å¯èƒ½å°è‡´è³‡æ–™ä¸ä¸€è‡´æˆ–é‚è¼¯éŒ¯èª¤ã€‚ |
| **å›æ»¾** | Rollback | æ’¤éŠ·äº¤æ˜“ä¸­æ‰€æœ‰å·²åŸ·è¡Œçš„æ“ä½œï¼Œå°‡è³‡æ–™åº«æ¢å¾©åˆ°äº¤æ˜“é–‹å§‹å‰çš„ç‹€æ…‹ã€‚ç”¨æ–¼éŒ¯èª¤è™•ç†å’Œå–æ¶ˆä¸å®Œæ•´çš„æ“ä½œã€‚ |
| **æäº¤** | Commit | ç¢ºèªäº¤æ˜“ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œå°‡è®Šæ›´æ°¸ä¹…å¯«å…¥è³‡æ–™åº«ã€‚æäº¤æˆåŠŸå¾Œï¼Œè®Šæ›´å°å…¶ä»–äº¤æ˜“å¯è¦‹ä¸”ç„¡æ³•æ’¤éŠ·ï¼ˆé™¤éä½¿ç”¨æ–°äº¤æ˜“ä¿®æ”¹ï¼‰ã€‚ |
| **åºåˆ—åŒ–å¤±æ•—** | SerializationFailure | PostgreSQL åœ¨ REPEATABLE READ éš”é›¢ç­‰ç´šä¸‹ï¼Œåµæ¸¬åˆ°ä¸¦ç™¼æ›´æ–°è¡çªæ™‚æ‹‹å‡ºçš„éŒ¯èª¤ï¼ˆéŒ¯èª¤ä»£ç¢¼ï¼š40001ï¼‰ã€‚è¡¨ç¤ºäº¤æ˜“ç„¡æ³•åºåˆ—åŒ–åŸ·è¡Œï¼Œéœ€è¦é‡è©¦ã€‚ |
| **é‡è©¦æ¨¡å¼** | Retry Pattern | è»Ÿé«”è¨­è¨ˆæ¨¡å¼ä¹‹ä¸€ï¼Œç•¶æ“ä½œå¤±æ•—æ™‚è‡ªå‹•é‡æ–°å˜—è©¦ã€‚é€šå¸¸åŒ…å«æœ€å¤§é‡è©¦æ¬¡æ•¸ã€é‡è©¦é–“éš”ã€æŒ‡æ•¸é€€é¿ç­‰ç­–ç•¥ï¼Œç”¨æ–¼è™•ç†æš«æ™‚æ€§éŒ¯èª¤ã€‚ |
| **WebSocket** | WebSocket | å…¨é›™å·¥é€šè¨Šå”å®šï¼Œå…è¨±ä¼ºæœå™¨ä¸»å‹•æ¨é€è³‡æ–™çµ¦å®¢æˆ¶ç«¯ã€‚æœ¬å°ˆæ¡ˆä¸­ç”¨æ–¼æ¥æ”¶ Home Assistant çš„å³æ™‚ç‹€æ…‹æ›´æ–°äº‹ä»¶ï¼ˆstate_changedï¼‰ã€‚ |

**è¡“èªä½¿ç”¨ç¯„ä¾‹**ï¼š

```python
# ç¤ºç¯„è¡“èªåœ¨ç¨‹å¼ç¢¼ä¸­çš„æ‡‰ç”¨
def update_entities(self):
    """ä½¿ç”¨ Savepointï¼ˆä¿å­˜é»ï¼‰éš”é›¢æ‰¹æ¬¡æ“ä½œ"""
    for entity in entities:
        with self.env.cr.savepoint():  # Savepoint
            try:
                entity.write({'state': 'on'})  # ORM æ“ä½œ
            except Exception:
                # Rollbackï¼ˆå›æ»¾ï¼‰æ­¤ savepoint
                pass

    # Commitï¼ˆæäº¤ï¼‰æ•´å€‹ Transactionï¼ˆäº¤æ˜“ï¼‰
    self.env.cr.commit()

# è™•ç† SerializationFailureï¼ˆåºåˆ—åŒ–å¤±æ•—ï¼‰
for attempt in range(3):  # Retry Patternï¼ˆé‡è©¦æ¨¡å¼ï¼‰
    try:
        update_entities()
        break
    except psycopg2.errors.SerializationFailure:  # Concurrent Updateï¼ˆä¸¦ç™¼æ›´æ–°ï¼‰
        self.env.cr.rollback()  # Rollbackï¼ˆå›æ»¾ï¼‰
        time.sleep(0.5)
```

**å»¶ä¼¸é–±è®€**ï¼š

- **ACID ç‰¹æ€§è©³è§£**: [PostgreSQL - ACID Properties](https://www.postgresql.org/docs/current/tutorial-transactions.html)
- **éš”é›¢ç­‰ç´šå°æ¯”**: [PostgreSQL - Transaction Isolation](https://www.postgresql.org/docs/current/transaction-iso.html)
- **Odoo ORM æ–‡ä»¶**: [Odoo - ORM API](https://www.odoo.com/documentation/18.0/developer/reference/backend/orm.html)

---

**æ–‡ä»¶çµæŸ**
