<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
  <t t-name="odoo_ha_addon.HaInstanceDashboard">
    <div class="o_action o_view_controller">
      <div class="o_content">
        <!-- Dashboard Header -->
        <div class="o_ha_dashboard_header bg-white border-bottom p-3 mb-4">
          <h3 class="mb-0">
            <i class="fa fa-home me-2"/>
            Home Assistant 實例
          </h3>
          <p class="text-muted mb-0 mt-2">選擇一個實例查看詳細資訊</p>
        </div>

        <!-- Loading State -->
        <div t-if="state.loading" class="text-center py-5">
          <i class="fa fa-spinner fa-spin fa-3x text-muted"/>
          <p class="mt-3 text-muted">載入實例列表中...</p>
        </div>

        <!-- Error State -->
        <div t-elif="state.error" class="alert alert-danger m-3" role="alert">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="fa fa-exclamation-triangle me-2"/>
              <strong>錯誤：</strong>
              <span t-esc="state.error"/>
            </div>
            <button class="btn btn-sm btn-outline-danger" t-on-click="() => this.loadInstances()">
              <i class="fa fa-refresh me-1"/>
              重試
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div t-elif="!state.instances or state.instances.length === 0" class="text-center py-5">
          <i class="fa fa-inbox fa-3x text-muted"/>
          <p class="mt-3 text-muted">尚未設定任何 Home Assistant 實例</p>
          <!-- 新增實例按鈕：僅 HA Manager 可見 -->
          <button
            t-if="state.isHaManager"
            class="btn btn-primary mt-3"
            t-on-click="() => this.openInstanceSettings()">
            <i class="fa fa-plus me-2"/>
            新增實例
          </button>
          <!-- 非 Manager 用戶的提示訊息 -->
          <div t-else="" class="alert alert-info d-inline-block mt-3" role="alert">
            <i class="fa fa-info-circle me-2"/>
            請聯繫管理員設定 Home Assistant 實例
          </div>
        </div>

        <!-- Instance Cards Grid -->
        <div t-else="" class="o_ha_instance_cards">
          <div class="container-fluid">
            <div class="row">
              <!-- Instance Card -->
              <t t-foreach="state.instances" t-as="instance" t-key="instance.id">
                <div class="col-12 col-md-6 col-lg-4 mb-4">
                  <div class="card h-100 shadow-sm">
                    <!-- Card Header with Status -->
                    <div class="card-header bg-light">
                      <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                          <i class="fa fa-server me-2"/>
                          <span t-esc="instance.name"/>
                        </h5>
                        <!-- WebSocket Status Badge -->
                        <span class="badge" t-att-class="instance.websocket_status === 'connected' ? 'badge-success' : 'badge-secondary'">
                          <i class="fa fa-circle" t-att-class="getStatusClass(instance.websocket_status)"/>
                          <span t-esc="getStatusText(instance.websocket_status)"/>
                        </span>
                      </div>
                    </div>

                    <!-- Card Body -->
                    <div class="card-body">
                      <!-- Instance URL -->
                      <div class="mb-3">
                        <small class="text-muted d-block mb-1">
                          <i class="fa fa-link me-1"/>
                          連線網址
                        </small>
                        <a t-att-href="instance.api_url" target="_blank" class="text-decoration-none text-truncate d-block">
                          <span t-esc="instance.api_url"/>
                          <i class="fa fa-external-link ms-1"/>
                        </a>
                      </div>

                      <!-- Instance Description -->
                      <div t-if="instance.description" class="mb-3">
                        <small class="text-muted d-block mb-1">
                          <i class="fa fa-info-circle me-1"/>
                          描述
                        </small>
                        <p class="text-muted small mb-0" t-esc="instance.description"/>
                      </div>

                      <!-- Instance Status Info -->
                      <div class="mb-3">
                        <small class="text-muted d-block mb-1">
                          <i class="fa fa-cog me-1"/>
                          狀態
                        </small>
                        <div class="d-flex gap-2 flex-wrap">
                          <span t-if="instance.is_active" class="badge badge-success">
                            <i class="fa fa-check-circle me-1"/>
                            啟用中
                          </span>
                          <span t-else="" class="badge badge-secondary">
                            <i class="fa fa-pause-circle me-1"/>
                            已停用
                          </span>
                        </div>
                      </div>

                      <!-- Instance Statistics -->
                      <div class="mb-0">
                        <small class="text-muted d-block mb-2">
                          <i class="fa fa-bar-chart me-1"/>
                          統計資訊
                        </small>
                        <div class="row g-2">
                          <!-- Entity Count -->
                          <div class="col-6">
                            <div class="border rounded p-2 text-center">
                              <div class="text-primary fw-bold" t-esc="instance.entity_count || 0"/>
                              <small class="text-muted d-block">實體</small>
                            </div>
                          </div>
                          <!-- Area Count -->
                          <div class="col-6">
                            <div class="border rounded p-2 text-center">
                              <div class="text-success fw-bold" t-esc="instance.area_count || 0"/>
                              <small class="text-muted d-block">區域</small>
                            </div>
                          </div>
                        </div>
                        <!-- Last Sync Time -->
                        <div t-if="instance.last_sync" class="mt-2 text-center">
                          <small class="text-muted">
                            <i class="fa fa-clock-o me-1"/>
                            最後同步: <span t-esc="instance.last_sync"/>
                          </small>
                        </div>
                        <div t-else="" class="mt-2 text-center">
                          <small class="text-muted">
                            <i class="fa fa-clock-o me-1"/>
                            尚未同步
                          </small>
                        </div>
                      </div>
                    </div>

                    <!-- Card Footer with Action Buttons -->
                    <div class="card-footer bg-white border-top">
                      <div class="d-grid gap-2">
                        <!-- HA Info Button -->
                        <button
                          class="btn btn-primary btn-sm"
                          t-on-click="() => this.openHaInfo(instance.id, instance.name)"
                          t-att-disabled="!instance.is_active">
                          <i class="fa fa-dashboard me-2"/>
                          HA Info
                        </button>
                        <!-- Areas Button -->
                        <button
                          class="btn btn-success btn-sm"
                          t-on-click="() => this.openAreaDashboard(instance.id, instance.name)"
                          t-att-disabled="!instance.is_active">
                          <i class="fa fa-map-marker me-2"/>
                          分區
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </t>
            </div>
          </div>
        </div>
      </div>
    </div>
  </t>
</templates>
