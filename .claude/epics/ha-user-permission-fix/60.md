---
name: 調查與修復 ir.rule 權限問題
status: completed
created: 2026-01-18T09:43:09Z
updated: 2026-01-18T10:03:28Z
github: https://github.com/WOOWTECH/odoo-addons/issues/60
depends_on: []
parallel: false
conflicts_with: []
---

# Task: 調查與修復 ir.rule 權限問題

## Description

調查 ha_user 被加入 Entity Group 後無法存取 `ha.instance` 的根因，並修復 `security/security.xml` 中的 domain_force 語法或 ir.rule 快取機制。

## Acceptance Criteria

- [x] 確認 `ha_instance_user_rule` 的 domain_force 語法是否正確
- [x] 驗證 `.mapped()` 在 domain_force 中的評估行為
- [x] 修正任何發現的 domain_force 語法問題 (語法正確，問題在快取)
- [x] 確認 user_ids 關聯變更時 ir.rule 快取是否正確清除
- [x] 如有需要，在適當位置加入 `env['ir.rule'].clear_caches()` 呼叫
- [x] ha_manager 權限不受影響（回歸驗證）

## Technical Details

### 主要檢查檔案

1. **`security/security.xml`**
   - 檢查 `ha_instance_user_rule` 的 domain_force
   - 驗證 `user.ha_entity_group_ids.mapped('ha_instance_id').ids` 語法

2. **`models/ha_entity_group.py`**
   - 檢查 `user_ids` Many2many 欄位的 inverse 方法
   - 確認權限變更時是否觸發快取清除

3. **`models/res_users.py`** (如存在)
   - 檢查是否有自訂的 ha_entity_group_ids 計算邏輯

### 可能的修復方案

**方案 A：修正 domain_force 語法**
```xml
<!-- 原始可能有問題的寫法 -->
<field name="domain_force">[('id', 'in', user.ha_entity_group_ids.mapped('ha_instance_id').ids)]</field>

<!-- 可能需要改為 -->
<field name="domain_force">[('id', 'in', user.ha_entity_group_ids.ha_instance_id.ids)]</field>
```

**方案 B：加入快取清除**
```python
def write(self, vals):
    res = super().write(vals)
    if 'user_ids' in vals:
        self.env['ir.rule'].clear_caches()
    return res
```

### 驗證步驟

1. 在 Odoo shell 中測試 domain_force 評估
2. 手動測試權限變更是否立即生效
3. 確認 ha_manager 仍有完整權限

## Dependencies

- [ ] 已建立 worktree `ha-user-permission-fix`
- [ ] Docker 開發環境可用

## Effort Estimate

- Size: S
- Hours: 1.5
- Parallel: false

## Definition of Done

- [x] 根因確認並記錄 (ir.rule 快取未在 user_ids 變更時清除)
- [x] 修復程式碼已提交 (9e8081c)
- [x] 手動驗證 ha_user 權限正常
- [x] ha_manager 回歸測試通過
- [x] 程式碼已同步到 main 專案
