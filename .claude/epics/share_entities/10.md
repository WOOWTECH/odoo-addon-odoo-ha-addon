---
name: Portal Entity Control - Add device control to portal pages
status: closed
created: 2026-01-03T02:38:37Z
updated: 2026-01-03T03:59:22Z
github: https://github.com/WOOWTECH/odoo-addons/issues/10
depends_on: [3, 4, 5, 6, 7, 8]
parallel: false
conflicts_with: []
---

# Task: Portal Entity Control

## Description

為 Portal 頁面新增設備控制功能，讓透過 token 分享的用戶可以控制 switch/light/fan 類型的設備。

## Acceptance Criteria

- [x] 新增 `/portal/entity/<id>/control` JSON 端點
- [x] Token 驗證使用現有 `_verify_token()` 方法 (constant-time comparison)
- [x] Action 白名單：只允許 switch/light/fan 的 toggle, turn_on, turn_off
- [x] UI: Portal 頁面顯示 Control Card (僅 switch/light/fan domain)
- [x] UI: Toggle 按鈕正確顯示當前狀態 (on/off)
- [x] UI: 控制後狀態即時更新
- [x] UI: Loading 狀態和錯誤處理
- [x] 新增單元測試驗證控制端點

## Technical Details

### Backend: `controllers/portal.py`

```python
PORTAL_CONTROL_ACTIONS = {
    'switch': ['toggle', 'turn_on', 'turn_off'],
    'light': ['toggle', 'turn_on', 'turn_off'],
    'fan': ['toggle', 'turn_on', 'turn_off'],
}

@http.route('/portal/entity/<int:entity_id>/control', type='json', auth='public', cors='*')
def portal_entity_control(self, entity_id, access_token=None, action=None, **kw):
    # 1. Token 驗證
    # 2. Action 白名單檢查
    # 3. 調用 _call_websocket_api
    # 4. 返回更新後的 entity 狀態
```

### Frontend: `views/portal_templates.xml`

```xml
<!-- Control Card - 只對 switch/light/fan 顯示 -->
<t t-if="entity.domain in ['switch', 'light', 'fan']">
    <div class="card shadow-sm mb-4">
        <!-- Toggle 按鈕 + 狀態顯示 -->
    </div>
</t>
```

### JavaScript 控制函數

```javascript
function toggleEntity() {
    fetch('/portal/entity/' + entityId + '/control', {
        method: 'POST',
        body: JSON.stringify({
            jsonrpc: '2.0',
            params: { access_token: accessToken, action: action }
        })
    })
    // Handle response + update UI
}
```

### 檔案影響

- `controllers/portal.py` - 新增控制端點 (~50 行)
- `views/portal_templates.xml` - 新增 Control Card UI (~80 行)
- `tests/test_portal_controller.py` - 新增測試 (~60 行)

### 安全考量

1. Token 驗證：constant-time comparison (防止 timing attack)
2. Action 白名單：只允許特定 actions
3. Domain 限制：只允許 switch/light/fan
4. Instance 隔離：通過 entity 的 ha_instance_id

## Dependencies

- [x] #3 Model Layer - Add portal.mixin
- [x] #4 Portal Controller - Routes and Token Validation
- [x] #5 Portal Templates - QWeb Views
- [x] #6 Share Button UI - Form View Integration
- [x] #7 Polling Frontend - Auto-refresh JavaScript
- [x] #8 Testing and Documentation

## Effort Estimate

- Size: M
- Hours: 8
- Parallel: false

## Definition of Done

- [x] Code implemented
- [x] 單元測試通過
- [x] E2E 測試通過 (Chrome browser)
- [x] Code reviewed

## Implementation Summary

### Files Modified

1. **`controllers/portal.py`**
   - Added `PORTAL_CONTROL_ACTIONS` whitelist
   - Added `portal_entity_control()` endpoint with token validation

2. **`views/portal_templates.xml`**
   - Added Control Card UI for switch/light/fan domains
   - Added `toggleEntity()` JavaScript function
   - Added `updateControlUI()` for real-time UI updates

3. **`tests/test_portal_controller.py`**
   - Added 6 test cases for control endpoint validation

### E2E Test Results

- ✅ Control Card displays for switch domain entities
- ✅ Toggle OFF → ON: Success
- ✅ Toggle ON → OFF: Success
- ✅ State updates in real-time
- ✅ Token validation working correctly
