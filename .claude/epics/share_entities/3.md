---
name: Model Layer - Add portal.mixin
status: closed
created: 2026-01-02T15:59:50Z
updated: 2026-01-02T16:54:50Z
github: https://github.com/WOOWTECH/odoo-addons/issues/3
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Model Layer - Add portal.mixin

## Description

為 `ha.entity` 和 `ha.entity.group` 新增 `portal.mixin` 繼承，並實作 `_compute_access_url` 方法。同時更新 `__manifest__.py` 新增 `portal` 依賴。

## Acceptance Criteria

- [ ] `__manifest__.py` 的 `depends` 新增 `'portal'`
- [ ] `ha.entity` model 繼承 `portal.mixin`（放在繼承列表最後）
- [ ] `ha.entity.group` model 繼承 `portal.mixin`（放在繼承列表最後）
- [ ] `ha.entity` 實作 `_compute_access_url` 回傳 `/portal/entity/{id}`
- [ ] `ha.entity.group` 實作 `_compute_access_url` 回傳 `/portal/entity_group/{id}`
- [ ] 現有功能（多實例過濾、mail.thread）不受影響
- [ ] Token 可正確產生（使用 `_portal_ensure_token()`）

## Technical Details

### 繼承順序
```python
# models/ha_entity.py
class HAEntity(models.Model):
    _name = 'ha.entity'
    _inherit = ['ha.current.instance.filter.mixin', 'mail.thread',
                'mail.activity.mixin', 'portal.mixin']  # portal.mixin 放最後

    def _compute_access_url(self):
        for record in self:
            record.access_url = f'/portal/entity/{record.id}'
```

### Manifest 變更
```python
# __manifest__.py
'depends': ['base', 'web', 'mail', 'portal'],  # 新增 'portal'
```

### 檔案影響
- `__manifest__.py` - 新增依賴
- `models/ha_entity.py` - 新增 mixin 和方法
- `models/ha_entity_group.py` - 新增 mixin 和方法

### 注意事項
1. `portal.mixin` 必須放在繼承列表最後，避免與 `ha.current.instance.filter.mixin` 衝突
2. `portal.mixin` 已提供 `access_token` 欄位，不需額外定義
3. Token 產生由 `_portal_ensure_token()` 處理

## Dependencies

- [ ] 無前置任務依賴

## Effort Estimate

- Size: S
- Hours: 4
- Parallel: true

## Definition of Done

- [ ] Code implemented
- [ ] Token 產生測試通過（Odoo shell 測試）
- [ ] 現有功能回歸測試通過
- [ ] Code reviewed
