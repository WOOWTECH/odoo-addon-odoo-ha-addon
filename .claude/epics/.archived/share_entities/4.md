---
name: Portal Controller - Routes and Token Validation
status: closed
created: 2026-01-02T15:59:50Z
updated: 2026-01-02T16:55:00Z
github: https://github.com/WOOWTECH/odoo-addons/issues/4
depends_on: [3]
parallel: false
conflicts_with: []
---

# Task: Portal Controller - Routes and Token Validation

## Description

建立 Portal Controller (`controllers/portal.py`)，實作 Entity 和 Entity Group 的公開存取路由，包含 Token 驗證邏輯和 Polling endpoint。

## Acceptance Criteria

- [ ] 建立 `controllers/portal.py` 新檔案
- [ ] 在 `controllers/__init__.py` 中 import 新 controller
- [ ] 實作 `/portal/entity/<int:entity_id>` 路由 (auth='public')
- [ ] 實作 `/portal/entity_group/<int:group_id>` 路由 (auth='public')
- [ ] 實作 `/portal/entity/<int:entity_id>/state` Polling endpoint (JSON)
- [ ] 實作 `/portal/entity_group/<int:group_id>/state` Polling endpoint (JSON)
- [ ] Token 驗證失敗時回傳友善 403 錯誤頁面
- [ ] 使用 `sudo()` 讀取資料，繞過 `ha.current.instance.filter.mixin`
- [ ] 實施 field whitelist，不暴露敏感資料

## Technical Details

### Controller 結構
```python
# controllers/portal.py
from odoo import http
from odoo.http import request
from odoo.exceptions import AccessError
import hmac

PORTAL_ENTITY_FIELDS = [
    'name', 'entity_id', 'entity_state', 'last_changed',
    'area_id', 'domain', 'attributes'
]

PORTAL_GROUP_FIELDS = [
    'name', 'description', 'entity_ids', 'entity_count'
]

class HAPortalController(http.Controller):

    def _verify_token(self, record, access_token):
        """安全的 Token 驗證（防止時序攻擊）"""
        if not access_token or not record.access_token:
            return False
        return hmac.compare_digest(record.access_token, access_token)

    @http.route('/portal/entity/<int:entity_id>', type='http', auth='public', website=True)
    def portal_entity(self, entity_id, access_token=None, **kw):
        entity = request.env['ha.entity'].sudo().browse(entity_id)
        if not entity.exists() or not self._verify_token(entity, access_token):
            return request.render('odoo_ha_addon.portal_error_403')
        # Render template with whitelisted fields
        return request.render('odoo_ha_addon.portal_entity', {
            'entity': entity,
            'access_token': access_token,
        })

    @http.route('/portal/entity/<int:entity_id>/state', type='json', auth='public')
    def portal_entity_state(self, entity_id, access_token=None):
        """Polling endpoint for real-time updates"""
        entity = request.env['ha.entity'].sudo().browse(entity_id)
        if not entity.exists() or not self._verify_token(entity, access_token):
            return {'error': 'Access denied'}
        return entity.read(PORTAL_ENTITY_FIELDS)[0]
```

### 檔案影響
- `controllers/portal.py` (新建)
- `controllers/__init__.py` (修改)

### 安全注意事項
1. 使用 `hmac.compare_digest()` 防止時序攻擊
2. Field whitelist 嚴格限制暴露的欄位
3. `sudo()` 僅用於讀取，不允許寫入

## Dependencies

- [ ] Task 001: Model Layer 必須先完成

## Effort Estimate

- Size: M
- Hours: 8
- Parallel: false (depends on 001)

## Definition of Done

- [ ] Code implemented
- [ ] Token 驗證邏輯測試通過
- [ ] 匿名存取（無痕模式）測試通過
- [ ] 錯誤頁面正確顯示
- [ ] Code reviewed
