---
name: Testing and Documentation
status: closed
created: 2026-01-02T15:59:50Z
updated: 2026-01-02T16:55:41Z
github: https://github.com/WOOWTECH/odoo-addons/issues/8
depends_on: [3, 4, 5, 6, 7]
parallel: false
conflicts_with: []
---

# Task: Testing and Documentation

## Description

撰寫 Unit Tests 和 Integration Tests 驗證 Portal 分享功能，包含 Token 驗證、權限控制、Polling 穩定性測試，以及功能文件更新。

## Acceptance Criteria

- [ ] Unit Tests: Token 產生和驗證邏輯
- [ ] Unit Tests: `_compute_access_url` 方法
- [ ] Integration Tests: Portal 路由存取（有效/無效 Token）
- [ ] Integration Tests: Polling endpoint 回應格式
- [ ] Integration Tests: Share button 權限（HA Manager vs HA User）
- [ ] 匿名瀏覽器測試（無痕模式驗證）
- [ ] 更新 CHANGELOG 或 Release Notes
- [ ] 更新 docs/ 目錄相關文件（如需要）

## Technical Details

### Unit Tests

```python
# tests/test_portal_mixin.py
from odoo.tests.common import TransactionCase

class TestPortalMixin(TransactionCase):

    def setUp(self):
        super().setUp()
        self.entity = self.env['ha.entity'].create({
            'name': 'Test Entity',
            'entity_id': 'sensor.test',
        })

    def test_access_url_computed(self):
        """Test _compute_access_url returns correct path"""
        self.assertEqual(
            self.entity.access_url,
            f'/portal/entity/{self.entity.id}'
        )

    def test_portal_ensure_token(self):
        """Test token generation"""
        self.assertFalse(self.entity.access_token)
        self.entity._portal_ensure_token()
        self.assertTrue(self.entity.access_token)
        self.assertEqual(len(self.entity.access_token), 32)

    def test_action_share_returns_wizard(self):
        """Test action_share method returns portal.share wizard"""
        action = self.entity.action_share()
        self.assertEqual(action['res_model'], 'portal.share')
        self.assertEqual(action['context']['default_res_model'], 'ha.entity')
```

### Integration Tests

```python
# tests/test_portal_controller.py
from odoo.tests.common import HttpCase

class TestPortalController(HttpCase):

    def test_portal_entity_valid_token(self):
        """Test portal page loads with valid token"""
        entity = self.env['ha.entity'].sudo().create({
            'name': 'Test Entity',
            'entity_id': 'sensor.test',
        })
        entity._portal_ensure_token()

        response = self.url_open(
            f'/portal/entity/{entity.id}?access_token={entity.access_token}'
        )
        self.assertEqual(response.status_code, 200)
        self.assertIn('Test Entity', response.text)

    def test_portal_entity_invalid_token(self):
        """Test 403 page with invalid token"""
        entity = self.env['ha.entity'].sudo().create({
            'name': 'Test Entity',
            'entity_id': 'sensor.test',
        })

        response = self.url_open(
            f'/portal/entity/{entity.id}?access_token=invalid_token'
        )
        self.assertEqual(response.status_code, 200)  # Renders 403 template
        self.assertIn('Access Denied', response.text)

    def test_polling_endpoint_returns_json(self):
        """Test polling endpoint returns correct JSON format"""
        entity = self.env['ha.entity'].sudo().create({
            'name': 'Test Entity',
            'entity_id': 'sensor.test',
            'entity_state': 'on',
        })
        entity._portal_ensure_token()

        response = self.url_open(
            f'/portal/entity/{entity.id}/state',
            data=json.dumps({
                'jsonrpc': '2.0',
                'params': {'access_token': entity.access_token}
            }),
            headers={'Content-Type': 'application/json'}
        )
        result = response.json()
        self.assertIn('entity_state', result.get('result', {}))
```

### 權限測試

```python
# tests/test_share_permissions.py
from odoo.tests.common import TransactionCase

class TestSharePermissions(TransactionCase):

    def test_ha_manager_can_share(self):
        """Test HA Manager can access share button"""
        manager_user = self.env['res.users'].create({
            'name': 'Test Manager',
            'login': 'test_manager',
            'groups_id': [(6, 0, [self.env.ref('odoo_ha_addon.group_ha_manager').id])]
        })
        entity = self.env['ha.entity'].with_user(manager_user).create({
            'name': 'Test Entity',
            'entity_id': 'sensor.test',
        })
        # action_share should work
        action = entity.action_share()
        self.assertEqual(action['res_model'], 'portal.share')

    def test_ha_user_cannot_share(self):
        """Test HA User cannot access share functionality"""
        # HA User should not see Share button (enforced via XML groups)
        # This test verifies the button visibility via groups attribute
        view = self.env.ref('odoo_ha_addon.ha_entity_form_view')
        arch = view.arch
        self.assertIn('groups="odoo_ha_addon.group_ha_manager"', arch)
```

### 檔案影響
- `tests/test_portal_mixin.py` (新建)
- `tests/test_portal_controller.py` (新建)
- `tests/test_share_permissions.py` (新建)
- `docs/` 相關文件 (修改，如需要)

## Dependencies

- [ ] Task 001-005: 所有功能實作完成

## Effort Estimate

- Size: S
- Hours: 4
- Parallel: false (depends on all implementation tasks)

## Definition of Done

- [ ] Unit tests 全部通過
- [ ] Integration tests 全部通過
- [ ] 手動測試：匿名瀏覽器存取 Portal
- [ ] 手動測試：Share Wizard 產生連結
- [ ] 文件更新（如需要）
- [ ] Code reviewed
