---
name: Polling Frontend - Auto-refresh JavaScript
status: closed
created: 2026-01-02T15:59:50Z
updated: 2026-01-02T16:55:31Z
github: https://github.com/WOOWTECH/odoo-addons/issues/7
depends_on: [4, 5]
parallel: false
conflicts_with: []
---

# Task: Polling Frontend - Auto-refresh JavaScript

## Description

優化 Portal 頁面的 Polling JavaScript，確保穩定的 5 秒自動更新機制，包含錯誤處理和連線狀態指示。

## Acceptance Criteria

- [ ] Entity 頁面每 5 秒自動更新狀態
- [ ] Entity Group 頁面每 5 秒更新所有 Entities 狀態
- [ ] 更新時顯示載入指示器（可選）
- [ ] 網路錯誤時不中斷 Polling 循環
- [ ] 頁面離開時停止 Polling（清理 interval）
- [ ] 狀態變化時有視覺回饋（例如閃爍效果）

## Technical Details

### 優化的 Polling JavaScript
```javascript
// Portal 頁面內嵌
(function() {
    const entityId = /*[[${entity.id}]]*/ 0;
    const accessToken = '/*[[${access_token}]]*/';
    const POLL_INTERVAL = 5000; // 5 seconds
    let pollTimer = null;
    let lastState = null;

    function updateEntityState() {
        fetch(`/portal/entity/${entityId}/state`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                jsonrpc: '2.0',
                method: 'call',
                params: {access_token: accessToken}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.result && data.result.entity_state) {
                const stateEl = document.getElementById('entity-state');
                const newState = data.result.entity_state;

                // 狀態變化時閃爍效果
                if (lastState !== null && lastState !== newState) {
                    stateEl.classList.add('state-changed');
                    setTimeout(() => stateEl.classList.remove('state-changed'), 1000);
                }

                stateEl.textContent = newState;
                lastState = newState;

                // 更新 last_changed
                if (data.result.last_changed) {
                    const timeEl = document.getElementById('entity-last-changed');
                    if (timeEl) timeEl.textContent = data.result.last_changed;
                }
            }
        })
        .catch(error => {
            console.warn('Polling error:', error);
            // 不中斷 Polling，下次再試
        });
    }

    function startPolling() {
        // 首次立即執行
        updateEntityState();
        // 設定定時器
        pollTimer = setInterval(updateEntityState, POLL_INTERVAL);
    }

    function stopPolling() {
        if (pollTimer) {
            clearInterval(pollTimer);
            pollTimer = null;
        }
    }

    // 頁面載入時啟動
    document.addEventListener('DOMContentLoaded', startPolling);

    // 頁面離開時停止
    window.addEventListener('beforeunload', stopPolling);

    // 頁面可見性變化時控制
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopPolling();
        } else {
            startPolling();
        }
    });
})();
```

### CSS 動畫效果
```css
/* 在 portal_templates.xml 中新增 */
<style>
.state-changed {
    animation: highlight 1s ease-out;
}

@keyframes highlight {
    0% { background-color: #fff3cd; }
    100% { background-color: transparent; }
}
</style>
```

### Entity Group Polling
```javascript
// Entity Group 頁面需要更新多個 entity 狀態
function updateGroupEntities() {
    fetch(`/portal/entity_group/${groupId}/state`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({jsonrpc: '2.0', params: {access_token: accessToken}})
    })
    .then(response => response.json())
    .then(data => {
        if (data.result && data.result.entities) {
            data.result.entities.forEach(entity => {
                const row = document.getElementById(`entity-row-${entity.id}`);
                if (row) {
                    row.querySelector('.entity-state').textContent = entity.entity_state;
                }
            });
        }
    })
    .catch(console.warn);
}
```

### 檔案影響
- `views/portal_templates.xml` (修改 - 優化 JS)

## Dependencies

- [ ] Task 002: Controller Polling endpoints
- [ ] Task 003: Portal Templates 基礎結構

## Effort Estimate

- Size: S
- Hours: 4
- Parallel: false (depends on 002, 003)

## Definition of Done

- [ ] Code implemented
- [ ] Polling 穩定運作 5 秒間隔
- [ ] 網路錯誤不中斷 Polling
- [ ] 頁面隱藏時停止 Polling
- [ ] 狀態變化有視覺回饋
- [ ] Code reviewed
