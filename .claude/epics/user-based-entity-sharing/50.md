---
name: Portal /my Integration
status: closed
created: 2026-01-16T16:32:09Z
updated: 2026-01-16T17:46:31Z
github: https://github.com/WOOWTECH/odoo-addons/issues/50
depends_on: [47, 49]
parallel: false
conflicts_with: []
---

# Task: Portal /my Integration

## Description

在 Portal `/my` 頁面整合 Home Assistant 區塊，讓被分享的用戶可以在「我的帳戶」頁面看到並存取被分享的 Entity 和 Entity Group。

## Acceptance Criteria

- [ ] `/my` 頁面顯示 "Home Assistant" 區塊/按鈕
- [ ] 只有在用戶有被分享內容時才顯示 HA 區塊
- [ ] 建立 `/my/ha` 路由顯示有分享內容的 HA Instance 列表
- [ ] 建立 `/my/ha/<int:instance_id>` 路由顯示該 Instance 的分享內容
- [ ] Instance 詳細頁有 Entity 和 Entity Group 兩個分頁/區塊
- [ ] Entity 列表顯示：名稱、狀態、權限類型、過期時間
- [ ] Entity Group 列表顯示：名稱、Entity 數量、權限類型、過期時間
- [ ] 點擊 Entity/Group 可進入詳細頁面
- [ ] 響應式設計支援手機瀏覽
- [ ] 整合測試通過

## Technical Details

### URL 結構

| Route | Description |
|-------|-------------|
| `/my` | Portal 首頁，顯示 HA 區塊 (繼承修改) |
| `/my/ha` | HA Instance 列表 |
| `/my/ha/<int:instance_id>` | Instance 詳細頁 (Entity/Group 分頁) |

### Controller 新增

```python
class HAPortalMyController(http.Controller):

    @http.route('/my/ha', type='http', auth='user', website=True)
    def portal_my_ha(self, **kw):
        """顯示用戶被分享的 HA Instance 列表"""
        user = request.env.user
        shares = request.env['ha.entity.share'].sudo().search([
            ('user_id', '=', user.id),
            '|',
            ('expiry_date', '=', False),
            ('expiry_date', '>', fields.Datetime.now())
        ])

        # 取得有分享內容的 Instance
        instance_ids = shares.mapped('ha_instance_id').ids
        instances = request.env['ha.instance'].sudo().browse(instance_ids)

        return request.render('odoo_ha_addon.portal_my_ha', {
            'instances': instances,
            'page_name': 'portal_my_ha',
        })

    @http.route('/my/ha/<int:instance_id>', type='http', auth='user', website=True)
    def portal_my_ha_instance(self, instance_id, tab='entities', **kw):
        """顯示特定 Instance 的分享 Entity/Group"""
        user = request.env.user

        # 取得該 Instance 下用戶被分享的 Entity 和 Group
        entity_shares = request.env['ha.entity.share'].sudo().search([
            ('user_id', '=', user.id),
            ('entity_id.ha_instance_id', '=', instance_id),
            '|', ('expiry_date', '=', False), ('expiry_date', '>', fields.Datetime.now())
        ])

        group_shares = request.env['ha.entity.share'].sudo().search([
            ('user_id', '=', user.id),
            ('group_id.ha_instance_id', '=', instance_id),
            '|', ('expiry_date', '=', False), ('expiry_date', '>', fields.Datetime.now())
        ])

        instance = request.env['ha.instance'].sudo().browse(instance_id)

        return request.render('odoo_ha_addon.portal_my_ha_instance', {
            'instance': instance,
            'entity_shares': entity_shares,
            'group_shares': group_shares,
            'active_tab': tab,
            'page_name': 'portal_my_ha_instance',
        })
```

### Portal Templates

#### 繼承 `/my` 首頁

```xml
<template id="portal_my_home_ha" inherit_id="portal.portal_my_home">
    <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
        <t t-set="ha_share_count" t-value="request.env['ha.entity.share'].sudo().search_count([
            ('user_id', '=', request.env.user.id),
            '|', ('expiry_date', '=', False), ('expiry_date', '>', fields.Datetime.now())
        ])"/>
        <t t-if="ha_share_count > 0">
            <div class="o_portal_doc_card">
                <a href="/my/ha" class="d-flex align-items-center">
                    <i class="fa fa-home fa-2x mr-3 text-primary"></i>
                    <div>
                        <h5 class="mb-0">Home Assistant</h5>
                        <small class="text-muted">
                            <t t-out="ha_share_count"/> 個分享的設備
                        </small>
                    </div>
                </a>
            </div>
        </t>
    </xpath>
</template>
```

#### Instance 列表頁

```xml
<template id="portal_my_ha" name="My HA Instances">
    <t t-call="portal.portal_layout">
        <div class="container py-4">
            <h3>Home Assistant</h3>
            <div class="row">
                <t t-foreach="instances" t-as="instance">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5><t t-out="instance.name"/></h5>
                                <a t-att-href="'/my/ha/%s' % instance.id" class="btn btn-primary">
                                    查看設備
                                </a>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
        </div>
    </t>
</template>
```

### 檔案變更

| 檔案 | 變更類型 |
|------|---------|
| `controllers/portal.py` | 修改 - 新增 /my/ha 相關路由 |
| `views/portal_templates.xml` | 修改 - 新增 /my/ha 模板 |
| `__manifest__.py` | 確認 portal 依賴 |

## Dependencies

- [ ] Task 001 (Model & Security) 必須先完成
- [ ] Task 003 (Controller Refactoring) 必須先完成 (權限檢查邏輯)

## Effort Estimate

- Size: L
- Hours: 12
- Parallel: false (依賴 Task 001, 003)

## Definition of Done

- [ ] `/my` 頁面顯示 HA 區塊
- [ ] `/my/ha` 正確顯示有分享的 Instance
- [ ] `/my/ha/<instance_id>` 正確顯示 Entity/Group 分頁
- [ ] 列表可點擊進入詳細頁
- [ ] 響應式設計在手機上正常顯示
- [ ] 過期的分享不會出現在列表
- [ ] 整合測試通過
