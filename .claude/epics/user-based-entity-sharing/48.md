---
name: Share Wizard & Form UI
status: closed
created: 2026-01-16T16:32:09Z
updated: 2026-01-16T17:37:24Z
github: https://github.com/WOOWTECH/odoo-addons/issues/48
depends_on: [47]
parallel: false
conflicts_with: []
---

# Task: Share Wizard & Form UI

## Description

建立分享設定 Wizard 讓 Administrator/HA Manager 可以將 Entity 或 Entity Group 分享給特定用戶，並在 Entity/Entity Group Form View 中顯示已分享的用戶列表。

## Acceptance Criteria

- [ ] 建立 `wizards/` 目錄和 `__init__.py`
- [ ] 建立 `ha.entity.share.wizard` TransientModel
- [ ] Wizard 支援多用戶選擇 (Many2many to res.users)
- [ ] Wizard 支援權限類型選擇 (view/control)
- [ ] Wizard 支援過期時間設定
- [ ] Wizard 可從 Entity 或 Entity Group context 開啟
- [ ] 修改 Entity Form View 的 Share 按鈕呼叫新 Wizard
- [ ] 修改 Entity Group Form View 的 Share 按鈕呼叫新 Wizard
- [ ] Entity Form View 顯示已分享用戶列表 (One2many)
- [ ] Entity Group Form View 顯示已分享用戶列表 (One2many)
- [ ] 可在列表中直接刪除分享記錄
- [ ] 單元測試通過

## Technical Details

### Wizard 模型

```python
class HAEntityShareWizard(models.TransientModel):
    _name = 'ha.entity.share.wizard'
    _description = 'Share Entity/Group Wizard'

    # Context-based fields
    entity_id = fields.Many2one('ha.entity', string='Entity')
    group_id = fields.Many2one('ha.entity.group', string='Entity Group')

    # Share settings
    user_ids = fields.Many2many('res.users', string='Share With Users', required=True)
    permission = fields.Selection([
        ('view', 'View Only'),
        ('control', 'Can Control')
    ], string='Permission', required=True, default='view')
    expiry_date = fields.Datetime(string='Expiry Date', help='Leave empty for no expiration')

    @api.model
    def default_get(self, fields_list):
        # 從 context 取得 entity_id 或 group_id
        ...

    def action_share(self):
        # 為每個選中的用戶建立 ha.entity.share 記錄
        ...
```

### 檔案變更

| 檔案 | 變更類型 |
|------|---------|
| `__manifest__.py` | 修改 - 新增 wizard view 到 data |
| `wizards/__init__.py` | 新增 |
| `wizards/ha_entity_share_wizard.py` | 新增 |
| `views/ha_entity_share_wizard_views.xml` | 新增 |
| `views/ha_entity_views.xml` | 修改 - 修改 Share 按鈕, 新增 share_ids 列表 |
| `views/ha_entity_group_views.xml` | 修改 - 修改 Share 按鈕, 新增 share_ids 列表 |
| `models/ha_entity.py` | 修改 - 修改 action_share() 方法 |
| `models/ha_entity_group.py` | 修改 - 修改 action_share() 方法 |
| `security/ir.model.access.csv` | 修改 - 新增 wizard 權限 |

### View 修改範例

Entity Form View 新增分享列表：
```xml
<notebook>
    <!-- 新增 Sharing 分頁 -->
    <page string="Sharing" name="sharing">
        <field name="share_ids" readonly="1">
            <tree editable="bottom">
                <field name="user_id"/>
                <field name="permission"/>
                <field name="expiry_date"/>
                <field name="is_expired"/>
                <button name="unlink" type="object" icon="fa-trash"
                        confirm="Are you sure you want to remove this share?"/>
            </tree>
        </field>
    </page>
</notebook>
```

## Dependencies

- [ ] Task 001 (Model & Security) 必須先完成

## Effort Estimate

- Size: M
- Hours: 8
- Parallel: false (依賴 Task 001)

## Definition of Done

- [ ] Wizard 可成功建立分享記錄
- [ ] Entity/Entity Group Form View 顯示分享列表
- [ ] Share 按鈕正確呼叫新 Wizard
- [ ] 可直接在 Form View 中刪除分享記錄
- [ ] 單元測試覆蓋 Wizard 邏輯
- [ ] UI 整合測試通過
