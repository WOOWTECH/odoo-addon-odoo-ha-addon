---
name: Model & Security - ha.entity.share
status: closed
created: 2026-01-16T16:32:09Z
updated: 2026-01-16T17:16:55Z
github: https://github.com/WOOWTECH/odoo-addons/issues/47
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Model & Security - ha.entity.share

## Description

建立 `ha.entity.share` 模型，用於記錄 Entity/Entity Group 的分享關係，包含被分享用戶、權限類型（view/control）、過期時間，以及通知狀態追蹤。

## Acceptance Criteria

- [ ] 建立 `models/ha_entity_share.py` 模型檔案
- [ ] 欄位：entity_id (Many2one to ha.entity, optional)
- [ ] 欄位：group_id (Many2one to ha.entity.group, optional)
- [ ] 欄位：user_id (Many2one to res.users, required)
- [ ] 欄位：permission (Selection: view/control, required, default='view')
- [ ] 欄位：expiry_date (Datetime, optional)
- [ ] 欄位：notification_sent (Boolean, default=False)
- [ ] Computed 欄位：ha_instance_id (從 entity_id 或 group_id 取得)
- [ ] Computed 欄位：is_expired (根據 expiry_date 判斷)
- [ ] SQL 約束：entity_id 和 group_id 必須二選一
- [ ] SQL 約束：同一 entity + user 組合不可重複
- [ ] SQL 約束：同一 group + user 組合不可重複
- [ ] 新增 `security/ir.model.access.csv` 權限設定
- [ ] 在 ha.entity 和 ha.entity.group 新增 share_ids One2many 欄位
- [ ] 單元測試通過

## Technical Details

### 模型設計

```python
class HAEntityShare(models.Model):
    _name = 'ha.entity.share'
    _description = 'Entity/Group Share Record'
    _rec_name = 'display_name'

    entity_id = fields.Many2one('ha.entity', string='Entity', ondelete='cascade', index=True)
    group_id = fields.Many2one('ha.entity.group', string='Entity Group', ondelete='cascade', index=True)
    user_id = fields.Many2one('res.users', string='Shared With', required=True, ondelete='cascade', index=True)
    permission = fields.Selection([
        ('view', 'View Only'),
        ('control', 'Can Control')
    ], string='Permission', required=True, default='view')
    expiry_date = fields.Datetime(string='Expiry Date')
    notification_sent = fields.Boolean(string='Expiry Notification Sent', default=False)

    # Computed fields
    ha_instance_id = fields.Many2one('ha.instance', compute='_compute_ha_instance_id', store=True)
    is_expired = fields.Boolean(compute='_compute_is_expired', string='Is Expired')
    display_name = fields.Char(compute='_compute_display_name')

    _sql_constraints = [
        ('entity_or_group_required',
         'CHECK((entity_id IS NOT NULL AND group_id IS NULL) OR (entity_id IS NULL AND group_id IS NOT NULL))',
         'Must specify either entity_id or group_id, not both'),
        ('unique_entity_user',
         'UNIQUE(entity_id, user_id)',
         'Entity already shared with this user'),
        ('unique_group_user',
         'UNIQUE(group_id, user_id)',
         'Group already shared with this user'),
    ]
```

### 檔案變更

| 檔案 | 變更類型 |
|------|---------|
| `models/__init__.py` | 修改 - 新增 import |
| `models/ha_entity_share.py` | 新增 |
| `models/ha_entity.py` | 修改 - 新增 share_ids One2many |
| `models/ha_entity_group.py` | 修改 - 新增 share_ids One2many |
| `security/ir.model.access.csv` | 修改 - 新增權限 |
| `tests/test_entity_share.py` | 新增 |

### 權限設定 (ir.model.access.csv)

```csv
id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_ha_entity_share_manager,ha.entity.share manager,model_ha_entity_share,odoo_ha_addon.group_ha_manager,1,1,1,1
access_ha_entity_share_user,ha.entity.share user,model_ha_entity_share,odoo_ha_addon.group_ha_user,1,0,0,0
access_ha_entity_share_portal,ha.entity.share portal,model_ha_entity_share,base.group_portal,1,0,0,0
```

## Dependencies

- [ ] 無前置依賴，可獨立開始

## Effort Estimate

- Size: M
- Hours: 8
- Parallel: true

## Definition of Done

- [ ] `ha.entity.share` 模型已建立
- [ ] 所有欄位和約束已實作
- [ ] ha.entity 和 ha.entity.group 已新增 share_ids 欄位
- [ ] 權限設定已加入 ir.model.access.csv
- [ ] 單元測試覆蓋率 > 80%
- [ ] 模組可成功安裝/升級
