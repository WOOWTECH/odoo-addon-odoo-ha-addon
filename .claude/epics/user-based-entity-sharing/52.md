---
name: Testing & QA
status: closed
created: 2026-01-16T16:32:09Z
updated: 2026-01-16T17:51:06Z
github: https://github.com/WOOWTECH/odoo-addons/issues/52
depends_on: [47, 002, 003, 004, 51]
parallel: false
conflicts_with: []
---

# Task: Testing & QA

## Description

進行完整的測試和品質保證，包括更新現有測試、新增整合測試、E2E 測試、Security 審查，以及文件更新。

## Acceptance Criteria

- [ ] 更新現有 `test_portal_controller.py` 移除 token 測試
- [ ] 更新現有 `test_portal_mixin.py` 調整測試邏輯
- [ ] 更新現有 `test_share_permissions.py` 適配新機制
- [ ] 新增 `test_entity_share.py` 完整測試 ha.entity.share 模型
- [ ] 新增 `test_share_wizard.py` 測試 Wizard 邏輯
- [ ] E2E 測試：未登入用戶被導向登入頁
- [ ] E2E 測試：無權限用戶看到 403
- [ ] E2E 測試：view 權限用戶可查看但不能控制
- [ ] E2E 測試：control 權限用戶可查看和控制
- [ ] E2E 測試：過期分享無法存取
- [ ] E2E 測試：/my/ha 頁面正常顯示
- [ ] Security 審查：確認無越權存取漏洞
- [ ] 更新 CHANGELOG.md
- [ ] 更新相關文件

## Technical Details

### 測試覆蓋範圍

#### 1. Unit Tests

**test_entity_share.py:**
```python
class TestHAEntityShare(TransactionCase):
    def test_create_entity_share(self):
        """測試建立 Entity 分享記錄"""

    def test_create_group_share(self):
        """測試建立 Group 分享記錄"""

    def test_constraint_entity_or_group(self):
        """測試必須二選一約束"""

    def test_constraint_unique_entity_user(self):
        """測試 Entity + User 唯一約束"""

    def test_is_expired_computation(self):
        """測試過期判斷計算"""

    def test_ha_instance_computation(self):
        """測試 Instance 計算"""
```

**test_share_wizard.py:**
```python
class TestHAEntityShareWizard(TransactionCase):
    def test_wizard_create_shares(self):
        """測試 Wizard 建立多用戶分享"""

    def test_wizard_duplicate_prevention(self):
        """測試 Wizard 防止重複分享"""
```

#### 2. Integration Tests

**test_portal_controller.py (更新):**
```python
class TestPortalControllerUserBased(HttpCase):
    def test_entity_access_requires_login(self):
        """測試未登入被導向登入頁"""

    def test_entity_access_without_share(self):
        """測試無分享記錄返回 403"""

    def test_entity_access_with_view_permission(self):
        """測試 view 權限可存取"""

    def test_entity_control_requires_control_permission(self):
        """測試控制需要 control 權限"""

    def test_expired_share_returns_403(self):
        """測試過期分享返回 403"""
```

#### 3. E2E Tests (Playwright MCP)

```markdown
E2E Test Cases:

1. **登入流程**
   - 未登入訪問 /portal/entity/1 → 導向 /web/login
   - 登入後自動跳轉回原頁面

2. **權限驗證**
   - 無分享記錄的用戶 → 403 頁面
   - 有 view 權限 → 可查看，無控制按鈕
   - 有 control 權限 → 可查看和控制

3. **過期處理**
   - 過期分享 → 403 頁面
   - 未過期分享 → 正常存取

4. **/my/ha 頁面**
   - 有分享 → 顯示 HA 區塊
   - 無分享 → 不顯示 HA 區塊
   - Instance 列表正確
   - Entity/Group 分頁正確
```

### Security 審查清單

- [ ] 確認所有 Portal 路由都是 `auth='user'`
- [ ] 確認無法透過修改 URL 存取未分享的 Entity
- [ ] 確認 view 權限用戶無法呼叫控制 API
- [ ] 確認過期分享確實無法存取
- [ ] 確認 sudo() 只用於讀取，不用於寫入
- [ ] 確認無 SQL injection 風險
- [ ] 確認無 XSS 風險

### 檔案變更

| 檔案 | 變更類型 |
|------|---------|
| `tests/__init__.py` | 修改 - 新增 import |
| `tests/test_entity_share.py` | 新增 |
| `tests/test_share_wizard.py` | 新增 |
| `tests/test_portal_controller.py` | 修改 |
| `tests/test_portal_mixin.py` | 修改 |
| `tests/test_share_permissions.py` | 修改 |
| `tests/e2e_tests/test_user_based_sharing.py` | 新增 (Optional) |
| `CHANGELOG.md` | 修改 |
| `docs/architecture/user-based-sharing.md` | 新增 (Optional) |

### 文件更新

#### CHANGELOG.md 新增

```markdown
## [Unreleased]

### Changed
- 分享機制從 Token-based 改為 User-based
- Portal 路由需要登入才能存取
- 新增 /my/ha 頁面讓用戶查看被分享的設備

### Added
- ha.entity.share 模型
- 分享權限設定（view/control）
- 分享過期時間設定
- 過期前 7 天通知機制

### Removed
- access_token 驗證機制（保留欄位但不使用）
```

## Dependencies

- [ ] 所有其他 Tasks (001-005) 必須先完成

## Effort Estimate

- Size: M
- Hours: 8
- Parallel: false (最後執行)

## Definition of Done

- [ ] 所有現有測試更新並通過
- [ ] 新增測試覆蓋率 > 80%
- [ ] E2E 測試全部通過
- [ ] Security 審查無漏洞
- [ ] CHANGELOG.md 已更新
- [ ] 文件已更新
- [ ] Code Review 通過
