---
name: Controller Refactoring - User-based Auth
status: closed
created: 2026-01-16T16:32:09Z
updated: 2026-01-16T17:38:19Z
github: https://github.com/WOOWTECH/odoo-addons/issues/49
depends_on: [47]
parallel: false
conflicts_with: []
---

# Task: Controller Refactoring - User-based Auth

## Description

修改 Portal Controller，將現有的 Token-based 驗證改為 User-based 驗證。所有 Portal 路由改為需要登入 (`auth='user'`)，並使用 `ha.entity.share` 記錄來驗證用戶權限。

## Acceptance Criteria

- [ ] `/portal/entity/<id>` 路由改為 `auth='user'`
- [ ] `/portal/entity_group/<id>` 路由改為 `auth='user'`
- [ ] `/portal/entity/<id>/state` 路由改為 `auth='user'`
- [ ] `/portal/entity_group/<id>/state` 路由改為 `auth='user'`
- [ ] `/portal/call-service` 路由改為 `auth='user'`
- [ ] 移除 `_verify_token()` 方法
- [ ] 移除 `_get_access_token()` 方法
- [ ] 新增 `_check_entity_share_access(entity_id, user_id, permission)` 方法
- [ ] 新增 `_check_group_share_access(group_id, user_id, permission)` 方法
- [ ] 控制端點額外檢查用戶是否有 'control' 權限
- [ ] 過期的分享記錄視為無權限 (返回 403)
- [ ] 未登入用戶自動導向 `/web/login`
- [ ] 無權限用戶顯示 403 錯誤頁面
- [ ] 修改 Portal templates 移除 accessToken 參數傳遞
- [ ] 修改 OWL 組件移除 X-Portal-Token header
- [ ] 整合測試通過

## Technical Details

### 權限檢查方法

```python
def _check_entity_share_access(self, entity_id, user_id, required_permission='view'):
    """
    Check if user has access to entity via ha.entity.share.

    Args:
        entity_id: ha.entity record ID
        user_id: res.users record ID
        required_permission: 'view' or 'control'

    Returns:
        ha.entity.share record if access granted, False otherwise
    """
    share = request.env['ha.entity.share'].sudo().search([
        ('entity_id', '=', entity_id),
        ('user_id', '=', user_id),
        '|',
        ('expiry_date', '=', False),
        ('expiry_date', '>', fields.Datetime.now())
    ], limit=1)

    if not share:
        return False

    if required_permission == 'control' and share.permission != 'control':
        return False

    return share

def _check_group_share_access(self, group_id, user_id, required_permission='view'):
    # 類似邏輯，檢查 group_id
    ...
```

### Controller 修改

```python
@http.route('/portal/entity/<int:entity_id>', type='http', auth='user', website=True)
def portal_entity(self, entity_id, **kw):
    user = request.env.user
    share = self._check_entity_share_access(entity_id, user.id)

    if not share:
        return request.render('odoo_ha_addon.portal_error_403', status=403)

    entity = request.env['ha.entity'].sudo().browse(entity_id)
    return request.render('odoo_ha_addon.portal_entity', {
        'entity': entity,
        'permission': share.permission,  # 傳遞權限給 template
        'page_name': 'portal_entity',
        'controllable_domains': list(PORTAL_CONTROL_SERVICES.keys()) if share.permission == 'control' else [],
    })
```

### 檔案變更

| 檔案 | 變更類型 |
|------|---------|
| `controllers/portal.py` | 修改 - auth 改為 user，權限檢查邏輯 |
| `views/portal_templates.xml` | 修改 - 移除 accessToken 參數 |
| `static/src/portal/portal_entity_info.js` | 修改 - 移除 token header |
| `static/src/portal/portal_entity_controller.js` | 修改 - 移除 token header |
| `static/src/portal/portal_group_info.js` | 修改 - 移除 token header |
| `tests/test_portal_controller.py` | 修改 - 更新測試使用 share 記錄 |

### Portal Template 修改

移除 `accessToken` 參數，新增 `permission` 參數：
```xml
<owl-component
    name="odoo_ha_addon.PortalEntityController"
    t-att-props="json.dumps({
        'entity': {...},
        'permission': permission,  <!-- 新增 -->
    })"/>
```

### OWL 組件修改

移除 X-Portal-Token header，改用 session cookie：
```javascript
// Before
headers: { 'X-Portal-Token': this.props.accessToken }

// After
// 不需要額外 header，Odoo session cookie 會自動帶入
```

## Dependencies

- [ ] Task 001 (Model & Security) 必須先完成

## Effort Estimate

- Size: L
- Hours: 12
- Parallel: false (依賴 Task 001)

## Definition of Done

- [ ] 所有 Portal 路由改為 `auth='user'`
- [ ] Token 驗證程式碼已移除
- [ ] Share 記錄權限檢查已實作
- [ ] 控制功能正確檢查 'control' 權限
- [ ] Portal templates 和 OWL 組件已更新
- [ ] 未登入用戶正確導向登入頁
- [ ] 無權限用戶看到 403 頁面
- [ ] 過期分享無法存取
- [ ] 整合測試全部通過
