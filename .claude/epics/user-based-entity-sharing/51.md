---
name: Notification System - Expiry Reminder
status: closed
created: 2026-01-16T16:32:09Z
updated: 2026-01-16T17:27:48Z
github: https://github.com/WOOWTECH/odoo-addons/issues/51
depends_on: [47]
parallel: true
conflicts_with: []
---

# Task: Notification System - Expiry Reminder

## Description

實作分享過期提醒機制，透過 Cron Job 每日檢查即將過期（7 天內）的分享記錄，並發送 Odoo 內部通知給分享建立者。

## Acceptance Criteria

- [ ] 建立 Cron Job `_cron_check_expiring_shares()` 每日執行
- [ ] 檢查 7 天內即將過期的分享記錄
- [ ] 發送 Odoo 內部通知 (mail.activity 或 bus notification)
- [ ] 通知內容包含：Entity/Group 名稱、被分享用戶、過期時間
- [ ] 標記已發送通知 (`notification_sent = True`)
- [ ] 避免重複發送通知
- [ ] (Optional) 建立 Cron Job 清理已過期超過 30 天的記錄
- [ ] 單元測試通過

## Technical Details

### Cron Job 實作

```python
class HAEntityShare(models.Model):
    _name = 'ha.entity.share'
    # ... existing fields ...

    @api.model
    def _cron_check_expiring_shares(self):
        """
        Cron Job: 檢查即將過期的分享並發送通知
        執行頻率：每日一次
        """
        # 找出 7 天內過期且尚未通知的分享
        now = fields.Datetime.now()
        expiry_threshold = now + timedelta(days=7)

        expiring_shares = self.search([
            ('expiry_date', '!=', False),
            ('expiry_date', '<=', expiry_threshold),
            ('expiry_date', '>', now),
            ('notification_sent', '=', False),
        ])

        for share in expiring_shares:
            self._send_expiry_notification(share)
            share.notification_sent = True

        _logger.info(f"Sent expiry notifications for {len(expiring_shares)} shares")
        return True

    def _send_expiry_notification(self, share):
        """發送過期提醒通知"""
        # 取得分享的 Entity 或 Group
        target = share.entity_id or share.group_id
        target_name = target.name or target.entity_id if share.entity_id else target.name
        target_type = 'Entity' if share.entity_id else 'Entity Group'

        # 找出分享建立者 (create_uid)
        creator = share.create_uid

        # 發送 Odoo 活動通知
        self.env['mail.activity'].create({
            'res_model_id': self.env['ir.model']._get(share.entity_id._name if share.entity_id else share.group_id._name).id,
            'res_id': target.id,
            'activity_type_id': self.env.ref('mail.mail_activity_data_todo').id,
            'summary': f'分享即將過期',
            'note': f'{target_type} "{target_name}" 分享給 {share.user_id.name} 將於 {share.expiry_date} 過期',
            'user_id': creator.id,
            'date_deadline': share.expiry_date.date(),
        })

    @api.model
    def _cron_cleanup_expired_shares(self):
        """
        Cron Job: 清理過期超過 30 天的分享記錄
        執行頻率：每週一次
        """
        cleanup_threshold = fields.Datetime.now() - timedelta(days=30)
        expired_shares = self.search([
            ('expiry_date', '!=', False),
            ('expiry_date', '<', cleanup_threshold),
        ])

        count = len(expired_shares)
        expired_shares.unlink()

        _logger.info(f"Cleaned up {count} expired share records")
        return True
```

### Cron Job XML 定義

```xml
<!-- data/cron.xml -->
<odoo>
    <!-- 每日檢查即將過期的分享 -->
    <record id="ir_cron_check_expiring_shares" model="ir.cron">
        <field name="name">Check Expiring Entity Shares</field>
        <field name="model_id" ref="model_ha_entity_share"/>
        <field name="state">code</field>
        <field name="code">model._cron_check_expiring_shares()</field>
        <field name="interval_number">1</field>
        <field name="interval_type">days</field>
        <field name="numbercall">-1</field>
        <field name="active">True</field>
    </record>

    <!-- 每週清理過期分享記錄 -->
    <record id="ir_cron_cleanup_expired_shares" model="ir.cron">
        <field name="name">Cleanup Expired Entity Shares</field>
        <field name="model_id" ref="model_ha_entity_share"/>
        <field name="state">code</field>
        <field name="code">model._cron_cleanup_expired_shares()</field>
        <field name="interval_number">7</field>
        <field name="interval_type">days</field>
        <field name="numbercall">-1</field>
        <field name="active">True</field>
    </record>
</odoo>
```

### 檔案變更

| 檔案 | 變更類型 |
|------|---------|
| `models/ha_entity_share.py` | 修改 - 新增 cron 方法 |
| `data/cron.xml` | 修改 - 新增 cron jobs |
| `__manifest__.py` | 確認 data/cron.xml 在 data 列表 |
| `tests/test_entity_share.py` | 修改 - 新增通知測試 |

## Dependencies

- [ ] Task 001 (Model & Security) 必須先完成

## Effort Estimate

- Size: S
- Hours: 4
- Parallel: true (與 Task 002, 003, 004 可平行)

## Definition of Done

- [ ] Cron Job 每日執行檢查過期分享
- [ ] 7 天內過期的分享會收到通知
- [ ] 通知發送給正確的用戶（分享建立者）
- [ ] 不會重複發送通知
- [ ] 清理 Cron Job 正確清理過期記錄
- [ ] 單元測試通過
